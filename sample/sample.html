<html>
<head>
</head>
<body style="margin:0">
<canvas id="canvas"></cavnas>

<!-- <script src="../src/main/bulletml.js"></script> -->
<!-- <script src="../src/main/bulletml.walker.js"></script> -->
<!-- <script src="../src/main/bulletml.dsl.js"></script> -->
<!-- <script src="../src/main/bulletml.runner.js"></script> -->

<script src="../target/bulletml.min.js"></script>

<script>
Array.prototype.remove = function(obj) {
    var idx = allObjects.indexOf(obj);
    if (idx !== -1) allObjects.splice(idx, 1);
};

var SCREEN_WIDTH = 200;
var SCREEN_HEIGHT = 250;
var SPEED = 1;

var score = 0;

var keyboard = null;

var canvas = null;
var context = null;
var allObjects = [];
var frame = 0;
var render = function() {
    context.fillStyle = "black";
    context.globalCompositeOperation = "source-over";
    context.globalAlpha = 0.7;
    context.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);

    context.globalCompositeOperation = "lighter";
    var copied = Array.apply(null, allObjects);
    for (var i = 0, end = copied.length; i < end; i++) {
        copied[i].update(frame);
        copied[i].draw(context);
    }

    context.fillStyle = "white";
    context.globalAlpha = 1;
    context.fillText(score, SCREEN_WIDTH*0.99, SCREEN_HEIGHT*0.01);

    frame += 1;
    requestAnimationFrame(render);
};

var enemies = [];

var Hex = function(w, h, radius, color) {
    this.w = w;
    this.h = h;
    this.radius = radius;
    this.x = 0;
    this.y = 0;
    this.rot = 0;
    this.color = color || "hsl(0, 60%, 60%)";

    this.canvas = document.createElement("canvas");
    this.canvas.width = w*2;
    this.canvas.height = h*2;
    var context = this.canvas.getContext("2d");
    context.globalCompositeOperation = "lighter";
    context.fillStyle = this.color;
    context.translate(w, h);
    context.globalAlpha = 1.0;
    fillHex(context, this.w, this.h);
    context.globalAlpha = 0.03;
    for (var i = 0; i < 10; i++) {
        var w = this.w * (1+i*0.1);
        var h = this.h * (1+i*0.1);
        fillHex(context, w, h);
        fillHex(context, w, h);
        fillHex(context, w, h);
    }
};
Hex.prototype.update = function() {};
Hex.prototype.draw = function(context) {
    context.fillStyle = this.color;
    context.save();
    context.translate(this.x, this.y);
    context.rotate(this.rot);
    context.drawImage(this.canvas, -this.canvas.width*.5, -this.canvas.height*.5);
    context.restore();
};
Hex.prototype.hit = function(another) {
    return (this.x - another.x)*(this.x - another.x) + (this.y - another.y)*(this.y - another.y) < (this.radius+another.radius)*(this.radius+another.radius);
};

var fillHex = function(context, w, h) {
    context.beginPath();
    context.moveTo(Math.sin(Math.PI/3 * 0)*w*.5, Math.cos(Math.PI/3 * 0)*h*.5);
    for (var i = 1; i < 6; i++) {
        context.lineTo(Math.sin(Math.PI/3 * i)*w*.5, Math.cos(Math.PI/3 * i)*h*.5);
    }
    context.closePath();
    context.fill();
};

var $ = bulletml.dsl;
var bml = new bulletml.Root({
    top: $.action([
        $.repeat(999, [
            $.repeat(30, [
                $.fire($.direction(12, "sequence"), $.speed(5), $.bullet($.actionRef("b"))),
                $.repeat(9-1, [
                    $.fire($.direction(360/9, "sequence"), $.speed(5), $.bullet($.actionRef("b"))),
                ]),
                $.wait(2),
            ]),
            $.wait(30),
            $.repeat(30, [
                $.fire($.direction(-12, "sequence"), $.speed(5), $.bullet($.actionRef("b"), {color:"hsl(220, 60%, 60%)"})),
                $.repeat(9-1, [
                    $.fire($.direction(360/9, "sequence"), $.speed(5), $.bullet($.actionRef("b"), {color:"hsl(220, 60%, 60%)"})),
                ]),
                $.wait(2),
            ]),
            $.wait(30),
        ]),
    ]),
    b: $.action([
        $.changeSpeed($.speed(1), 30),
        $.wait(30),
        $.changeDirection($.direction(0, "aim"), 60),
        $.changeSpeed($.speed(3), 30),
    ]),
});

window.onload = function() {
    keyboard = {
        up: false,
        down: false,
        left: false,
        right: false,
        c: false,
        z: false,
        x: false,
        space: false
    };
    keyboard.angles = {
           1: { x:Math.cos(Math.PI*.25 * 0), y:Math.sin(Math.PI*.25 * 0) },
          10: { x:Math.cos(Math.PI*.25 * 4), y:Math.sin(Math.PI*.25 * 4) },
         100: { x:Math.cos(Math.PI*.25 * 2), y:Math.sin(Math.PI*.25 * 2) },
         101: { x:Math.cos(Math.PI*.25 * 1), y:Math.sin(Math.PI*.25 * 1) },
         110: { x:Math.cos(Math.PI*.25 * 3), y:Math.sin(Math.PI*.25 * 3) },
        1000: { x:Math.cos(Math.PI*.25 * 6), y:Math.sin(Math.PI*.25 * 6) },
        1001: { x:Math.cos(Math.PI*.25 * 7), y:Math.sin(Math.PI*.25 * 7) },
        1010: { x:Math.cos(Math.PI*.25 * 5), y:Math.sin(Math.PI*.25 * 5) },
    };
    keyboard.angle = function() {
        return this.angles[this.up*1000+this.down*100+this.left*10+this.right];
    };
    document.addEventListener("keydown", function(e) {
        switch (e.keyCode) {
        case 18: keyboard.space = true; break;
        case 37: keyboard.left = true; break;
        case 38: keyboard.up = true; break;
        case 39: keyboard.right = true; break;
        case 40: keyboard.down = true; break;
        case 67: keyboard.c = true; break;
        case 88: keyboard.x = true; break;
        case 90: keyboard.z = true; break;
        }
    }, false);
    document.addEventListener("keyup", function(e) {
        switch (e.keyCode) {
        case 18: keyboard.space = false; break;
        case 37: keyboard.left = false; break;
        case 38: keyboard.up = false; break;
        case 39: keyboard.right = false; break;
        case 40: keyboard.down = false; break;
        case 67: keyboard.c = false; break;
        case 88: keyboard.x = false; break;
        case 90: keyboard.z = false; break;
        }
    }, false);

    canvas = document.getElementById("canvas");
    canvas.width = SCREEN_WIDTH;
    canvas.height = SCREEN_HEIGHT;
    var resize = function() {
        var rateWidth = canvas.width/window.innerWidth;
        var rateHeight= canvas.height/window.innerHeight;
        var rate = canvas.height/canvas.width;
        if (rateWidth > rateHeight) {
            canvas.style.width  = innerWidth+"px";
            canvas.style.height = innerWidth*rate+"px";
        } else {
            canvas.style.width  = innerHeight/rate+"px";
            canvas.style.height = innerHeight+"px";
        }
    };
    window.addEventListener("resize", resize, false);
    resize();

    context = canvas.getContext("2d");
    context.textAlign = "right";
    context.textBaseline = "top";

    var player = new Hex(10, 10, 5, "hsl(120, 60%, 60%)");
    player.x = SCREEN_WIDTH * 0.5;
    player.y = SCREEN_HEIGHT * 0.9;
    player.speed = 2;
    player.shot = function(x, y, theta) {
        var newShot = new Hex(3, 12, 2, "hsl(110, 60%, 60%)");
        newShot.x = this.x + x;
        newShot.y = this.y + y;
        newShot.bx = 0;
        newShot.by = 0;
        newShot.dx = Math.cos(theta)*5;
        newShot.dy = Math.sin(theta)*5;
        newShot.update = function() {
            this.bx = this.x;
            this.by = this.y;
            this.x += this.dx;
            this.y += this.dy;
            this.rot = Math.atan2(this.y-this.by, this.x-this.bx)+Math.PI*.5;
            if (this.x < 0 || SCREEN_WIDTH < this.x || this.y < 0 || SCREEN_HEIGHT < this.y) {
                allObjects.remove(this);
                return;
            }


        };
        allObjects.push(newShot);
    };
    player.update = function(frame) {
        var a = keyboard.angle();
        if (a) {
            this.x += a.x * this.speed;
            this.y += a.y * this.speed;
        }
        this.x = Math.max(0, Math.min(this.x, SCREEN_WIDTH));
        this.y = Math.max(0, Math.min(this.y, SCREEN_HEIGHT));
        if (keyboard.z && frame%5 === 0) {
            var t = frame/5;
            this.shot(-6, +4, Math.PI*1.5 + -0.2);
            this.shot(-4,  0, Math.PI*1.5 + -0.1);
            this.shot(-2, -4, Math.PI*1.5 +  0.0);
            this.shot(+2, -4, Math.PI*1.5 +  0.0);
            this.shot(+4,  0, Math.PI*1.5 + +0.1);
            this.shot(+6, +4, Math.PI*1.5 + +0.2);
        }
        this.speed = keyboard.c ? SPEED : SPEED*2;
    };
    allObjects.push(player);

    var createNewBullet = function(bullet, runner, spec) {
        var newBullet = new Hex(5, 10, 2, spec.color);
        newBullet.bx = 0;
        newBullet.by = 0;
        newBullet.update = function() {
            this.bx = this.x;
            this.by = this.y;

            runner.update();

            this.x = bullet.x;
            this.y = bullet.y;

            this.rot = Math.atan2(this.y-this.by, this.x-this.bx)+Math.PI*.5;

            if (this.x < 0 || SCREEN_WIDTH < this.x || this.y < 0 || SCREEN_HEIGHT < this.y) {
                allObjects.remove(this);
                return;
            }

            if (this.hit(player)) {
                console.log("hit!!");
                allObjects.remove(this);
                return;
            }
        };
        allObjects.push(newBullet);

        bullet.vanish = function() {
            allObjects.remove(newBullet);
        };
    };
    var config = {
        target: player,
        createNewBullet: createNewBullet
    };

    var enemy = new Hex(40, 30, 15, "hsl(270, 60%, 60%)");
    enemy.x = SCREEN_WIDTH * 0.5;
    enemy.y = SCREEN_HEIGHT * 0.1;
    allObjects.push(enemy);
    bml.startAttack(enemy, config, function(bullet, runner) {
        enemy.update = function() { runner.update(); };
    });

    render();
};
</script>
</body>
</html>