<html>
<head>
<script type="text/javascript" src="../lib/tmlib.js"></script>
<script type="text/javascript" src="../target/bulletml.for.tmlib.js"></script>
<script type="text/javascript">
var app;
tm.main(function() {
    // キャンバスアプリを作成
    app = tm.app.CanvasApp("#world");
    app.background = "rgb(0,0,32)";
    app.resize(320, 320);
    app.fitWindow();

    // 自機を作成
    var player = Player();
    // 敵を作成
    var enemy = Enemy();

    // 弾幕の攻撃対象を自機とする
    tm.bulletml.AttackPattern.defaultConfig.target = player;

    // 弾幕パターンをDSLで書くよ宣言
    var $ = bulletml.dsl;

    // 全周32way弾を30frame毎に発射。それを999回繰り返す
    var pattern = new bulletml.Root({
        top: $.action([
            $.repeat(999, [
                $.fire($.direction(0), $.bullet()),
                $.repeat(32-1, [
                    $.fire($.direction(360/32, "sequence"), $.bullet()),
                ]),
                $.wait(30),
            ]),
        ]),
    });

    // 敵に弾幕パターンをセット
    enemy.addEventListener("enterframe", pattern.createTicker());

    // アプリスタート
    app.run();
});

/** 自機 */
var Player = tm.createClass({
    superClass: tm.app.Shape,
    init: function() {
        this.superInit(84, 84);
        this.setPosition(320/2, 320-32);

        // ピヨ
        this.canvas.setColorStyle("white", "yellow").fillCircle(42, 42, 32);
        this.canvas.setColorStyle("white", "black").fillCircle(27, 27, 2);
        this.canvas.setColorStyle("white", "brown").fillRect(40, 70, 4, 15).fillTriangle(0, 40, 11, 35, 11, 45);

        this.scaleX = this.scaleY = 0.5;
        app.currentScene.addChild(this);
    },
    update: function(app) {
        // キーボード操作に対応
        var kb = app.keyboard;
        if (kb.getKey("left"))  this.x -= 4;
        if (kb.getKey("right")) this.x += 4;
        if (kb.getKey("up"))    this.y -= 4;
        if (kb.getKey("down"))  this.y += 4;
    },
});

/** 敵 */
var Enemy = tm.createClass({
    superClass: Player,
    init: function() {
        this.superInit();
        this.setPosition(320/2, 32);
        this.scaleX = -1;
        this.scaleY = 1;
    },
    update: function(app) {
        // 自転しながら左右に動く
        this.x = (320-32)/2 + Math.sin(app.frame*0.02)*120;
        this.rotation += 7;
    },
});
</script>
</head>
<body>
    <canvas id="world"></canvas>
</body>
</html>