<html>
<head>
<script type="text/javascript" src="../lib/tmlib.js"></script>
<script type="text/javascript" src="../target/bulletml.for.tmlib.js"></script>
<script type="text/javascript">
var app;
tm.main(function() {
    // キャンバスアプリを作成
    app = tm.app.CanvasApp("#world");
    app.background = "rgb(0,0,32)";
    app.resize(320, 320);
    app.fitWindow();

    // 自機を作成
    var player = Player();
    // 敵を作成
    var enemy = Enemy();
    // 生きてる弾の配列
    var bullets = [];

    // 弾幕パターンに関する設定 ここから ---
    var config = tm.bulletml.AttackPattern.defaultConfig;

    // 弾幕の攻撃対象を自機とする
    config.target = player;

    // 弾が生き残る範囲を設定する
    config.isInsideOfWorld = function(bullet) {
        return 0 < bullet.x && bullet.x < 320 && 0 < bullet.y && bullet.y < 320;
    };

    // 弾の発射時に呼び出される
    config.onFire = function(bullet) {
        bullets[bullets.length] = bullet;
        bullet.addEventListener("removed", function() {
            bullets.erase(this);
        });
    };
    // 弾幕パターンに関する設定 ここまで ---

    // 弾幕パターンをDSLで書くよ宣言
    var $ = bulletml.dsl;

    // 弾幕パターンDSL
    // 全周32way弾を30frame毎に発射。それを999回繰り返す
    var pattern = new bulletml.Root({
        top: $.action([
            $.repeat(999, [
                $.fire($.direction(0), $.bullet()),
                $.repeat(32-1, [
                    $.fire($.direction(360/32, "sequence"), $.bullet()),
                ]),
                $.wait(30),
            ]),
        ]),
    });

    // 敵に弾幕パターンをセット
    enemy.addEventListener("enterframe", pattern.createTicker());

    app.currentScene.update = function() {
        // 自機と弾の衝突判定
        for (var i = 0, len = bullets.length; i < len; i++) {
            if (bullets[i].isHitElement(player)) {
                // 爆発を表示
                explode(bullets[i].x, bullets[i].y);
                // 弾をどこか遠くへやる→このフレームで消える
                bullets[i].x = 9999;
            }
        }
    };

    // アプリスタート
    app.run();
});

/** 自機クラス */
var Player = tm.createClass({
    superClass: tm.app.Shape,
    init: function() {
        this.superInit(84, 84);
        this.setPosition(320/2, 320-32);

        // ピヨ
        this.canvas.setColorStyle("white", "yellow").fillCircle(42, 42, 32);
        this.canvas.setColorStyle("white", "black").fillCircle(27, 27, 2);
        this.canvas.setColorStyle("white", "brown").fillRect(40, 70, 4, 15).fillTriangle(0, 40, 11, 35, 11, 45);

        this.radius = 8;
        this.scaleX = this.scaleY = 0.5;
        app.currentScene.addChild(this);
    },
    update: function(app) {
        // キーボード操作に対応
        var kb = app.keyboard;
        if (kb.getKey("left"))  this.x -= 4;
        if (kb.getKey("right")) this.x += 4;
        if (kb.getKey("up"))    this.y -= 4;
        if (kb.getKey("down"))  this.y += 4;
    },
});

/** 敵クラス */
var Enemy = tm.createClass({
    superClass: Player,
    init: function() {
        this.superInit();
        this.setPosition(320/2, 32);
        this.scaleX = -1;
        this.scaleY = 1;
    },
    update: function(app) {
        // 自転しながら左右に動く
        this.x = (320-32)/2 + Math.sin(app.frame*0.02)*120;
        this.rotation += 7;
    },
});

/** 爆発を発生させる */
var explode = function(x, y) {
    for (var i = 0, cnt = tm.util.Random.randint(5, 10); i < cnt; i++) {
        Explosion(x, y);
    }
};
/** 爆発クラス */
var Explosion = tm.createClass({
    superClass: tm.app.StarShape,
    init: function(x, y) {
        this.superInit(64, 64, Explosion.initParam);
        this.setPosition(x, y);
        this.scaleX = this.scaleY = 0.1;
        this.alpha = 1;
        this.blendMode = "lighter";
        this.direction = Math.random() * Math.PI * 2;
        app.currentScene.addChild(this);
    },
    update: function() {
        this.x += Math.cos(this.direction) * 2;
        this.y += Math.sin(this.direction) * 2;
        this.scaleX += 0.05;
        this.scaleY += 0.05;
        this.alpha -= 0.05;
        this.rotation += 20;
        if (this.alpha < 0) {
            this.remove();
        }
    },
});
Explosion.initParam = {
    fillStyle: tm.graphics.RadialGradient(32, 32, 0, 32, 32, 32).addColorStopList([
        { offset: 0.0, color: "rgba(255, 255, 255, 0.0)"},
        { offset: 1.0, color: "rgba(255, 255, 255, 1.0)"},
    ]).toStyle(),
    strokeStyle: "rgba(0,0,0,0)",
    sides: 5,
};

</script>
</head>
<body>
    <canvas id="world"></canvas>
</body>
</html>