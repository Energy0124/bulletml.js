<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset=UTF-8>
</head>
<body>

<canvas id="app"></canvas>

<script src="../lib/tmlib.js"></script>
<script src="../build/bulletml.min.js"></script>
<script src="../build/plugins/tmlib.bulletml.js"></script>
<script>
bulletml.dsl();
var pattern = new bulletml.Root({
    top: action([
        repeat(999, [

            // 10way弾 ここから
            bindVar("way", 10), // way数
            bindVar("range", 100), // 扇の範囲
            bindVar("speed", 0.8), // 弾速
            fire(direction("$range * -0.5"), speed("$speed"), bullet()),
            repeat("$way - 1", [
                fire(direction("$range / ($way - 1)", "sequence"), speed(0, "sequence"), bullet())
            ]),
            // 10way弾 ここまで

            wait(40),

            // 9way弾 ここから
            bindVar("way", 9), // way数
            bindVar("range", 60), // 扇の範囲
            bindVar("speed", 1.1), // 弾速
            fire(direction("$range * -0.5"), speed("$speed"), bullet()),
            repeat("$way - 1", [
                fire(direction("$range / ($way - 1)", "sequence"), speed(0, "sequence"), bullet())
            ]),
            // 9way弾 ここまで

            wait(100)
        ])
    ])
});
</script>
<script>
tm.main(function() {
    var app = tm.display.CanvasApp("#app").resize(200, 250).fitWindow();
    app.replaceScene(tm.ui.LoadingScene({
        width: 200,
        height: 250,
        assets: {
            "hiyoko": "../lib/hiyoco_nomal_full.png",
            "waru": "../lib/hiyoco_waru_full.png"
        },
        nextScene: MainScene
    }));
    app.run();
});

tm.define("MainScene", {
    superClass: "tm.app.Scene",

    init: function() {
        this.superInit();

        this.fromJSON({
            children: {
                enemy: {
                    type: "tm.display.Sprite",
                    init: ["waru", 32, 32],
                    frameIndex: 3,
                    x: 100,
                    y: 50
                },
                player: {
                    type: "Player",
                    x: 100,
                    y: 200
                }
            }
        });

        var that = this;

        var config = {
            target: that.player,
            createNewBullet: function(runner) {
                tm.bulletml.Bullet(runner).addChildTo(that)
            }
        };

        this.enemy.startDanmaku(pattern, config);
    }
});

tm.define("Player", {
    superClass: "tm.display.Sprite",

    init: function() {
        this.superInit("hiyoko", 32, 32);
        this.frameIndex = 9;
        this.speed = 6;
    },

    update: function(app) {
        this.position.add(app.keyboard.getKeyDirection().mul(this.speed));
    }
});
</script>

</body>
</html>