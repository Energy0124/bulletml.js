/*
 bulletml.js v0.5.0-SNAPSHOT

 License
 http://daishihmr.mit-license.org/
*/
var bulletml={GLOBAL:this,_temp:function(){}};
(function(){function e(a,b){for(var c=0,f=a.length;c<f;c++)if(a[c].label==b)return a[c]}bulletml.Root=function(a){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[];if(void 0!==a){for(var b in a)a.hasOwnProperty(b)&&(a[b].label=b,a[b]instanceof bulletml.Action?this.actions.push(a[b]):a[b]instanceof bulletml.Bullet?this.bullets.push(a[b]):a[b]instanceof bulletml.Fire&&this.fires.push(a[b]));a=0;for(b=this.actions.length;a<b;a++)this.actions[a].setRoot(this);a=0;for(b=this.bullets.length;a<
b;a++)this.bullets[a].setRoot(this);a=0;for(b=this.fires.length;a<b;a++)this.fires[a].setRoot(this)}};bulletml.Root.prototype.findAction=function(a){return e(this.actions,a)};bulletml.Root.prototype.getTopActionLabels=function(){for(var a=[],b=0,c=this.actions.length;b<c;b++){var f=this.actions[b];f.label&&0===f.label.indexOf("top")&&(a[a.length]=f.label)}return a};bulletml.Root.prototype.findActionOrThrow=function(a){var b;if(b=this.findAction(a))return b;throw Error("action labeled '"+a+"' is undefined.");
};bulletml.Root.prototype.findBullet=function(a){return e(this.bullets,a)};bulletml.Root.prototype.findBulletOrThrow=function(a){var b;if(b=this.findBullet(a))return b;throw Error("bullet labeled '"+a+"' is undefined.");};bulletml.Root.prototype.findFire=function(a){return e(this.fires,a)};bulletml.Root.prototype.findFireOrThrow=function(a){var b;if(b=this.findFire(a))return b;throw Error("fire labeled '"+a+"' is undefined.");};bulletml.Root.prototype.getWalker=function(a,b){var c=new bulletml.Walker(this,
b),f=this.findAction(a);if(f)return c._action=f,c};bulletml.Walker=function(a,b){this._root=a;this._stack=[];this._cursor=-1;this._action=null;this._localScope={};this._globalScope={$rank:b||0}};bulletml.Walker.prototype.next=function(){this._cursor+=1;if(null!==this._action){var a=this._action.commands[this._cursor];if(void 0!==a){if(a instanceof bulletml.Action)return this.pushStack(),this._action=a,this._localScope=this.cloneScope(),this.next();if(a instanceof bulletml.ActionRef)return this.pushStack(),
this._action=this._root.findActionOrThrow(a.label),this._localScope=this.newScope(a.params),this.next();if(a instanceof bulletml.Repeat)return this._localScope.loopCounter=0,this._localScope.loopEnd=this.evalParam(a.times),this.pushStack(),this._action=a.action.clone(),this._localScope=this.cloneScope(),this.next();if(a instanceof bulletml.Fire){var b=new bulletml.Fire;b.bullet=a.bullet.clone(this);null!==a.direction&&(b.direction=new bulletml.Direction(this.evalParam(a.direction.value)),b.direction.type=
a.direction.type);null!==a.speed&&(b.speed=new bulletml.Speed(this.evalParam(a.speed.value)),b.speed.type=a.speed.type);b.option=a.option;return b}return a instanceof bulletml.FireRef?(this.pushStack(),this._action=new bulletml.Action,this._action.commands=[this._root.findFireOrThrow(a.label)],this._localScope=this.newScope(a.params),this.next()):a instanceof bulletml.ChangeDirection?(b=new bulletml.ChangeDirection,b.direction.type=a.direction.type,b.direction.value=this.evalParam(a.direction.value),
b.term=this.evalParam(a.term),b):a instanceof bulletml.ChangeSpeed?(b=new bulletml.ChangeSpeed,b.speed.type=a.speed.type,b.speed.value=this.evalParam(a.speed.value),b.term=this.evalParam(a.term),b):a instanceof bulletml.Accel?(b=new bulletml.Accel,b.horizontal.type=a.horizontal.type,b.horizontal.value=this.evalParam(a.horizontal.value),b.vertical.type=a.vertical.type,b.vertical.value=this.evalParam(a.vertical.value),b.term=this.evalParam(a.term),b):a instanceof bulletml.Wait?new bulletml.Wait(this.evalParam(a.value)):
a instanceof bulletml.Bind?(this._localScope["$"+a.variable]=this.evalParam(a.expression),bulletml.DummyCommand):a instanceof bulletml.Notify?a:null}this.popStack();if(null===this._action)return null;if((a=this._action.commands[this._cursor])&&"repeat"==a.commandName)this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this.pushStack(),this._action=a.action.clone(),this._localScope=this.cloneScope());return this.next()}return null};bulletml.Walker.prototype.pushStack=
function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};bulletml.Walker.prototype.popStack=function(){var a=this._stack.pop();a?(this._cursor=a.cursor,this._action=a.action,this._localScope=a.scope):(this._cursor=-1,this._action=null,this._localScope={})};bulletml.Walker.prototype.evalParam=function(a){var b;if("number"===typeof a)return a;if(isNaN(b=Number(a))){if((b=this._localScope[a])||(b=this._globalScope[a]))return b;if("$rand"==a)return Math.random()}else return b;
b={};for(var c in this._globalScope)this._globalScope.hasOwnProperty(c)&&(b[c]=this._globalScope[c]);for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(b[c]=this._localScope[c]);b.$rand=Math.random();if(c=this._stack[this._stack.length-1])b.$loop={index:c.scope.loopCounter,count:c.scope.loopCounter+1,first:0===c.scope.loopCounter,last:c.scope.loopCounter===c.scope.loopEnd-1};return eval("bulletml._temp = function() { return "+a.split("$").join("this.$")+"}").bind(b)()};bulletml.Walker.prototype.newScope=
function(a){var b={};if(a)for(var c=0,f=a.length;c<f;c++)b["$"+(c+1)]=this.evalParam(a[c]);else for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(b[c]=this._localScope[c]);return b};bulletml.Walker.prototype.cloneScope=function(){var a={},b;for(b in this._localScope)this._localScope.hasOwnProperty(b)&&(a[b]=this._localScope[b]);return a};bulletml.Bullet=function(){this.root=this.label=null;this.direction=new bulletml.Direction(0);this.speed=new bulletml.Speed(1);this.actions=[];this.option=
{};this._localScope={}};bulletml.Bullet.prototype.getWalker=function(a){var a=new bulletml.Walker(this.root,a),b=new bulletml.Action;b.root=this.root;b.commands=this.actions;a._action=b;a._localScope=this._localScope;return a};bulletml.Bullet.prototype.clone=function(a){var b=new bulletml.Bullet;b.label=this.label;b.root=this.root;b.actions=this.actions;b.direction=new bulletml.Direction(a.evalParam(this.direction.value));b.direction.type=this.direction.type;b.speed=new bulletml.Speed(a.evalParam(this.speed.value));
b.speed.type=this.speed.type;b.option=this.option;b._localScope=a._localScope;return b};bulletml.Bullet.prototype.setRoot=function(a){this.root=a;for(var b=0,c=this.actions.length;b<c;b++)this.actions[b].setRoot(a)};bulletml.BulletRef=function(){this.label=this.root=null;this.params=[]};bulletml.BulletRef.prototype.clone=function(a){var b=a._localScope;a._localScope=a.newScope(this.params);var c=this.root.findBulletOrThrow(this.label).clone(a);a._localScope=b;return c};bulletml.BulletRef.prototype.setRoot=
function(a){this.root=a};bulletml.Command=function(){this.commandName=""};bulletml.Command.prototype.setRoot=function(a){this.root=a};bulletml.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[];this.params=[]};bulletml.Action.prototype=new bulletml.Command;bulletml.Action.prototype.setRoot=function(a){this.root=a;for(var b=0,c=this.commands.length;b<c;b++)this.commands[b].setRoot(a)};bulletml.Action.prototype.clone=function(){var a=new bulletml.Action;a.label=this.label;
a.root=this.root;a.commands=this.commands;return a};bulletml.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=[]};bulletml.ActionRef.prototype=new bulletml.Command;bulletml.ActionRef.prototype.clone=function(){var a=new bulletml.Action;a.root=this.root;a.commands.push(this);return a};bulletml.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=this.root=this.label=null;this.option=new bulletml.FireOption};bulletml.Fire.prototype=new bulletml.Command;
bulletml.Fire.prototype.setRoot=function(a){this.root=a;this.bullet&&this.bullet.setRoot(a)};bulletml.FireRef=function(){this.commandName="fireRef";this.label=null;this.params=[]};bulletml.FireRef.prototype=new bulletml.Command;bulletml.ChangeDirection=function(){this.commandName="changeDirection";this.direction=new bulletml.Direction;this.term=0};bulletml.ChangeDirection.prototype=new bulletml.Command;bulletml.ChangeSpeed=function(){this.commandName="changeSpeed";this.speed=new bulletml.Speed;this.term=
0};bulletml.ChangeSpeed.prototype=new bulletml.Command;bulletml.Accel=function(){this.commandName="accel";this.horizontal=new bulletml.Horizontal;this.vertical=new bulletml.Vertical;this.term=0};bulletml.Accel.prototype=new bulletml.Command;bulletml.Wait=function(a){this.commandName="wait";this.value=a||0};bulletml.Wait.prototype=new bulletml.Command;bulletml.Vanish=function(){this.commandName="vanish"};bulletml.Vanish.prototype=new bulletml.Command;bulletml.Repeat=function(){this.commandName="repeat";
this.times=0;this.action=null;this.params=[]};bulletml.Repeat.prototype=new bulletml.Command;bulletml.Repeat.prototype.setRoot=function(a){this.root=a;this.action&&this.action.setRoot(a)};bulletml.Bind=function(a,b){this.commandName="bind";this.variable=a;this.expression=b};bulletml.Bind.prototype=new bulletml.Command;bulletml.Notify=function(a,b){this.commandName="notify";this.eventName=a;this.params=b||null};bulletml.Notify.prototype=new bulletml.Command;bulletml.DummyCommand=new bulletml.Command;
bulletml.Direction=function(a){this.type="aim";this.value=a||0};bulletml.Speed=function(a){this.type="absolute";this.value=void 0===a?1:a};bulletml.Horizontal=function(a){this.type="absolute";this.value=a||0};bulletml.Vertical=function(a){this.type="absolute";this.value=a||0};bulletml.FireOption=function(a){a=a||{};this.offsetX=a.offsetX||0;this.offsetY=a.offsetY||0;this.autonomy=!0;void 0!==a.autonomy&&(this.autonomy=!!a.autonomy)};bulletml.OffsetX=function(a){this.value=a||0};bulletml.OffsetY=function(a){this.value=
a||0};bulletml.Autonomy=function(a){this.value=!!a}})();var BulletML=bulletml;(function(){function e(b){var d=new bulletml.Root;if(b=b.getElementsByTagName("bulletml")[0]){k(b,"type",function(a){d.type=a});var j=b.getElementsByTagName("action");if(j)for(var m=0,h=j.length;m<h;m++)if(j[m].parentNode===b){var e=a(d,j[m]);e&&(d.actions[d.actions.length]=e)}if(j=b.getElementsByTagName("bullet")){m=0;for(h=j.length;m<h;m++)j[m].parentNode===b&&(e=c(d,j[m]))&&(d.bullets[d.bullets.length]=e)}if(j=b.getElementsByTagName("fire")){m=0;for(h=j.length;m<h;m++)j[m].parentNode===b&&(e=f(d,
j[m]))&&(d.fires[d.fires.length]=e)}return d}}function a(c,e){var j=new bulletml.Action;k(e,"label",function(a){j.label=a});i(e,".",function(e){switch(e.tagName.toLowerCase()){case "action":j.commands[j.commands.length]=a(c,e);break;case "actionref":j.commands[j.commands.length]=b(c,e);break;case "fire":j.commands[j.commands.length]=f(c,e);break;case "fireref":var l=j.commands,n=j.commands.length,p=new bulletml.FireRef;k(e,"label",function(a){p.label=a});i(e,/param$/,function(a){p.params[p.params.length]=
d(a)});p.root=c;l[n]=p;break;case "changedirection":var l=j.commands,n=j.commands.length,s=new bulletml.ChangeDirection;s.root=c;g(e,"direction",function(a){s.direction=h(new bulletml.Direction,a)});g(e,"term",function(a){s.term=d(a)});l[n]=s;break;case "changespeed":var l=j.commands,n=j.commands.length,t=new bulletml.ChangeSpeed;t.root=c;g(e,"speed",function(a){t.speed=h(new bulletml.Speed,a)});g(e,"term",function(a){t.term=d(a)});l[n]=t;break;case "accel":var l=j.commands,n=j.commands.length,q=
new bulletml.Accel;q.root=c;g(e,"horizontal",function(a){q.horizontal=h(new bulletml.Horizontal,a)});g(e,"vertical",function(a){q.vertical=h(new bulletml.Vertical,a)});g(e,"term",function(a){q.term=d(a)});l[n]=q;break;case "wait":var l=j.commands,n=j.commands.length,u=new bulletml.Wait;u.root=c;u.value=d(e);l[n]=u;break;case "vanish":e=j.commands;l=j.commands.length;n=new bulletml.Vanish;n.root=c;e[l]=n;break;case "repeat":var l=j.commands,n=j.commands.length,r=new bulletml.Repeat;g(e,"action",function(b){r.action=
a(c,b)});g(e,"actionRef",function(a){r.action=b(c,a)});g(e,"times",function(a){r.times=d(a)});r.root=c;l[n]=r}});j.root=c;return j}function b(a,b){var c=new bulletml.ActionRef;k(b,"label",function(a){c.label=a});i(b,/param$/,function(a){c.params[c.params.length]=d(a)});c.root=a;return c}function c(c,f){var d=new bulletml.Bullet;k(f,"label",function(a){d.label=a});g(f,"direction",function(a){d.direction=h(new bulletml.Direction,a)});g(f,"speed",function(a){d.speed=h(new bulletml.Speed,a)});i(f,/(action)|(actionRef)$/,
function(f){"action"==f.tagName.toLowerCase()?d.actions[d.actions.length]=a(c,f):"actionref"==f.tagName.toLowerCase()&&(d.actions[d.actions.length]=b(c,f))});d.root=c;return d}function f(a,b){var f=new bulletml.Fire;k(b,"label",function(a){f.label=a});g(b,"direction",function(a){f.direction=h(new bulletml.Direction,a)});g(b,"speed",function(a){f.speed=h(new bulletml.Speed,a)});g(b,"bullet",function(b){f.bullet=c(a,b)});g(b,"bulletref",function(b){var c=new bulletml.BulletRef;k(b,"label",function(a){c.label=
a});i(b,/param$/,function(a){c.params[c.params.length]=d(a)});c.root=a;f.bullet=c});if(!f.bullet)throw Error("fire has no bullet or bulletRef.");f.root=a;return f}function h(a,b){k(b,"type",function(b){a.type=b});d(b,function(b){a.value=b});return a}function g(a,b,c,f){for(var b=b.toLowerCase(),a=a.childNodes,d=0,e=a.length;d<e;d++)if(a[d].tagName&&a[d].tagName.toLowerCase()==b)return c&&c(a[d]),a[d];f&&f();return null}function i(a,b,c){for(var a=a.childNodes,f=0,d=a.length;f<d;f++)a[f].tagName&&
a[f].tagName.toLowerCase().match(b)&&c(a[f])}function k(a,b,c,f){if(a=a.attributes[b])return c&&c(a.value),a;f&&f()}function d(a,b){var c=a.textContent.trim();if(void 0!==c||a.childNodes[0]&&(c=a.childNodes[0].nodeValue,void 0!==c))return b&&b(c),c}bulletml.build=function(a){if("string"===typeof a)var b=new DOMParser,a=e(b.parseFromString(a,"application/xml"));else if(a.getElementsByTagName("bulletml"))a=e(a);else throw Error("cannot build "+a);return a}})();(function(){bulletml.dsl=function(e){var e=e||"",a;for(a in bulletml.dsl)bulletml.dsl.hasOwnProperty(a)&&(bulletml.GLOBAL[e+a]=bulletml.dsl[a])};bulletml.dsl.action=function(e){if(0<arguments.length)for(var a=0,b=arguments.length;a<b;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(e instanceof Array){a=0;for(b=e.length;a<b;a++)e[a]instanceof Function&&(e[a]=e[a]())}var c=new bulletml.Action;if(e instanceof Array){if(e.some(function(a){return!(a instanceof bulletml.Command)}))throw Error("argument type error.");
c.commands=e}else{a=0;for(b=arguments.length;a<b;a++)if(arguments[a]instanceof bulletml.Command)c.commands[a]=arguments[a];else throw Error("argument type error.");}return c};bulletml.dsl.actionRef=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("label is required.");c=new bulletml.ActionRef;c.label=""+e;if(a instanceof Array)c.params=a;else for(b=1;b<arguments.length;b++)c.params.push(arguments[b]);return c};
bulletml.dsl.bullet=function(e,a,b,c){for(var f=0,h=arguments.length;f<h;f++)arguments[f]instanceof Function&&(arguments[f]=arguments[f]());h=new bulletml.Bullet;for(f=0;f<arguments.length;f++)arguments[f]instanceof bulletml.Direction?h.direction=arguments[f]:arguments[f]instanceof bulletml.Speed?h.speed=arguments[f]:arguments[f]instanceof bulletml.Action?h.actions.push(arguments[f]):arguments[f]instanceof bulletml.ActionRef?h.actions.push(arguments[f]):arguments[f]instanceof Array?h.actions.push(bulletml.dsl.action(arguments[f])):
arguments[f]instanceof Object?h.option=arguments[f]:"string"===typeof arguments[f]&&(h.label=arguments[f]);return h};bulletml.dsl.bulletRef=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("label is required.");c=new bulletml.BulletRef;c.label=""+e;if(a instanceof Array)c.params=a;else for(b=1;b<arguments.length;b++)c.params.push(arguments[b]);return c};bulletml.dsl.fire=function(e,a,b,c){for(var f=0,h=arguments.length;f<
h;f++)arguments[f]instanceof Function&&(arguments[f]=arguments[f]());h=new bulletml.Fire;for(f=0;f<arguments.length;f++)arguments[f]instanceof bulletml.Direction?h.direction=arguments[f]:arguments[f]instanceof bulletml.Speed?h.speed=arguments[f]:arguments[f]instanceof bulletml.Bullet?h.bullet=arguments[f]:arguments[f]instanceof bulletml.BulletRef?h.bullet=arguments[f]:arguments[f]instanceof bulletml.FireOption?h.option=arguments[f]:arguments[f]instanceof bulletml.OffsetX?h.option.offsetX=arguments[f].value:
arguments[f]instanceof bulletml.OffsetY?h.option.offsetY=arguments[f].value:arguments[f]instanceof bulletml.Autonomy&&(h.option.autonomy=arguments[f].value);if(void 0===h.bullet)throw Error("bullet (or bulletRef) is required.");return h};bulletml.dsl.fireRef=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("label is required.");c=new bulletml.FireRef;c.label=""+e;if(a instanceof Array)c.params=a;else for(b=
1;b<arguments.length;b++)c.params.push(arguments[b]);return c};bulletml.dsl.changeDirection=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("direction is required.");if(void 0===a)throw Error("term is required.");b=new bulletml.ChangeDirection;b.direction=e instanceof bulletml.Direction?e:new bulletml.Direction(e);b.term=a;return b};bulletml.dsl.changeSpeed=function(e,a){for(var b=0,c=arguments.length;b<
c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("speed is required.");if(void 0===a)throw Error("term is required.");b=new bulletml.ChangeSpeed;b.speed=e instanceof bulletml.Speed?e:new bulletml.Speed(e);b.term=a;return b};bulletml.dsl.accel=function(e,a,b){for(var c=0,f=arguments.length;c<f;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());f=new bulletml.Accel;for(c=0;c<arguments.length;c++)arguments[c]instanceof bulletml.Horizontal?
f.horizontal=e:arguments[c]instanceof bulletml.Vertical?f.vertical=a:f.term=arguments[c];if(void 0===f.horizontal&&void 0===f.vertical)throw Error("horizontal or vertical is required.");if(void 0===f.term)throw Error("term is required.");return f};bulletml.dsl.wait=function(e){for(var a=0,b=arguments.length;a<b;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===e)throw Error("value is required.");return new bulletml.Wait(e)};bulletml.dsl.vanish=function(){return new bulletml.Vanish};
bulletml.dsl.repeat=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("times is required.");if(void 0===a)throw Error("action is required.");c=new bulletml.Repeat;c.times=e;if(a instanceof bulletml.Action||a instanceof bulletml.ActionRef)c.action=a;else if(a instanceof Array)c.action=bulletml.dsl.action(a);else{for(var f=[],b=1;b<arguments.length;b++)f.push(arguments[b]);c.action=bulletml.dsl.action(f)}return c};
bulletml.dsl.bindVar=function(e,a){return new bulletml.Bind(e,a)};bulletml.dsl.notify=function(e,a){return new bulletml.Notify(e,a)};bulletml.dsl.direction=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("value is required.");b=new bulletml.Direction(e);void 0!==a&&(b.type=a);return b};bulletml.dsl.speed=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());
if(void 0===e)throw Error("value is required.");b=new bulletml.Speed(e);a&&(b.type=a);return b};bulletml.dsl.horizontal=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("value is required.");b=new bulletml.Horizontal(e);a&&(b.type=a);return b};bulletml.dsl.vertical=function(e,a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===e)throw Error("value is required.");
b=new bulletml.Vertical(e);a&&(b.type=a);return b};bulletml.dsl.fireOption=function(e){return new bulletml.FireOption(e)};bulletml.dsl.offsetX=function(e){return new bulletml.OffsetX(e)};bulletml.dsl.offsetY=function(e){return new bulletml.OffsetY(e)};bulletml.dsl.autonomy=function(e){return new bulletml.Autonomy(e)}})();tm.bulletml=tm.bulletml||{};
(function(){function e(a){for(;a<=-Math.PI;)a+=2*Math.PI;for(;Math.PI<a;)a-=2*Math.PI;return a}function a(a,b){return Math.atan2(b.y-a.y,b.x-a.x)}tm.bulletml.AttackPattern=tm.createClass({init:function(a){if(!a)throw Error("argument is invalid.",a);this._bulletml=a},createTicker:function(a,b){var e=this._bulletml.getTopActionLabels();if(void 0===b&&0<e.length){for(var g=[],i=0,k=e.length;i<k;i++)g[g.length]=this._createTicker(a,e[i]);for(var d=function(){for(var a=g.length;a--;)g[a].call(this);d.compChildCount==
g.length&&(d.completed=!0,this.dispatchEvent(tm.event.Event("completeattack")))},i=g.length;i--;)g[i].parentTicker=d;d.compChildCount=0;d.completeChild=function(){this.compChildCount++};d.compChildCount=0;d.completed=!1;d.isDanmaku=!0;return d}return this._createTicker(a,b)},_createTicker:function(a,b){var e=a,g={},i=tm.bulletml.AttackPattern.defaultConfig,k;for(k in i)i.hasOwnProperty(k)&&(g[k]=i[k]);for(k in e)e.hasOwnProperty(k)&&(g[k]=e[k]);a=g;if(!a.target)throw Error("target is undefined in config.");
var d=function(){d.age+=1;this.age=d.age;var a=d.config,b=d._pattern;if(b)if(d.age<d.chDirEnd?d.direction+=d.dirIncr:d.age===d.chDirEnd&&(d.direction=d.dirFin),d.age<d.chSpdEnd?d.speed+=d.spdIncr:d.age===d.chSpdEnd&&(d.speed=d.spdFin),d.age<d.aclEnd?(d.speedH+=d.aclIncrH,d.speedV+=d.aclIncrV):d.age===d.aclEnd&&(d.speedH=d.aclFinH,d.speedV=d.aclFinV),this.x+=Math.cos(d.direction)*d.speed*a.speedRate,this.y+=Math.sin(d.direction)*d.speed*a.speedRate,this.x+=d.speedH*a.speedRate,this.y+=d.speedV*a.speedRate,
a.isInsideOfWorld(this)){if(a.updateProperties||this.updateProperties)this.rotation=(d.direction+0.5*Math.PI)*Math.RAD_TO_DEG,this.speed=d.speed;if(!(d.age<d.waitTo||d.completed)){for(var c;c=d.walker.next();)switch(c.commandName){case "fire":b._fire.call(this,c,a,d,b);break;case "wait":a=0;d.waitTo="number"===typeof c.value?d.age+c.value:0!==(a=~~c.value)?d.age+a:d.age+eval(c.value);return;case "changeDirection":b._changeDirection.call(this,c,a,d);break;case "changeSpeed":b._changeSpeed.call(this,
c,d);break;case "accel":b._accel.call(this,c,d);break;case "vanish":this.remove();this.dispatchEvent(tm.event.Event("removed"));break;case "notify":b._notify.call(this,c)}d.completed=!0;d.parentTicker?d.parentTicker.completeChild():this.dispatchEvent(tm.event.Event("completeattack"))}}else this.remove(),d.completed=!0,d.parentTicker?d.parentTicker.completeChild():this.dispatchEvent(tm.event.Event("completeattack"))},b=b||"top";if("string"===typeof b)d.walker=this._bulletml.getWalker(b,a.rank);else if(b instanceof
bulletml.Bullet)d.walker=b.getWalker(a.rank);else throw window.console.error(a,b),Error("\u5f15\u6570\u304c\u4e0d\u6b63");d._pattern=this;d.config=a;d.waitTo=-1;d.completed=!1;d.direction=0;d.lastDirection=0;d.speed=0;d.lastSpeed=0;d.speedH=0;d.speedV=0;d.dirIncr=0;d.dirFin=0;d.chDirEnd=-1;d.spdIncr=0;d.spdFin=0;d.chSpdEnd=-1;d.aclIncrH=0;d.aclFinH=0;d.aclIncrV=0;d.aclFinV=0;d.aclEnd=-1;d.age=-1;d.isDanmaku=!0;return d},_createSimpleTicker:function(a){var b={},e=tm.bulletml.AttackPattern.defaultConfig,
g;for(g in e)e.hasOwnProperty(g)&&(b[g]=e[g]);for(g in a)a.hasOwnProperty(g)&&(b[g]=a[g]);a=b;if(!a.target)throw Error("target is undefined in config.");var i=function(){this.x+=i.deltaX;this.y+=i.deltaY;i.config.isInsideOfWorld(this)||this.remove()};i.config=a;i.direction=0;i.speed=0;i.deltaX=0;i.deltaY=0;i.isDanmaku=!0;return i},_fire:function(b,f,e,g){var i={label:b.bullet.label},k;for(k in b.bullet.option)i[k]=b.bullet.option[k];if(i=f.bulletFactory(i)){var d=(k=b.bullet.actions.length)?g.createTicker(f,
b.bullet):g._createSimpleTicker(f),v=this,l={x:this.x+b.option.offsetX,y:this.y+b.option.offsetY};e.lastDirection=d.direction=function(d){var g=eval(d.value)*Math.DEG_TO_RAD;switch(d.type){case "aim":return f.target?b.option.autonomy?a(l,f.target)+g:a(v,f.target)+g:g-Math.PI/2;case "absolute":return g-Math.PI/2;case "relative":return e.direction+g;default:return e.lastDirection+g}}(b.direction||b.bullet.direction);e.lastSpeed=d.speed=function(a){var b=eval(a.value);switch(a.type){case "relative":return e.speed+
b;case "sequence":return e.lastSpeed+b;default:return b}}(b.speed||b.bullet.speed);i.x=l.x;i.y=l.y;k&&(d.deltaX=Math.cos(d.direction)*d.speed*f.speedRate,d.deltaY=Math.sin(d.direction)*d.speed*f.speedRate);i.updateProperties=!!i.updateProperties;if(f.updateProperties||i.updateProperties)i.rotation=(d.direction+0.5*Math.PI)*Math.RAD_TO_DEG,i.speed=d.speed;i.addEventListener("enterframe",d);i.addEventListener("removed",function(){this.removeEventListener("enterframe",d);this.removeEventListener("removed",
arguments.callee)});f.addTarget?f.addTarget.addChild(i):this.parent&&this.parent.addChild(i)}},_changeDirection:function(b,f,h){var g=eval(b.direction.value)*Math.DEG_TO_RAD,i=eval(b.term);switch(b.direction.type){case "aim":b=f.target;if(!b)return;h.dirFin=a(this,b)+g;h.dirIncr=e(h.dirFin-h.direction)/i;break;case "absolute":h.dirFin=g-Math.PI/2;h.dirIncr=e(h.dirFin-h.direction)/i;break;case "relative":h.dirFin=h.direction+g;h.dirIncr=e(h.dirFin-h.direction)/i;break;case "sequence":h.dirIncr=g,h.dirFin=
h.direction+h.dirIncr*(i-1)}h.chDirEnd=h.age+i},_changeSpeed:function(a,b){var e=eval(a.speed.value),g=eval(a.term);switch(a.speed.type){case "absolute":b.spdFin=e;b.spdIncr=(b.spdFin-b.speed)/g;break;case "relative":b.spdFin=e+b.speed;b.spdIncr=(b.spdFin-b.speed)/g;break;case "sequence":b.spdIncr=e,b.spdFin=b.speed+b.spdIncr*g}b.chSpdEnd=b.age+g},_accel:function(a,b){var e=eval(a.term);b.aclEnd=b.age+e;if(a.horizontal){var g=eval(a.horizontal.value);switch(a.horizontal.type){case "absolute":case "sequence":b.aclIncrH=
(g-b.speedH)/e;b.aclFinH=g;break;case "relative":b.aclIncrH=g,b.aclFinH=(g-b.speedH)*e}}else b.aclIncrH=0,b.aclFinH=b.speedH;if(a.vertical)switch(g=eval(a.vertical.value),a.vertical.type){case "absolute":case "sequence":b.aclIncrV=(g-b.speedV)/e;b.aclFinV=g;break;case "relative":b.aclIncrV=g,b.aclFinV=(g-b.speedV)*e}else b.aclIncrV=0,b.aclFinV=b.speedV},_notify:function(a){var b=tm.event.Event(a.eventName);if(a.params)for(var e in a.params)b[e]=a.params[e];this.dispatchEvent(b)}});var b=tm.graphics.Canvas();
b.resize(8,8);b.setTransformCenter();b.setLineStyle(0).setStrokeStyle("rgba(0,0,0,0)");b.setFillStyle(tm.graphics.RadialGradient(0,0,0,0,0,4).addColorStopList([{offset:0,color:"white"},{offset:0.5,color:"white"},{offset:1,color:"red"}]).toStyle()).fillCircle(0,0,4);tm.bulletml.defaultBulletFactory=function(a){var e=tm.app.Sprite(8,8,b);e.label=a.label;return e};tm.bulletml.defaultIsInsideOfWorld=function(){return!0};tm.bulletml.AttackPattern.defaultConfig={bulletFactory:tm.bulletml.defaultBulletFactory,
isInsideOfWorld:tm.bulletml.defaultIsInsideOfWorld,rank:0,updateProperties:!1,speedRate:2,target:null}})();
