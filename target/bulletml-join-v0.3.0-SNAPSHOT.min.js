var BulletML={};
(function(){function j(a){var b=new BulletML.Root,g=a.getElementsByTagName("bulletml")[0];i(g,"type",function(a){b.type=a});var m=g.getElementsByTagName("action");if(m)for(var a=0,e=m.length;a<e;a++){var d=n(b,m[a]);d&&(b.actions[b.actions.length]=d)}if(m=g.getElementsByTagName("bullet")){a=0;for(e=m.length;a<e;a++)(d=c(b,m[a]))&&(b.bullets[b.bullets.length]=d)}if(g=g.getElementsByTagName("fire")){a=0;for(e=g.length;a<e;a++)(m=f(b,g[a]))&&(b.fires[b.fires.length]=m)}return b}function n(a,h){var g=
new BulletML.Action;i(h,"label",function(a){g.label=a});k(h,".",function(h){switch(h.tagName){case "action":g.commands[g.commands.length]=n(a,h);break;case "actionRef":g.commands[g.commands.length]=p(a,h);break;case "fire":g.commands[g.commands.length]=f(a,h);break;case "fireRef":var c=g.commands,d=g.commands.length,j=new BulletML.FireRef;i(h,"label",function(a){j.label=a});k(h,/param$/,function(a){j.params[j.params.length]=l(a)});j.root=a;c[d]=j;break;case "changeDirection":var c=g.commands,d=g.commands.length,
s=new BulletML.ChangeDirection;s.root=a;b(h,"direction",function(a){s.direction=e(new BulletML.Direction,a)});b(h,"term",function(a){s.term=l(a)});c[d]=s;break;case "changeSpeed":var c=g.commands,d=g.commands.length,t=new BulletML.ChangeSpeed;t.root=a;b(h,"speed",function(a){t.speed=e(new BulletML.Speed,a)});b(h,"term",function(a){t.term=l(a)});c[d]=t;break;case "accel":var c=g.commands,d=g.commands.length,q=new BulletML.Accel;q.root=a;b(h,"horizontal",function(a){q.horizontal=e(new BulletML.Horizontal,
a)});b(h,"vertical",function(a){q.vertical=e(new BulletML.Vertical,a)});b(h,"term",function(a){q.term=l(a)});c[d]=q;break;case "wait":var c=g.commands,d=g.commands.length,u=new BulletML.Wait;u.root=a;u.value=l(h);c[d]=u;break;case "vanish":h=g.commands;c=g.commands.length;d=new BulletML.Vanish;d.root=a;h[c]=d;break;case "repeat":var c=g.commands,d=g.commands.length,r=new BulletML.Repeat;b(h,"action",function(b){r.action=n(a,b)});b(h,"actionRef",function(b){r.action=p(a,b)});b(h,"times",function(a){r.times=
l(a)});r.root=a;c[d]=r}});g.root=a;return g}function p(a,b){var g=new BulletML.ActionRef;i(b,"label",function(a){g.label=a});k(b,/param$/,function(a){g.params[g.params.length]=l(a)});g.root=a;return g}function c(a,h){var g=new BulletML.Bullet;i(h,"label",function(a){g.label=a});b(h,"direction",function(a){g.direction=e(new BulletML.Direction,a)});b(h,"speed",function(a){g.speed=e(new BulletML.Speed,a)});k(h,/(action)|(actionRef)$/,function(b){"action"==b.tagName?g.actions[g.actions.length]=n(a,b):
"actionRef"==b.tagName&&(g.actions[g.actions.length]=p(a,b))});g.root=a;return g}function f(a,h){var g=new BulletML.Fire;i(h,"label",function(a){g.label=a});b(h,"direction",function(a){g.direction=e(new BulletML.Direction,a)});b(h,"speed",function(a){g.speed=e(new BulletML.Speed,a)});b(h,"bullet",function(b){g.bullet=c(a,b)});b(h,"bulletRef",function(b){var h=new BulletML.BulletRef;i(b,"label",function(a){h.label=a});k(b,/param$/,function(a){h.params[h.params.length]=l(a)});h.root=a;g.bullet=h});
if(!g.bullet)throw Error("fire has no bullet or bulletRef.");g.root=a;return g}function e(a,b){i(b,"type",function(b){a.type=b});l(b,function(b){a.value=b});return a}function d(a,b){for(var g=0,c=a.length;g<c;g++)if(a[g].label==b)return a[g]}function b(a,b,g,c){for(var a=a.childNodes,d=0,e=a.length;d<e;d++)if(a[d].tagName&&a[d].tagName==b)return g&&g(a[d]),g(a[d]);c&&c()}function k(a,b,c){for(var a=a.childNodes,d=0,e=a.length;d<e;d++)a[d].tagName&&a[d].tagName.match(b)&&c(a[d])}function i(a,b,c,d){if(a=
a.attributes[b])return c&&c(a.value),a;d&&d()}function l(a,b){var c=a.textContent;if(void 0!==c||a.childNodes[0]&&(c=a.childNodes[0].nodeValue,void 0!==c))return b&&b(c),c}BulletML.build=function(a){if("string"==typeof a)var b=new DOMParser,a=j(b.parseFromString(a,"application/xml"));else if(a.getElementsByTagName("bulletml"))a=j(a);else throw Error("cannot build "+a);a.topAction=d(a.actions,"top");return a};BulletML.Root=function(){this.type="none";this.root=this;this.topAction=null;this.actions=
[];this.bullets=[];this.fires=[]};BulletML.Root.prototype.findAction=function(a){return d(this.actions,a)};BulletML.Root.prototype.findBullet=function(a){return d(this.bullets,a)};BulletML.Root.prototype.findFire=function(a){return d(this.fires,a)};BulletML.Root.prototype.getWalker=function(a,b){var c=new BulletML.Walker(this,b),d=this.findAction(a);if(d)return c._action=d,c};BulletML.Walker=function(a,b){this._root=a;this._stack=[];this._localScopeStack=[];this._cursor=-1;this._action=null;this._localScope=
{};this._globalScope={$rank:b}};BulletML.Walker.prototype.next=function(){this._cursor+=1;if(this._action){var a=this._action.commands[this._cursor];if(a){var b={commandName:a.commandName};switch(a.commandName){case "action":return this.pushStack(),this._action=a,this.next();case "actionRef":return this._localScopeStack.push(this._localScope),this._localScope=this.newScope(a.params),this.pushStack(),this._action=this._root.findAction(a.label,this._localScope,this._globalScope),this.next();case "repeat":return a.counter=
0,a.end=this.eval(a.times,this._localScope,this._globalScope),this.pushStack(),this._action=a.action,this.next();case "fire":b.bullet=a.bullet.clone(this);a.direction&&(b.direction={type:a.direction.type,value:this.eval(a.direction.value)});a.speed&&(b.speed={type:a.speed.type,value:this.eval(a.speed.value)});break;case "changeDirection":a.direction&&(b.direction={type:a.direction.type,value:this.eval(a.direction.value)});a.term&&(b.term=this.eval(a.term));break;case "changeSpeed":a.speed&&(b.speed=
{type:a.speed.type,value:this.eval(a.speed.value)});a.term&&(b.term=this.eval(a.term));break;case "accel":a.horizontal&&(b.horizontal={type:a.horizontal.type,value:this.eval(a.horizontal.value)});a.vertical&&(b.vertical={type:a.vertical.type,value:this.eval(a.vertical.value)});a.term&&(b.term=this.eval(a.term));break;case "wait":b.value=this.eval(a.value)}return b}this.popStack();if(this._action)return(a=this._action.commands[this._cursor])&&"actionRef"==a.commandName?this._localScope=this._localScopeStack.pop():
a&&"repeat"==a.commandName&&(a.counter++,a.counter<a.end&&(this.pushStack(),this._action=a.action)),this.next()}};BulletML.Walker.prototype.pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor});this._cursor=-1};BulletML.Walker.prototype.popStack=function(){var a=this._stack.pop();a?(this._cursor=a.cursor,this._action=a.action):(this._cursor=-1,this._action=null)};BulletML.Walker.prototype.eval=function(a){var b;if("number"==typeof a)return a;if(isNaN(b=Number(a))){if((b=
this._localScope[a])||(b=this._globalScope[a]))return b;if("$rand"==a)return Math.random()}else return b;b={};for(var c in this._globalScope)this._globalScope.hasOwnProperty(c)&&(b[c]=this._globalScope[c]);for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(b[c]=this._localScope[c]);b.$rand=Math.random();return eval("BulletML._temp = function() { return "+a.split("$").join("this.$")+"}").bind(b)()};BulletML.Walker.prototype.newScope=function(a){for(var b={},c=0,d=a.length;c<d;c++)b["$"+
(c+1)]=this.eval(a[c]);return b};BulletML.Bullet=function(){this.root=this.label=null;this.direction=new BulletML.Direction(0);this.speed=new BulletML.Speed(1);this.actions=[];this._localScope={}};BulletML.Bullet.prototype.getWalker=function(a){var a=new BulletML.Walker(this.root,a),b=new BulletML.Action;b.root=this.root;b.commands=this.actions;a._action=b;a._localScope=this._localScope;return a};BulletML.Bullet.prototype.clone=function(a){var b=new BulletML.Bullet;b.label=this.label;b.root=this.root;
b.actions=this.actions;b.direction={type:this.direction.type,value:a.eval(this.direction.value)};b.speed={type:this.speed.type,value:a.eval(this.speed.value)};b._localScope=a._localScope;return b};BulletML.BulletRef=function(){this.label=this.root=null;this.params=[]};BulletML.BulletRef.prototype.clone=function(a){var b=a._localScope;a._localScope=a.newScope(this.params);var c=this.root.findBullet(this.label).clone(a);a._localScope=b;return c};BulletML.Command=function(){this.commandName=null};BulletML.Action=
function(){this.commandName="action";this.root=this.label=null;this.commands=[]};BulletML.Action.prototype=new BulletML.Command;BulletML.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=[]};BulletML.ActionRef.prototype=new BulletML.Command;BulletML.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=this.root=this.label=null};BulletML.Fire.prototype=new BulletML.Command;BulletML.FireRef=function(){this.commandName="fireRef";this.label=
null;this.params=[]};BulletML.FireRef.prototype=new BulletML.Command;BulletML.ChangeDirection=function(){this.commandName="changeDirection";this.direction=null;this.term=0};BulletML.ChangeDirection.prototype=new BulletML.Command;BulletML.ChangeSpeed=function(){this.commandName="changeSpeed";this.speed=null;this.term=0};BulletML.ChangeSpeed.prototype=new BulletML.Command;BulletML.Accel=function(){this.commandName="accel";this.vertical=this.horizontal=null;this.term=0};BulletML.Accel.prototype=new BulletML.Command;
BulletML.Wait=function(a){this.commandName="wait";this.value=a?a:0};BulletML.Wait.prototype=new BulletML.Command;BulletML.Vanish=function(){this.commandName="vanish"};BulletML.Vanish.prototype=new BulletML.Command;BulletML.Repeat=function(){this.commandName="repeat";this.times=0;this.action=null};BulletML.Repeat.prototype=new BulletML.Command;BulletML.Direction=function(a){this.type="aim";this.value=a?a:0};BulletML.Speed=function(a){this.type="absolute";this.value=a?a:1};BulletML.Horizontal=function(a){this.type=
"absolute";this.value=a?a:0};BulletML.Vertical=function(a){this.type="absolute";this.value=a?a:0}})();(function(){function j(c){return c*Math.PI/180}function n(c){for(;c<=-Math.PI;)c+=2*Math.PI;for(;Math.PI<c;)c-=2*Math.PI;return c}function p(c,f){return Math.atan2(f.y+(f.height||0)/2-(c.y+(c.height||0)/2),f.x+(f.width||0)/2-(c.x+(c.width||0)/2))}enchant.Game._loadFuncs.bml=enchant.Game._loadFuncs.xml=function(c,f){var e=this,d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState){if(200!==d.status&&0!==d.status)throw Error(d.status+": Cannot load an asset: "+c);if(null!=d.responseXML)e.assets[c]=
BulletML.build(d.responseXML),f();else if(null!=d.responseText)e.assets[c]=BulletML.build(d.responseText),f();else throw Error(d.status+": Cannot load an asset: "+c);}};d.open("GET",c,!0);d.overrideMimeType&&d.overrideMimeType("application/xml");d.send(null)};enchant.bulletml={};enchant.bulletml.DEFAULT_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAa0lEQVQYV2NkgIL/DAw2QGYolLuakYHhCIgNpBkYgJITGWxs8hj8/CDymzYBpY9MAkrmM4J12tgcZlizhoFBXByi4OVLBoaQEJAiW5CCiQxdXXkMpaUw2yB0dzcDQ1nZJKIU4LeCoCMJeRMAewIxn7cIaLcAAAAASUVORK5CYII=";
enchant.bulletml.DEFAULT_BULLET_FACTORY=function(){var c=new enchant.Sprite(8,8);c.image=enchant.Surface.load(enchant.bulletml.DEFAULT_IMAGE);return c};enchant.bulletml.AttackPattern=enchant.Class.create({initialize:function(c){this._bulletml=c},_getConf:function(c){c instanceof enchant.Node&&(c={target:c});var f={bulletFactory:enchant.bulletml.DEFAULT_BULLET_FACTORY,testInWorld:function(c){var b=enchant.Game.instance.width,e=enchant.Game.instance.height,f=c.height||0;return-(c.width||0)<=c.x&&c.x<
b&&-f<=c.y&&c.y<e},rank:0,updateProperties:!1,speedRate:2};if(void 0!==c)for(var e in c)c.hasOwnProperty(e)&&(f[e]=c[e]);return f},createTicker:function(c,f){if(void 0===f&&!this._bulletml.findAction("top")){for(var e=[],d=1;this._bulletml.findAction("top"+d);d++)e[e.length]=this._createTicker(c,"top"+d);d=function(){for(var b=0,c=e.length;b<c;b++)e[b].call(this)};d.restart=function(){for(var b=0,c=e.length;b<c;b++)e[b].restart()};return d}return this._createTicker(c,f)},_createTicker:function(c,
f){var c=this._getConf(c),e;if(void 0===f)e=this._bulletml.sequence("top",c.rank);else if("string"===typeof f)e=this._bulletml.sequence(f,c.rank);else if(f instanceof BulletML.Bullet)e=f.sequence();else throw Error("\u5f15\u6570\u304c\u4e0d\u6b63",f);var d=this,b=function(){this.age<b.chDirEnd?b.direction+=b.dirIncr:this.age==b.chDirEnd&&(b.direction=b.dirFin);this.age<b.chSpdEnd?b.speed+=b.spdIncr:this.age==b.chSpdEnd&&(b.speed=b.spdFin);this.age<b.aclEnd?(b.speedH+=b.aclIncrH,b.speedV+=b.aclIncrV):
this.age==b.aclEnd&&(b.speedH=b.aclFinH,b.speedV=b.aclFinV);this.x+=Math.cos(b.direction)*b.speed*c.speedRate;this.y+=Math.sin(b.direction)*b.speed*c.speedRate;this.x+=b.speedH*c.speedRate;this.y+=b.speedV*c.speedRate;c.testInWorld(this)||this.parentNode.removeChild(this);c.updateProperties&&(this.direction=180*(b.direction+Math.PI/2)/Math.PI,this.speed=b.speed);if(!(this.age<b.waitTo||b.completed)){for(var f=e.length;b.cursor<f;b.cursor++){var i=e[b.cursor];switch(i.commandName){case "fire":d._fire.call(this,
i,c,b,d);break;case "wait":b.waitTo=this.age+eval(i.value);b.cursor+=1;return;case "loopEnd":i.loopCount=-1==i.loopCount?0:i.loopCount+1;if(i.loopCount<eval(i.times)-1)for(;0<b.cursor&&e[b.cursor]!=i.start;)b.cursor-=1;else i.loopCount=-1;break;case "changeDirection":d._changeDirection.call(this,i,c,b);break;case "changeSpeed":d._changeSpeed.call(this,i,b);break;case "accel":d._accel.call(this,i,b);break;case "vanish":this.parentNode&&this.parentNode.removeChild(this),b.cursor=f}}b.completed=!0;this.dispatchEvent(new Event("completeAttack"))}};
b.restart=function(){this.cursor=0;this.waitTo=-1;this.completed=!1;this.dirFin=this.dirIncr=this.speedV=this.speedH=this.lastSpeed=this.speed=this.lastDirection=this.direction=0;this.chDirEnd=-1;this.spdFin=this.spdIncr=0;this.chSpdEnd=-1;this.aclFinV=this.aclIncrV=this.aclFinH=this.aclIncrH=0;this.aclEnd=-1};b.restart();return b},_fire:function(c,f,e,d){var b=f.bulletFactory({label:c.bullet.label});if(b){var k=d.createTicker(f,c.bullet),i=this;k.direction=function(b){var a=j(eval(b.value));switch(b.type){case "aim":return f.target?
p(i,f.target)+a:a-Math.PI/2;case "absolute":return a-Math.PI/2;case "relative":return e.direction+a;case "sequence":return e.lastDirection+a}}(c.direction||c.bullet.direction);e.lastDirection=k.direction;k.speed=function(b){var a=eval(b.value);switch(b.type){case "relative":case "sequence":return e.lastSpeed+a;default:return a}}(c.speed||c.bullet.speed);e.lastSpeed=k.speed;b.x=this.x+((this.width||0)-(b.width||0))/2;b.y=this.y+((this.height||0)-(b.height||0))/2;b.addEventListener("enterframe",k);
b.addEventListener("removed",function(){this.removeEventListener("enterframe",k)});f.addTarget?f.addTarget.addChild(b):this.parentNode&&this.parentNode.addChild(b)}},_changeDirection:function(c,f,e){var d=eval(c.direction.value),b=eval(c.term);switch(c.direction.type){case "aim":c=f.target;if(!c)return;e.dirFin=p(this,c)+j(d);e.dirIncr=n(e.dirFin-e.direction)/b;break;case "absolute":e.dirFin=j(d)-Math.PI/2;e.dirIncr=n(e.dirFin-e.direction)/b;break;case "relative":e.dirFin=e.direction+j(d);e.dirIncr=
n(e.dirFin-e.direction)/b;break;case "sequence":e.dirIncr=j(d),e.dirFin=e.direction+e.dirIncr*b}e.chDirEnd=this.age+b},_changeSpeed:function(c,f){var e=eval(c.speed.value),d=eval(c.term);switch(c.speed.type){case "absolute":f.spdFin=e;f.spdIncr=(f.spdFin-f.speed)/d;break;case "relative":f.spdFin=e+f.speed;f.spdIncr=(f.spdFin-f.speed)/d;break;case "sequence":f.spdIncr=e,f.spdFin=f.speed+f.spdIncr*d}f.chSpdEnd=this.age+d},_accel:function(c,f){var e=eval(c.term);f.aclEnd=this.age+e;if(c.horizontal){var d=
eval(c.horizontal.value);switch(c.horizontal.type){case "absolute":case "sequence":f.aclIncrH=(d-f.speedH)/e;f.aclFinH=d;break;case "relative":f.aclIncrH=d,f.aclFinH=(d-f.speedH)*e}}else f.aclIncrH=0,f.aclFinH=f.speedH;if(c.vertical)switch(d=eval(c.vertical.value),c.vertical.type){case "absolute":case "sequence":f.aclIncrV=(d-f.speedV)/e;f.aclFinV=d;break;case "relative":f.aclIncrV=d,f.aclFinV=(d-f.speedV)*e}else f.aclIncrV=0,f.aclFinV=f.speedV},bulletml:{get:function(){return this._bulletml}}})})();
