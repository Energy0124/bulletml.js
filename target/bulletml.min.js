/*
 bulletml.js v0.5.0-SNAPSHOT

 License
 http://daishihmr.mit-license.org/
*/
var bulletml={GLOBAL:this,_temp:function(){}};
(function(){function c(a,b){for(var d=0,e=a.length;d<e;d++)if(a[d].label==b)return a[d]}bulletml.Root=function(a){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[];if(void 0!==a){for(var b in a)a.hasOwnProperty(b)&&(a[b].label=b,a[b]instanceof bulletml.Action?this.actions.push(a[b]):a[b]instanceof bulletml.Bullet?this.bullets.push(a[b]):a[b]instanceof bulletml.Fire&&this.fires.push(a[b]));a=0;for(b=this.actions.length;a<b;a++)this.actions[a].setRoot(this);a=0;for(b=this.bullets.length;a<
b;a++)this.bullets[a].setRoot(this);a=0;for(b=this.fires.length;a<b;a++)this.fires[a].setRoot(this)}};bulletml.Root.prototype.findAction=function(a){return c(this.actions,a)};bulletml.Root.prototype.getTopActionLabels=function(){for(var a=[],b=0,d=this.actions.length;b<d;b++){var e=this.actions[b];e.label&&0===e.label.indexOf("top")&&(a[a.length]=e.label)}return a};bulletml.Root.prototype.findActionOrThrow=function(a){var b;if(b=this.findAction(a))return b;throw Error("action labeled '"+a+"' is undefined.");
};bulletml.Root.prototype.findBullet=function(a){return c(this.bullets,a)};bulletml.Root.prototype.findBulletOrThrow=function(a){var b;if(b=this.findBullet(a))return b;throw Error("bullet labeled '"+a+"' is undefined.");};bulletml.Root.prototype.findFire=function(a){return c(this.fires,a)};bulletml.Root.prototype.findFireOrThrow=function(a){var b;if(b=this.findFire(a))return b;throw Error("fire labeled '"+a+"' is undefined.");};bulletml.Root.prototype.getWalker=function(a,b){var d=new bulletml.Walker(this,
b),e=this.findAction(a);if(e)return d._action=e,d};bulletml.Walker=function(a,b){this._root=a;this._stack=[];this._cursor=-1;this._action=null;this._localScope={};this._globalScope={$rank:b||0}};bulletml.Walker.prototype.next=function(){this._cursor+=1;if(null!==this._action){var a=this._action.commands[this._cursor];if(void 0!==a){if(a instanceof bulletml.Action)return this.pushStack(),this._action=a,this._localScope=this.cloneScope(),this.next();if(a instanceof bulletml.ActionRef)return this.pushStack(),
this._action=this._root.findActionOrThrow(a.label),this._localScope=this.newScope(a.params),this.next();if(a instanceof bulletml.Repeat)return this._localScope.loopCounter=0,this._localScope.loopEnd=this.evalParam(a.times),this.pushStack(),this._action=a.action.clone(),this._localScope=this.cloneScope(),this.next();if(a instanceof bulletml.Fire){var b=new bulletml.Fire;b.bullet=a.bullet.clone(this);null!==a.direction&&(b.direction=new bulletml.Direction(this.evalParam(a.direction.value)),b.direction.type=
a.direction.type);null!==a.speed&&(b.speed=new bulletml.Speed(this.evalParam(a.speed.value)),b.speed.type=a.speed.type);b.option=a.option;return b}return a instanceof bulletml.FireRef?(this.pushStack(),this._action=new bulletml.Action,this._action.commands=[this._root.findFireOrThrow(a.label)],this._localScope=this.newScope(a.params),this.next()):a instanceof bulletml.ChangeDirection?(b=new bulletml.ChangeDirection,b.direction.type=a.direction.type,b.direction.value=this.evalParam(a.direction.value),
b.term=this.evalParam(a.term),b):a instanceof bulletml.ChangeSpeed?(b=new bulletml.ChangeSpeed,b.speed.type=a.speed.type,b.speed.value=this.evalParam(a.speed.value),b.term=this.evalParam(a.term),b):a instanceof bulletml.Accel?(b=new bulletml.Accel,b.horizontal.type=a.horizontal.type,b.horizontal.value=this.evalParam(a.horizontal.value),b.vertical.type=a.vertical.type,b.vertical.value=this.evalParam(a.vertical.value),b.term=this.evalParam(a.term),b):a instanceof bulletml.Wait?new bulletml.Wait(this.evalParam(a.value)):
a instanceof bulletml.Bind?(this._localScope["$"+a.variable]=this.evalParam(a.expression),bulletml.DummyCommand):a instanceof bulletml.Notify?a:null}this.popStack();if(null===this._action)return null;if((a=this._action.commands[this._cursor])&&"repeat"==a.commandName)this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this.pushStack(),this._action=a.action.clone(),this._localScope=this.cloneScope());return this.next()}return null};bulletml.Walker.prototype.pushStack=
function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};bulletml.Walker.prototype.popStack=function(){var a=this._stack.pop();a?(this._cursor=a.cursor,this._action=a.action,this._localScope=a.scope):(this._cursor=-1,this._action=null,this._localScope={})};bulletml.Walker.prototype.evalParam=function(a){var b;if("number"===typeof a)return a;if(isNaN(b=Number(a))){if((b=this._localScope[a])||(b=this._globalScope[a]))return b;if("$rand"==a)return Math.random()}else return b;
b={};for(var d in this._globalScope)this._globalScope.hasOwnProperty(d)&&(b[d]=this._globalScope[d]);for(d in this._localScope)this._localScope.hasOwnProperty(d)&&(b[d]=this._localScope[d]);b.$rand=Math.random();if(d=this._stack[this._stack.length-1])b.$loop={index:d.scope.loopCounter,count:d.scope.loopCounter+1,first:0===d.scope.loopCounter,last:d.scope.loopCounter===d.scope.loopEnd-1};return eval("bulletml._temp = function() { return "+a.split("$").join("this.$")+"}").bind(b)()};bulletml.Walker.prototype.newScope=
function(a){var b={};if(a)for(var d=0,e=a.length;d<e;d++)b["$"+(d+1)]=this.evalParam(a[d]);else for(d in this._localScope)this._localScope.hasOwnProperty(d)&&(b[d]=this._localScope[d]);return b};bulletml.Walker.prototype.cloneScope=function(){var a={},b;for(b in this._localScope)this._localScope.hasOwnProperty(b)&&(a[b]=this._localScope[b]);return a};bulletml.Bullet=function(){this.root=this.label=null;this.direction=new bulletml.Direction(0);this.speed=new bulletml.Speed(1);this.actions=[];this.option=
{};this._localScope={}};bulletml.Bullet.prototype.getWalker=function(a){var a=new bulletml.Walker(this.root,a),b=new bulletml.Action;b.root=this.root;b.commands=this.actions;a._action=b;a._localScope=this._localScope;return a};bulletml.Bullet.prototype.clone=function(a){var b=new bulletml.Bullet;b.label=this.label;b.root=this.root;b.actions=this.actions;b.direction=new bulletml.Direction(a.evalParam(this.direction.value));b.direction.type=this.direction.type;b.speed=new bulletml.Speed(a.evalParam(this.speed.value));
b.speed.type=this.speed.type;b.option=this.option;b._localScope=a._localScope;return b};bulletml.Bullet.prototype.setRoot=function(a){this.root=a;for(var b=0,d=this.actions.length;b<d;b++)this.actions[b].setRoot(a)};bulletml.BulletRef=function(){this.label=this.root=null;this.params=[]};bulletml.BulletRef.prototype.clone=function(a){var b=a._localScope;a._localScope=a.newScope(this.params);var d=this.root.findBulletOrThrow(this.label).clone(a);a._localScope=b;return d};bulletml.BulletRef.prototype.setRoot=
function(a){this.root=a};bulletml.Command=function(){this.commandName=""};bulletml.Command.prototype.setRoot=function(a){this.root=a};bulletml.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[];this.params=[]};bulletml.Action.prototype=new bulletml.Command;bulletml.Action.prototype.setRoot=function(a){this.root=a;for(var b=0,d=this.commands.length;b<d;b++)this.commands[b].setRoot(a)};bulletml.Action.prototype.clone=function(){var a=new bulletml.Action;a.label=this.label;
a.root=this.root;a.commands=this.commands;return a};bulletml.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=[]};bulletml.ActionRef.prototype=new bulletml.Command;bulletml.ActionRef.prototype.clone=function(){var a=new bulletml.Action;a.root=this.root;a.commands.push(this);return a};bulletml.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=this.root=this.label=null;this.option=new bulletml.FireOption};bulletml.Fire.prototype=new bulletml.Command;
bulletml.Fire.prototype.setRoot=function(a){this.root=a;this.bullet&&this.bullet.setRoot(a)};bulletml.FireRef=function(){this.commandName="fireRef";this.label=null;this.params=[]};bulletml.FireRef.prototype=new bulletml.Command;bulletml.ChangeDirection=function(){this.commandName="changeDirection";this.direction=new bulletml.Direction;this.term=0};bulletml.ChangeDirection.prototype=new bulletml.Command;bulletml.ChangeSpeed=function(){this.commandName="changeSpeed";this.speed=new bulletml.Speed;this.term=
0};bulletml.ChangeSpeed.prototype=new bulletml.Command;bulletml.Accel=function(){this.commandName="accel";this.horizontal=new bulletml.Horizontal;this.vertical=new bulletml.Vertical;this.term=0};bulletml.Accel.prototype=new bulletml.Command;bulletml.Wait=function(a){this.commandName="wait";this.value=a||0};bulletml.Wait.prototype=new bulletml.Command;bulletml.Vanish=function(){this.commandName="vanish"};bulletml.Vanish.prototype=new bulletml.Command;bulletml.Repeat=function(){this.commandName="repeat";
this.times=0;this.action=null;this.params=[]};bulletml.Repeat.prototype=new bulletml.Command;bulletml.Repeat.prototype.setRoot=function(a){this.root=a;this.action&&this.action.setRoot(a)};bulletml.Bind=function(a,b){this.commandName="bind";this.variable=a;this.expression=b};bulletml.Bind.prototype=new bulletml.Command;bulletml.Notify=function(a,b){this.commandName="notify";this.eventName=a;this.params=b||null};bulletml.Notify.prototype=new bulletml.Command;bulletml.DummyCommand=new bulletml.Command;
bulletml.Direction=function(a){this.type="aim";this.value=a||0};bulletml.Speed=function(a){this.type="absolute";this.value=void 0===a?1:a};bulletml.Horizontal=function(a){this.type="absolute";this.value=a||0};bulletml.Vertical=function(a){this.type="absolute";this.value=a||0};bulletml.FireOption=function(a){a=a||{};this.offsetX=a.offsetX||0;this.offsetY=a.offsetY||0;this.autonomy=!0;void 0!==a.autonomy&&(this.autonomy=!!a.autonomy)};bulletml.OffsetX=function(a){this.value=a||0};bulletml.OffsetY=function(a){this.value=
a||0};bulletml.Autonomy=function(a){this.value=!!a}})();var BulletML=bulletml;(function(){function c(b){var c=new bulletml.Root;if(b=b.getElementsByTagName("bulletml")[0]){m(b,"type",function(a){c.type=a});var g=b.getElementsByTagName("action");if(g)for(var k=0,h=g.length;k<h;k++)if(g[k].parentNode===b){var f=a(c,g[k]);f&&(c.actions[c.actions.length]=f)}if(g=b.getElementsByTagName("bullet")){k=0;for(h=g.length;k<h;k++)g[k].parentNode===b&&(f=d(c,g[k]))&&(c.bullets[c.bullets.length]=f)}if(g=b.getElementsByTagName("fire")){k=0;for(h=g.length;k<h;k++)g[k].parentNode===b&&(f=e(c,
g[k]))&&(c.fires[c.fires.length]=f)}return c}}function a(d,c){var g=new bulletml.Action;m(c,"label",function(a){g.label=a});p(c,".",function(c){switch(c.tagName.toLowerCase()){case "action":g.commands[g.commands.length]=a(d,c);break;case "actionref":g.commands[g.commands.length]=b(d,c);break;case "fire":g.commands[g.commands.length]=e(d,c);break;case "fireref":var h=g.commands,j=g.commands.length,n=new bulletml.FireRef;m(c,"label",function(a){n.label=a});p(c,/param$/,function(a){n.params[n.params.length]=
l(a)});n.root=d;h[j]=n;break;case "changedirection":var h=g.commands,j=g.commands.length,s=new bulletml.ChangeDirection;s.root=d;i(c,"direction",function(a){s.direction=f(new bulletml.Direction,a)});i(c,"term",function(a){s.term=l(a)});h[j]=s;break;case "changespeed":var h=g.commands,j=g.commands.length,t=new bulletml.ChangeSpeed;t.root=d;i(c,"speed",function(a){t.speed=f(new bulletml.Speed,a)});i(c,"term",function(a){t.term=l(a)});h[j]=t;break;case "accel":var h=g.commands,j=g.commands.length,q=
new bulletml.Accel;q.root=d;i(c,"horizontal",function(a){q.horizontal=f(new bulletml.Horizontal,a)});i(c,"vertical",function(a){q.vertical=f(new bulletml.Vertical,a)});i(c,"term",function(a){q.term=l(a)});h[j]=q;break;case "wait":var h=g.commands,j=g.commands.length,u=new bulletml.Wait;u.root=d;u.value=l(c);h[j]=u;break;case "vanish":c=g.commands;h=g.commands.length;j=new bulletml.Vanish;j.root=d;c[h]=j;break;case "repeat":var h=g.commands,j=g.commands.length,r=new bulletml.Repeat;i(c,"action",function(b){r.action=
a(d,b)});i(c,"actionRef",function(a){r.action=b(d,a)});i(c,"times",function(a){r.times=l(a)});r.root=d;h[j]=r}});g.root=d;return g}function b(a,b){var d=new bulletml.ActionRef;m(b,"label",function(a){d.label=a});p(b,/param$/,function(a){d.params[d.params.length]=l(a)});d.root=a;return d}function d(d,c){var e=new bulletml.Bullet;m(c,"label",function(a){e.label=a});i(c,"direction",function(a){e.direction=f(new bulletml.Direction,a)});i(c,"speed",function(a){e.speed=f(new bulletml.Speed,a)});p(c,/(action)|(actionRef)$/,
function(c){"action"==c.tagName.toLowerCase()?e.actions[e.actions.length]=a(d,c):"actionref"==c.tagName.toLowerCase()&&(e.actions[e.actions.length]=b(d,c))});e.root=d;return e}function e(a,b){var c=new bulletml.Fire;m(b,"label",function(a){c.label=a});i(b,"direction",function(a){c.direction=f(new bulletml.Direction,a)});i(b,"speed",function(a){c.speed=f(new bulletml.Speed,a)});i(b,"bullet",function(b){c.bullet=d(a,b)});i(b,"bulletref",function(b){var d=new bulletml.BulletRef;m(b,"label",function(a){d.label=
a});p(b,/param$/,function(a){d.params[d.params.length]=l(a)});d.root=a;c.bullet=d});if(!c.bullet)throw Error("fire has no bullet or bulletRef.");c.root=a;return c}function f(a,b){m(b,"type",function(b){a.type=b});l(b,function(b){a.value=b});return a}function i(a,b,d,c){for(var b=b.toLowerCase(),a=a.childNodes,e=0,f=a.length;e<f;e++)if(a[e].tagName&&a[e].tagName.toLowerCase()==b)return d&&d(a[e]),a[e];c&&c();return null}function p(a,b,d){for(var a=a.childNodes,c=0,e=a.length;c<e;c++)a[c].tagName&&
a[c].tagName.toLowerCase().match(b)&&d(a[c])}function m(a,b,c,d){if(a=a.attributes[b])return c&&c(a.value),a;d&&d()}function l(a,b){var c=a.textContent.trim();if(void 0!==c)return b&&b(c),c;if(a.childNodes[0]&&(c=a.childNodes[0].nodeValue,void 0!==c))return b&&b(c),c}bulletml.build=function(a){if("string"===typeof a)var b=new DOMParser,a=c(b.parseFromString(a,"application/xml"));else if(a.getElementsByTagName("bulletml"))a=c(a);else throw Error("cannot build "+a);return a}})();(function(){bulletml.dsl=function(c){var c=c||"",a;for(a in bulletml.dsl)bulletml.dsl.hasOwnProperty(a)&&(bulletml.GLOBAL[c+a]=bulletml.dsl[a])};bulletml.dsl.action=function(c){if(0<arguments.length)for(var a=0,b=arguments.length;a<b;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(c instanceof Array){a=0;for(b=c.length;a<b;a++)c[a]instanceof Function&&(c[a]=c[a]())}var d=new bulletml.Action;if(c instanceof Array){if(c.some(function(a){return!(a instanceof bulletml.Command)}))throw Error("argument type error.");
d.commands=c}else{a=0;for(b=arguments.length;a<b;a++)if(arguments[a]instanceof bulletml.Command)d.commands[a]=arguments[a];else throw Error("argument type error.");}return d};bulletml.dsl.actionRef=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("label is required.");d=new bulletml.ActionRef;d.label=""+c;if(a instanceof Array)d.params=a;else for(b=1;b<arguments.length;b++)d.params.push(arguments[b]);return d};
bulletml.dsl.bullet=function(c,a,b,d){for(var e=0,f=arguments.length;e<f;e++)arguments[e]instanceof Function&&(arguments[e]=arguments[e]());f=new bulletml.Bullet;for(e=0;e<arguments.length;e++)arguments[e]instanceof bulletml.Direction?f.direction=arguments[e]:arguments[e]instanceof bulletml.Speed?f.speed=arguments[e]:arguments[e]instanceof bulletml.Action?f.actions.push(arguments[e]):arguments[e]instanceof bulletml.ActionRef?f.actions.push(arguments[e]):arguments[e]instanceof Array?f.actions.push(bulletml.dsl.action(arguments[e])):
arguments[e]instanceof Object?f.option=arguments[e]:"string"===typeof arguments[e]&&(f.label=arguments[e]);return f};bulletml.dsl.bulletRef=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("label is required.");d=new bulletml.BulletRef;d.label=""+c;if(a instanceof Array)d.params=a;else for(b=1;b<arguments.length;b++)d.params.push(arguments[b]);return d};bulletml.dsl.fire=function(c,a,b,d){for(var e=0,f=arguments.length;e<
f;e++)arguments[e]instanceof Function&&(arguments[e]=arguments[e]());f=new bulletml.Fire;for(e=0;e<arguments.length;e++)arguments[e]instanceof bulletml.Direction?f.direction=arguments[e]:arguments[e]instanceof bulletml.Speed?f.speed=arguments[e]:arguments[e]instanceof bulletml.Bullet?f.bullet=arguments[e]:arguments[e]instanceof bulletml.BulletRef?f.bullet=arguments[e]:arguments[e]instanceof bulletml.FireOption?f.option=arguments[e]:arguments[e]instanceof bulletml.OffsetX?f.option.offsetX=arguments[e].value:
arguments[e]instanceof bulletml.OffsetY?f.option.offsetY=arguments[e].value:arguments[e]instanceof bulletml.Autonomy&&(f.option.autonomy=arguments[e].value);if(void 0===f.bullet)throw Error("bullet (or bulletRef) is required.");return f};bulletml.dsl.fireRef=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("label is required.");d=new bulletml.FireRef;d.label=""+c;if(a instanceof Array)d.params=a;else for(b=
1;b<arguments.length;b++)d.params.push(arguments[b]);return d};bulletml.dsl.changeDirection=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("direction is required.");if(void 0===a)throw Error("term is required.");b=new bulletml.ChangeDirection;b.direction=c instanceof bulletml.Direction?c:new bulletml.Direction(c);b.term=a;return b};bulletml.dsl.changeSpeed=function(c,a){for(var b=0,d=arguments.length;b<
d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("speed is required.");if(void 0===a)throw Error("term is required.");b=new bulletml.ChangeSpeed;b.speed=c instanceof bulletml.Speed?c:new bulletml.Speed(c);b.term=a;return b};bulletml.dsl.accel=function(c,a,b){for(var d=0,e=arguments.length;d<e;d++)arguments[d]instanceof Function&&(arguments[d]=arguments[d]());e=new bulletml.Accel;for(d=0;d<arguments.length;d++)arguments[d]instanceof bulletml.Horizontal?
e.horizontal=c:arguments[d]instanceof bulletml.Vertical?e.vertical=a:e.term=arguments[d];if(void 0===e.horizontal&&void 0===e.vertical)throw Error("horizontal or vertical is required.");if(void 0===e.term)throw Error("term is required.");return e};bulletml.dsl.wait=function(c){for(var a=0,b=arguments.length;a<b;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("value is required.");return new bulletml.Wait(c)};bulletml.dsl.vanish=function(){return new bulletml.Vanish};
bulletml.dsl.repeat=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("times is required.");if(void 0===a)throw Error("action is required.");d=new bulletml.Repeat;d.times=c;if(a instanceof bulletml.Action||a instanceof bulletml.ActionRef)d.action=a;else if(a instanceof Array)d.action=bulletml.dsl.action(a);else{for(var e=[],b=1;b<arguments.length;b++)e.push(arguments[b]);d.action=bulletml.dsl.action(e)}return d};
bulletml.dsl.bindVar=function(c,a){return new bulletml.Bind(c,a)};bulletml.dsl.notify=function(c,a){return new bulletml.Notify(c,a)};bulletml.dsl.direction=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("value is required.");b=new bulletml.Direction(c);void 0!==a&&(b.type=a);return b};bulletml.dsl.speed=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());
if(void 0===c)throw Error("value is required.");b=new bulletml.Speed(c);a&&(b.type=a);return b};bulletml.dsl.horizontal=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("value is required.");b=new bulletml.Horizontal(c);a&&(b.type=a);return b};bulletml.dsl.vertical=function(c,a){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("value is required.");
b=new bulletml.Vertical(c);a&&(b.type=a);return b};bulletml.dsl.fireOption=function(c){return new bulletml.FireOption(c)};bulletml.dsl.offsetX=function(c){return new bulletml.OffsetX(c)};bulletml.dsl.offsetY=function(c){return new bulletml.OffsetY(c)};bulletml.dsl.autonomy=function(c){return new bulletml.Autonomy(c)}})();
