var BulletML={};
(function(){function h(b){var a=new BulletML.Root,f=b.getElementsByTagName("bulletml")[0];if(f){k(f,"type",function(b){a.type=b});var m=f.getElementsByTagName("action");if(m)for(var b=0,d=m.length;b<d;b++){var g=n(a,m[b]);g&&(a.actions[a.actions.length]=g)}if(m=f.getElementsByTagName("bullet")){b=0;for(d=m.length;b<d;b++)(g=c(a,m[b]))&&(a.bullets[a.bullets.length]=g)}if(f=f.getElementsByTagName("fire")){b=0;for(d=f.length;b<d;b++)(m=e(a,f[b]))&&(a.fires[a.fires.length]=m)}return a}}function n(b,a){var f=
new BulletML.Action;k(a,"label",function(b){f.label=b});j(a,".",function(a){switch(a.tagName){case "action":f.commands[f.commands.length]=n(b,a);break;case "actionRef":f.commands[f.commands.length]=p(b,a);break;case "fire":f.commands[f.commands.length]=e(b,a);break;case "fireRef":var i=f.commands,c=f.commands.length,h=new BulletML.FireRef;k(a,"label",function(b){h.label=b});j(a,/param$/,function(b){h.params[h.params.length]=l(b)});h.root=b;i[c]=h;break;case "changeDirection":var i=f.commands,c=f.commands.length,
s=new BulletML.ChangeDirection;s.root=b;g(a,"direction",function(b){s.direction=d(new BulletML.Direction,b)});g(a,"term",function(b){s.term=l(b)});i[c]=s;break;case "changeSpeed":var i=f.commands,c=f.commands.length,t=new BulletML.ChangeSpeed;t.root=b;g(a,"speed",function(b){t.speed=d(new BulletML.Speed,b)});g(a,"term",function(b){t.term=l(b)});i[c]=t;break;case "accel":var i=f.commands,c=f.commands.length,q=new BulletML.Accel;q.root=b;g(a,"horizontal",function(b){q.horizontal=d(new BulletML.Horizontal,
b)});g(a,"vertical",function(b){q.vertical=d(new BulletML.Vertical,b)});g(a,"term",function(b){q.term=l(b)});i[c]=q;break;case "wait":var i=f.commands,c=f.commands.length,u=new BulletML.Wait;u.root=b;u.value=l(a);i[c]=u;break;case "vanish":a=f.commands;i=f.commands.length;c=new BulletML.Vanish;c.root=b;a[i]=c;break;case "repeat":var i=f.commands,c=f.commands.length,r=new BulletML.Repeat;g(a,"action",function(a){r.action=n(b,a)});g(a,"actionRef",function(a){r.action=p(b,a)});g(a,"times",function(b){r.times=
l(b)});r.root=b;i[c]=r}});f.root=b;return f}function p(b,a){var f=new BulletML.ActionRef;k(a,"label",function(b){f.label=b});j(a,/param$/,function(b){f.params[f.params.length]=l(b)});f.root=b;return f}function c(b,a){var f=new BulletML.Bullet;k(a,"label",function(b){f.label=b});g(a,"direction",function(b){f.direction=d(new BulletML.Direction,b)});g(a,"speed",function(b){f.speed=d(new BulletML.Speed,b)});j(a,/(action)|(actionRef)$/,function(a){"action"==a.tagName?f.actions[f.actions.length]=n(b,a):
"actionRef"==a.tagName&&(f.actions[f.actions.length]=p(b,a))});f.root=b;return f}function e(b,a){var f=new BulletML.Fire;k(a,"label",function(b){f.label=b});g(a,"direction",function(b){f.direction=d(new BulletML.Direction,b)});g(a,"speed",function(b){f.speed=d(new BulletML.Speed,b)});g(a,"bullet",function(a){f.bullet=c(b,a)});g(a,"bulletRef",function(a){var c=new BulletML.BulletRef;k(a,"label",function(b){c.label=b});j(a,/param$/,function(b){c.params[c.params.length]=l(b)});c.root=b;f.bullet=c});
if(!f.bullet)throw Error("fire has no bullet or bulletRef.");f.root=b;return f}function d(b,a){k(a,"type",function(a){b.type=a});l(a,function(a){b.value=a});return b}function a(b,a){for(var c=0,d=b.length;c<d;c++)if(b[c].label==a)return b[c]}function g(b,a,c,d){for(var b=b.childNodes,e=0,g=b.length;e<g;e++)if(b[e].tagName&&b[e].tagName==a)return c&&c(b[e]),c(b[e]);d&&d()}function j(b,a,c){for(var b=b.childNodes,d=0,e=b.length;d<e;d++)b[d].tagName&&b[d].tagName.match(a)&&c(b[d])}function k(b,a,c,d){if(b=
b.attributes[a])return c&&c(b.value),b;d&&d()}function l(b,a){var c=b.textContent;if(void 0!==c||b.childNodes[0]&&(c=b.childNodes[0].nodeValue,void 0!==c))return a&&a(c),c}BulletML.build=function(b){if("string"==typeof b)var a=new DOMParser,b=h(a.parseFromString(b,"application/xml"));else if(b.getElementsByTagName("bulletml"))b=h(b);else throw Error("cannot build "+b);return b};BulletML.Root=function(){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[]};BulletML.Root.prototype.findAction=
function(b){return a(this.actions,b)};BulletML.Root.prototype.findActionOrThrow=function(b){var a;if(a=this.findAction(b))return a;throw Error("action labeled '"+b+"' is undefined.");};BulletML.Root.prototype.findBullet=function(b){return a(this.bullets,b)};BulletML.Root.prototype.findBulletOrThrow=function(b){var a;if(a=this.findBullet(b))return a;throw Error("bullet labeled '"+b+"' is undefined.");};BulletML.Root.prototype.findFire=function(b){return a(this.fires,b)};BulletML.Root.prototype.findFireOrThrow=
function(b){var a;if(a=this.findFire(b))return a;throw Error("fire labeled '"+b+"' is undefined.");};BulletML.Root.prototype.getWalker=function(b,a){var c=new BulletML.Walker(this,a),d=this.findAction(b);if(d)return c._action=d,c};BulletML.Walker=function(b,a){this._root=b;this._stack=[];this._cursor=-1;this._action=null;this._localScope={};this._globalScope={$rank:a||0}};BulletML.Walker.prototype.next=function(){this._cursor+=1;if(this._action){var b=this._action.commands[this._cursor];if(b){var a=
{commandName:b.commandName};switch(b.commandName){case "action":return this.pushStack(),this._action=b,this._localScope=this.newScope(b.params),this.next();case "actionRef":return this.pushStack(),this._action=this._root.findActionOrThrow(b.label),this._localScope=this.newScope(b.params),this.next();case "repeat":return this._localScope.loopCounter=0,this._localScope.loopEnd=this.eval(b.times),this.pushStack(),this._action={commandName:"action",commands:[b.action]},this._localScope=this.newScope(b.params),
this.next();case "fire":a.bullet=b.bullet.clone(this);b.direction&&(a.direction={type:b.direction.type,value:this.eval(b.direction.value)});b.speed&&(a.speed={type:b.speed.type,value:this.eval(b.speed.value)});break;case "fireRef":return this.pushStack(),this._action={commandName:"action",commands:[this._root.findFireOrThrow(b.label)]},this._localScope=this.newScope(b.params),this.next();case "changeDirection":b.direction&&(a.direction={type:b.direction.type,value:this.eval(b.direction.value)});b.term&&
(a.term=this.eval(b.term));break;case "changeSpeed":b.speed&&(a.speed={type:b.speed.type,value:this.eval(b.speed.value)});b.term&&(a.term=this.eval(b.term));break;case "accel":b.horizontal&&(a.horizontal={type:b.horizontal.type,value:this.eval(b.horizontal.value)});b.vertical&&(a.vertical={type:b.vertical.type,value:this.eval(b.vertical.value)});b.term&&(a.term=this.eval(b.term));break;case "wait":a.value=this.eval(b.value)}return a}this.popStack();if(this._action){if((b=this._action.commands[this._cursor])&&
"repeat"==b.commandName)this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this.pushStack(),this._action={commandName:"action",commands:[b.action]},this._localScope=this.newScope(b.params));return this.next()}}};BulletML.Walker.prototype.pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};BulletML.Walker.prototype.popStack=function(){var b=this._stack.pop();b?(this._cursor=b.cursor,this._action=
b.action,this._localScope=b.scope):(this._cursor=-1,this._action=null,this._localScope={})};BulletML.Walker.prototype.eval=function(b){var a;if("number"==typeof b)return b;if(isNaN(a=Number(b))){if((a=this._localScope[b])||(a=this._globalScope[b]))return a;if("$rand"==b)return Math.random()}else return a;a={};for(var c in this._globalScope)this._globalScope.hasOwnProperty(c)&&(a[c]=this._globalScope[c]);for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(a[c]=this._localScope[c]);a.$rand=
Math.random();return eval("BulletML._temp = function() { return "+b.split("$").join("this.$")+"}").bind(a)()};BulletML.Walker.prototype.newScope=function(b){var a={};if(b)for(var c=0,d=b.length;c<d;c++)a["$"+(c+1)]=this.eval(b[c]);else for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(a[c]=this._localScope[c]);return a};BulletML.Bullet=function(){this.root=this.label=null;this.direction=new BulletML.Direction(0);this.speed=new BulletML.Speed(1);this.actions=[];this._localScope={}};BulletML.Bullet.prototype.getWalker=
function(b){var b=new BulletML.Walker(this.root,b),a=new BulletML.Action;a.root=this.root;a.commands=this.actions;b._action=a;b._localScope=this._localScope;return b};BulletML.Bullet.prototype.clone=function(b){var a=new BulletML.Bullet;a.label=this.label;a.root=this.root;a.actions=this.actions;a.direction={type:this.direction.type,value:b.eval(this.direction.value)};a.speed={type:this.speed.type,value:b.eval(this.speed.value)};a._localScope=b._localScope;return a};BulletML.BulletRef=function(){this.label=
this.root=null;this.params=[]};BulletML.BulletRef.prototype.clone=function(a){var c=a._localScope;a._localScope=a.newScope(this.params);var d=this.root.findBulletOrThrow(this.label).clone(a);a._localScope=c;return d};BulletML.Command=function(){this.commandName=null};BulletML.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[]};BulletML.Action.prototype=new BulletML.Command;BulletML.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=
[]};BulletML.ActionRef.prototype=new BulletML.Command;BulletML.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=this.root=this.label=null};BulletML.Fire.prototype=new BulletML.Command;BulletML.FireRef=function(){this.commandName="fireRef";this.label=null;this.params=[]};BulletML.FireRef.prototype=new BulletML.Command;BulletML.ChangeDirection=function(){this.commandName="changeDirection";this.direction=null;this.term=0};BulletML.ChangeDirection.prototype=new BulletML.Command;
BulletML.ChangeSpeed=function(){this.commandName="changeSpeed";this.speed=null;this.term=0};BulletML.ChangeSpeed.prototype=new BulletML.Command;BulletML.Accel=function(){this.commandName="accel";this.vertical=this.horizontal=null;this.term=0};BulletML.Accel.prototype=new BulletML.Command;BulletML.Wait=function(a){this.commandName="wait";this.value=a?a:0};BulletML.Wait.prototype=new BulletML.Command;BulletML.Vanish=function(){this.commandName="vanish"};BulletML.Vanish.prototype=new BulletML.Command;
BulletML.Repeat=function(){this.commandName="repeat";this.times=0;this.action=null};BulletML.Repeat.prototype=new BulletML.Command;BulletML.Direction=function(a){this.type="aim";this.value=a?a:0};BulletML.Speed=function(a){this.type="absolute";this.value=a?a:1};BulletML.Horizontal=function(a){this.type="absolute";this.value=a?a:0};BulletML.Vertical=function(a){this.type="absolute";this.value=a?a:0}})();(function(){function h(c){return c*Math.PI/180}function n(c){for(;c<=-Math.PI;)c+=2*Math.PI;for(;Math.PI<c;)c-=2*Math.PI;return c}function p(c,e){return Math.atan2(e.y+(e.height||0)/2-(c.y+(c.height||0)/2),e.x+(e.width||0)/2-(c.x+(c.width||0)/2))}enchant.Game._loadFuncs.bml=enchant.Game._loadFuncs.xml=function(c,e){var d=this,a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState){if(200!==a.status&&0!==a.status)throw Error(a.status+": Cannot load an asset: "+c);if(null!=a.responseXML){var g=
BulletML.build(a.responseXML);g?d.assets[c]=new enchant.bulletml.AttackPattern(g):(console.warn(c+"\u306f\u59a5\u5f53\u306aBulletML\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002"),d.assets[c]=a.responseXML);e()}else if(null!=a.responseText)d.assets[c]=BulletML.build(a.responseText),e();else throw Error(a.status+": Cannot load an asset: "+c);}};a.open("GET",c,!0);a.overrideMimeType&&a.overrideMimeType("application/xml");a.send(null)};enchant.bulletml={};enchant.bulletml.DEFAULT_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAa0lEQVQYV2NkgIL/DAw2QGYolLuakYHhCIgNpBkYgJITGWxs8hj8/CDymzYBpY9MAkrmM4J12tgcZlizhoFBXByi4OVLBoaQEJAiW5CCiQxdXXkMpaUw2yB0dzcDQ1nZJKIU4LeCoCMJeRMAewIxn7cIaLcAAAAASUVORK5CYII=";
enchant.bulletml.DEFAULT_BULLET_FACTORY=function(){var c=new enchant.Sprite(8,8);c.image=enchant.Surface.load(enchant.bulletml.DEFAULT_IMAGE);return c};enchant.bulletml.AttackPattern=enchant.Class.create({initialize:function(c){if(!c)throw Error("argument is invalid.",c);this._bulletml=c},_getConf:function(c){c instanceof enchant.Node&&(c={target:c});var e={bulletFactory:enchant.bulletml.DEFAULT_BULLET_FACTORY,testInWorld:function(a){var c=enchant.Game.instance.width,d=enchant.Game.instance.height,
e=a.height||0;return-(a.width||0)<=a.x&&a.x<c&&-e<=a.y&&a.y<d},rank:0,updateProperties:!1,speedRate:2};if(void 0!==c)for(var d in c)c.hasOwnProperty(d)&&(e[d]=c[d]);return e},createTicker:function(c,e){if(!e&&!this._bulletml.findAction("top")){for(var d=[],a=1;this._bulletml.findAction("top"+a);a++)d[d.length]=this._createTicker(c,"top"+a);for(var g=function(){if(!g.complete){for(var a=d.length;a--;)d[a].call(this);g.compChildCount==d.length&&(g.complete=!0,this.dispatchEvent(new Event("completeAttack")))}},
a=d.length;a--;)d[a].parentTicker=g;g.compChildCount=0;g.completeChild=function(){this.compChildCount++};g.restart=function(){for(var a=d.length;a--;)d[a].restart();this.compChildCount=0;this.complete=!1};g.restart();return g}return this._createTicker(c,e)},_createTicker:function(c,e){var c=this._getConf(c),d=this,a=function(){this.age<a.chDirEnd?a.direction+=a.dirIncr:this.age==a.chDirEnd&&(a.direction=a.dirFin);this.age<a.chSpdEnd?a.speed+=a.spdIncr:this.age==a.chSpdEnd&&(a.speed=a.spdFin);this.age<
a.aclEnd?(a.speedH+=a.aclIncrH,a.speedV+=a.aclIncrV):this.age==a.aclEnd&&(a.speedH=a.aclFinH,a.speedV=a.aclFinV);this.x+=Math.cos(a.direction)*a.speed*c.speedRate;this.y+=Math.sin(a.direction)*a.speed*c.speedRate;this.x+=a.speedH*c.speedRate;this.y+=a.speedV*c.speedRate;c.testInWorld(this)||this.parentNode.removeChild(this);c.updateProperties&&(this.direction=180*(a.direction+Math.PI/2)/Math.PI,this.speed=a.speed);if(!(this.age<a.waitTo||a.completed)){for(var e;e=a.walker.next();)switch(e.commandName){case "fire":d._fire.call(this,
e,c,a,d);break;case "wait":a.waitTo=this.age+eval(e.value);return;case "changeDirection":d._changeDirection.call(this,e,c,a);break;case "changeSpeed":d._changeSpeed.call(this,e,a);break;case "accel":d._accel.call(this,e,a);break;case "vanish":this.parentNode&&this.parentNode.removeChild(this)}a.completed=!0;a.parentTicker?a.parentTicker.completeChild():this.dispatchEvent(new Event("completeAttack"))}};a.restart=function(){if(void 0===e)this.walker=d._bulletml.getWalker("top",c.rank);else if("string"===
typeof e)this.walker=d._bulletml.getWalker(e,c.rank);else if(e instanceof BulletML.Bullet)this.walker=e.getWalker(c.rank);else throw Error("\u5f15\u6570\u304c\u4e0d\u6b63",c,e);this.waitTo=-1;this.completed=!1;this.dirFin=this.dirIncr=this.speedV=this.speedH=this.lastSpeed=this.speed=this.lastDirection=this.direction=0;this.chDirEnd=-1;this.spdFin=this.spdIncr=0;this.chSpdEnd=-1;this.aclFinV=this.aclIncrV=this.aclFinH=this.aclIncrH=0;this.aclEnd=-1};a.restart();return a},_fire:function(c,e,d,a){var g=
e.bulletFactory({label:c.bullet.label});if(g){var j=a.createTicker(e,c.bullet),k=this;j.direction=function(a){var b=h(eval(a.value));switch(a.type){case "aim":return e.target?p(k,e.target)+b:b-Math.PI/2;case "absolute":return b-Math.PI/2;case "relative":return d.direction+b;case "sequence":return d.lastDirection+b}}(c.direction||c.bullet.direction);d.lastDirection=j.direction;j.speed=function(a){var b=eval(a.value);switch(a.type){case "relative":case "sequence":return d.lastSpeed+b;default:return b}}(c.speed||
c.bullet.speed);d.lastSpeed=j.speed;g.x=this.x+((this.width||0)-(g.width||0))/2;g.y=this.y+((this.height||0)-(g.height||0))/2;g.addEventListener("enterframe",j);g.addEventListener("removed",function(){this.removeEventListener("enterframe",j)});e.addTarget?e.addTarget.addChild(g):this.parentNode&&this.parentNode.addChild(g)}},_changeDirection:function(c,e,d){var a=eval(c.direction.value),g=eval(c.term);switch(c.direction.type){case "aim":c=e.target;if(!c)return;d.dirFin=p(this,c)+h(a);d.dirIncr=n(d.dirFin-
d.direction)/g;break;case "absolute":d.dirFin=h(a)-Math.PI/2;d.dirIncr=n(d.dirFin-d.direction)/g;break;case "relative":d.dirFin=d.direction+h(a);d.dirIncr=n(d.dirFin-d.direction)/g;break;case "sequence":d.dirIncr=h(a),d.dirFin=d.direction+d.dirIncr*g}d.chDirEnd=this.age+g},_changeSpeed:function(c,e){var d=eval(c.speed.value),a=eval(c.term);switch(c.speed.type){case "absolute":e.spdFin=d;e.spdIncr=(e.spdFin-e.speed)/a;break;case "relative":e.spdFin=d+e.speed;e.spdIncr=(e.spdFin-e.speed)/a;break;case "sequence":e.spdIncr=
d,e.spdFin=e.speed+e.spdIncr*a}e.chSpdEnd=this.age+a},_accel:function(c,e){var d=eval(c.term);e.aclEnd=this.age+d;if(c.horizontal){var a=eval(c.horizontal.value);switch(c.horizontal.type){case "absolute":case "sequence":e.aclIncrH=(a-e.speedH)/d;e.aclFinH=a;break;case "relative":e.aclIncrH=a,e.aclFinH=(a-e.speedH)*d}}else e.aclIncrH=0,e.aclFinH=e.speedH;if(c.vertical)switch(a=eval(c.vertical.value),c.vertical.type){case "absolute":case "sequence":e.aclIncrV=(a-e.speedV)/d;e.aclFinV=a;break;case "relative":e.aclIncrV=
a,e.aclFinV=(a-e.speedV)*d}else e.aclIncrV=0,e.aclFinV=e.speedV},bulletml:{get:function(){return this._bulletml}}})})();
