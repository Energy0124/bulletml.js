var BulletML={global:this};
(function(){function k(a){var d=new BulletML.Root;if(a=a.getElementsByTagName("bulletml")[0]){j(a,"type",function(a){d.type=a});var c=a.getElementsByTagName("action");if(c)for(var l=0,b=c.length;l<b;l++)if(c[l].parentNode===a){var f=p(d,c[l]);f&&(d.actions[d.actions.length]=f)}if(c=a.getElementsByTagName("bullet")){l=0;for(b=c.length;l<b;l++)c[l].parentNode===a&&(f=n(d,c[l]))&&(d.bullets[d.bullets.length]=f)}if(c=a.getElementsByTagName("fire")){l=0;for(b=c.length;l<b;l++)c[l].parentNode===a&&(f=e(d,
c[l]))&&(d.fires[d.fires.length]=f)}return d}}function p(a,d){var c=new BulletML.Action;j(d,"label",function(a){c.label=a});h(d,".",function(d){switch(d.tagName.toLowerCase()){case "action":c.commands[c.commands.length]=p(a,d);break;case "actionref":c.commands[c.commands.length]=q(a,d);break;case "fire":c.commands[c.commands.length]=e(a,d);break;case "fireref":var b=c.commands,m=c.commands.length,k=new BulletML.FireRef;j(d,"label",function(a){k.label=a});h(d,/param$/,function(a){k.params[k.params.length]=
i(a)});k.root=a;b[m]=k;break;case "changedirection":var b=c.commands,m=c.commands.length,n=new BulletML.ChangeDirection;n.root=a;g(d,"direction",function(a){n.direction=f(new BulletML.Direction,a)});g(d,"term",function(a){n.term=i(a)});b[m]=n;break;case "changespeed":var b=c.commands,m=c.commands.length,t=new BulletML.ChangeSpeed;t.root=a;g(d,"speed",function(a){t.speed=f(new BulletML.Speed,a)});g(d,"term",function(a){t.term=i(a)});b[m]=t;break;case "accel":var b=c.commands,m=c.commands.length,r=
new BulletML.Accel;r.root=a;g(d,"horizontal",function(a){r.horizontal=f(new BulletML.Horizontal,a)});g(d,"vertical",function(a){r.vertical=f(new BulletML.Vertical,a)});g(d,"term",function(a){r.term=i(a)});b[m]=r;break;case "wait":var b=c.commands,m=c.commands.length,u=new BulletML.Wait;u.root=a;u.value=i(d);b[m]=u;break;case "vanish":d=c.commands;b=c.commands.length;m=new BulletML.Vanish;m.root=a;d[b]=m;break;case "repeat":var b=c.commands,m=c.commands.length,s=new BulletML.Repeat;g(d,"action",function(c){s.action=
p(a,c)});g(d,"actionRef",function(c){s.action=q(a,c)});g(d,"times",function(a){s.times=i(a)});s.root=a;b[m]=s}});c.root=a;return c}function q(a,d){var c=new BulletML.ActionRef;j(d,"label",function(a){c.label=a});h(d,/param$/,function(a){c.params[c.params.length]=i(a)});c.root=a;return c}function n(a,d){var c=new BulletML.Bullet;j(d,"label",function(a){c.label=a});g(d,"direction",function(a){c.direction=f(new BulletML.Direction,a)});g(d,"speed",function(a){c.speed=f(new BulletML.Speed,a)});h(d,/(action)|(actionRef)$/,
function(d){"action"==d.tagName.toLowerCase()?c.actions[c.actions.length]=p(a,d):"actionref"==d.tagName.toLowerCase()&&(c.actions[c.actions.length]=q(a,d))});c.root=a;return c}function e(a,d){var c=new BulletML.Fire;j(d,"label",function(a){c.label=a});g(d,"direction",function(a){c.direction=f(new BulletML.Direction,a)});g(d,"speed",function(a){c.speed=f(new BulletML.Speed,a)});g(d,"bullet",function(d){c.bullet=n(a,d)});g(d,"bulletref",function(d){var b=new BulletML.BulletRef;j(d,"label",function(a){b.label=
a});h(d,/param$/,function(a){b.params[b.params.length]=i(a)});b.root=a;c.bullet=b});if(!c.bullet)throw Error("fire has no bullet or bulletRef.");c.root=a;return c}function f(a,d){j(d,"type",function(d){a.type=d});i(d,function(d){a.value=d});return a}function b(a,d){for(var c=0,b=a.length;c<b;c++)if(a[c].label==d)return a[c]}function g(a,d,c,b){for(var d=d.toLowerCase(),a=a.childNodes,e=0,f=a.length;e<f;e++)if(a[e].tagName&&a[e].tagName.toLowerCase()==d)return c&&c(a[e]),c(a[e]);b&&b()}function h(a,
d,c){console.log("element",a);console.log("filter",d);for(var a=a.childNodes,b=0,e=a.length;b<e;b++)console.log("tagName = ["+a[b].tagName+"]"),a[b].tagName&&a[b].tagName.toLowerCase().match(d)?(console.log("   -> match! "+a[b].tagName.toLowerCase()),c(a[b])):console.log("   -> unmatch!")}function j(a,d,c,b){if(a=a.attributes[d])return c&&c(a.value),a;b&&b()}function i(a,d){var c=a.textContent;if(void 0!==c||a.childNodes[0]&&(c=a.childNodes[0].nodeValue,void 0!==c))return d&&d(c),c}BulletML.build=
function(a){if("string"==typeof a)var d=new DOMParser,a=k(d.parseFromString(a,"application/xml"));else if(a.getElementsByTagName("bulletml"))a=k(a);else throw Error("cannot build "+a);return a};BulletML.Root=function(a){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[];if(a){for(var d in a)a.hasOwnProperty(d)&&(a[d].label=d,a[d]instanceof BulletML.Action?this.actions.push(a[d]):a[d]instanceof BulletML.Bullet?this.bullets.push(a[d]):a[d]instanceof BulletML.Fire&&this.fires.push(a[d]));
this.setRoot(this)}};BulletML.Root.prototype.findAction=function(a){return b(this.actions,a)};BulletML.Root.prototype.getTopActionLabels=function(){for(var a=[],d=0,c=this.actions.length;d<c;d++){var b=this.actions[d];b.label&&0===b.label.indexOf("top")&&(a[a.length]=b.label)}return a};BulletML.Root.prototype.findActionOrThrow=function(a){var d;if(d=this.findAction(a))return d;throw Error("action labeled '"+a+"' is undefined.");};BulletML.Root.prototype.findBullet=function(a){return b(this.bullets,
a)};BulletML.Root.prototype.findBulletOrThrow=function(a){var d;if(d=this.findBullet(a))return d;throw Error("bullet labeled '"+a+"' is undefined.");};BulletML.Root.prototype.findFire=function(a){return b(this.fires,a)};BulletML.Root.prototype.findFireOrThrow=function(a){var d;if(d=this.findFire(a))return d;throw Error("fire labeled '"+a+"' is undefined.");};BulletML.Root.prototype.getWalker=function(a,d){var c=new BulletML.Walker(this,d),b=this.findAction(a);if(b)return c._action=b,c};BulletML.Root.prototype.setRoot=
function(){for(var a=0,d=this.actions.length;a<d;a++)this.actions[a].setRoot(this);a=0;for(d=this.bullets.length;a<d;a++)this.bullets[a].setRoot(this);a=0;for(d=this.fires.length;a<d;a++)this.fires[a].setRoot(this)};BulletML.Walker=function(a,d){this._root=a;this._stack=[];this._cursor=-1;this._action=null;this._localScope={};this._globalScope={$rank:d||0}};BulletML.Walker.prototype.next=function(){this._cursor+=1;if(this._action){var a=this._action.commands[this._cursor];if(a){var d={commandName:a.commandName};
switch(a.commandName){case "action":return this.pushStack(),this._action=a,this._localScope=this.newScope(a.params),this.next();case "actionRef":return this.pushStack(),this._action=this._root.findActionOrThrow(a.label),this._localScope=this.newScope(a.params),this.next();case "repeat":return this._localScope.loopCounter=0,this._localScope.loopEnd=this.eval(a.times),this.pushStack(),this._action={commandName:"action",commands:[a.action]},this._localScope=this.newScope(a.params),this.next();case "fire":d.bullet=
a.bullet.clone(this);a.direction&&(d.direction={type:a.direction.type,value:this.eval(a.direction.value)});a.speed&&(d.speed={type:a.speed.type,value:this.eval(a.speed.value)});break;case "fireRef":return this.pushStack(),this._action={commandName:"action",commands:[this._root.findFireOrThrow(a.label)]},this._localScope=this.newScope(a.params),this.next();case "changeDirection":a.direction&&(d.direction={type:a.direction.type,value:this.eval(a.direction.value)});a.term&&(d.term=this.eval(a.term));
break;case "changeSpeed":a.speed&&(d.speed={type:a.speed.type,value:this.eval(a.speed.value)});a.term&&(d.term=this.eval(a.term));break;case "accel":a.horizontal&&(d.horizontal={type:a.horizontal.type,value:this.eval(a.horizontal.value)});a.vertical&&(d.vertical={type:a.vertical.type,value:this.eval(a.vertical.value)});a.term&&(d.term=this.eval(a.term));break;case "wait":d.value=this.eval(a.value)}return d}this.popStack();if(null!==this._action){if((a=this._action.commands[this._cursor])&&"repeat"==
a.commandName)this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this.pushStack(),this._action={commandName:"action",commands:[a.action]},this._localScope=this.newScope(a.params));return this.next()}}};BulletML.Walker.prototype.pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};BulletML.Walker.prototype.popStack=function(){var a=this._stack.pop();a?(this._cursor=a.cursor,this._action=a.action,
this._localScope=a.scope):(this._cursor=-1,this._action=null,this._localScope={})};BulletML.Walker.prototype.eval=function(a){var d;if("number"==typeof a)return a;if(isNaN(d=Number(a))){if((d=this._localScope[a])||(d=this._globalScope[a]))return d;if("$rand"==a)return Math.random()}else return d;d={};for(var c in this._globalScope)this._globalScope.hasOwnProperty(c)&&(d[c]=this._globalScope[c]);for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(d[c]=this._localScope[c]);d.$rand=Math.random();
return eval("BulletML._temp = function() { return "+a.split("$").join("this.$")+"}").bind(d)()};BulletML.Walker.prototype.newScope=function(a){var d={};if(a)for(var c=0,b=a.length;c<b;c++)d["$"+(c+1)]=this.eval(a[c]);else for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(d[c]=this._localScope[c]);return d};BulletML.Bullet=function(){this.root=this.label=null;this.direction=new BulletML.Direction(0);this.speed=new BulletML.Speed(1);this.actions=[];this._localScope={}};BulletML.Bullet.prototype.getWalker=
function(a){var a=new BulletML.Walker(this.root,a),d=new BulletML.Action;d.root=this.root;d.commands=this.actions;a._action=d;a._localScope=this._localScope;return a};BulletML.Bullet.prototype.clone=function(a){var d=new BulletML.Bullet;d.label=this.label;d.root=this.root;d.actions=this.actions;d.direction={type:this.direction.type,value:a.eval(this.direction.value)};d.speed={type:this.speed.type,value:a.eval(this.speed.value)};d._localScope=a._localScope;return d};BulletML.Bullet.prototype.setRoot=
function(a){this.root=a;for(var d=0,c=this.actions.length;d<c;d++)this.actions[d].setRoot(a)};BulletML.BulletRef=function(){this.label=this.root=null;this.params=[]};BulletML.BulletRef.prototype.clone=function(a){var d=a._localScope;a._localScope=a.newScope(this.params);var c=this.root.findBulletOrThrow(this.label).clone(a);a._localScope=d;return c};BulletML.BulletRef.prototype.setRoot=function(a){this.root=a};BulletML.Command=function(){this.commandName=null};BulletML.Command.prototype.setRoot=function(a){this.root=
a};BulletML.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[]};BulletML.Action.prototype=new BulletML.Command;BulletML.Action.prototype.setRoot=function(a){this.root=a;for(var d=0,c=this.commands.length;d<c;d++)this.commands[d].setRoot(a)};BulletML.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=[]};BulletML.ActionRef.prototype=new BulletML.Command;BulletML.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=
this.root=this.label=null};BulletML.Fire.prototype=new BulletML.Command;BulletML.Fire.prototype.setRoot=function(a){this.root=a;this.bullet&&this.bullet.setRoot(a)};BulletML.FireRef=function(){this.commandName="fireRef";this.label=null;this.params=[]};BulletML.FireRef.prototype=new BulletML.Command;BulletML.ChangeDirection=function(){this.commandName="changeDirection";this.direction=null;this.term=0};BulletML.ChangeDirection.prototype=new BulletML.Command;BulletML.ChangeSpeed=function(){this.commandName=
"changeSpeed";this.speed=null;this.term=0};BulletML.ChangeSpeed.prototype=new BulletML.Command;BulletML.Accel=function(){this.commandName="accel";this.vertical=this.horizontal=null;this.term=0};BulletML.Accel.prototype=new BulletML.Command;BulletML.Wait=function(a){this.commandName="wait";this.value=a?a:0};BulletML.Wait.prototype=new BulletML.Command;BulletML.Vanish=function(){this.commandName="vanish"};BulletML.Vanish.prototype=new BulletML.Command;BulletML.Repeat=function(){this.commandName="repeat";
this.times=0;this.action=null};BulletML.Repeat.prototype=new BulletML.Command;BulletML.Repeat.prototype.setRoot=function(a){this.root=a;this.action&&this.action.setRoot(a)};BulletML.Direction=function(a){this.type="aim";this.value=a?a:0};BulletML.Speed=function(a){this.type="absolute";this.value=a?a:1};BulletML.Horizontal=function(a){this.type="absolute";this.value=a?a:0};BulletML.Vertical=function(a){this.type="absolute";this.value=a?a:0};BulletML.dsl=function(){for(var a in BulletML.dsl)BulletML.dsl.hasOwnProperty(a)&&
(BulletML.global[a]=BulletML.dsl[a])};BulletML.dsl.action=function(a){for(var d=0,c=arguments.length;d<c;d++)arguments[d]instanceof Function&&(arguments[d]=arguments[d]());var b=new BulletML.Action;if(a instanceof Array){if(a.some(function(a){return!(a instanceof BulletML.Command)}))throw Error("argument type error.");b.commands=a}else{d=0;for(c=arguments.length;d<c;d++)if(arguments[d]instanceof BulletML.Command)b.commands[d]=arguments[d];else throw Error("argument type error.");}return b};BulletML.dsl.actionRef=
function(a,d){for(var c=0,b=arguments.length;c<b;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("label is required.");b=new BulletML.ActionRef;b.label=""+a;if(d instanceof Array)b.params=d;else for(c=1;c<arguments.length;c++)b.params.push(arguments[c]);return b};BulletML.dsl.bullet=function(a,d,c,b){for(var e=0,f=arguments.length;e<f;e++)arguments[e]instanceof Function&&(arguments[e]=arguments[e]());f=new BulletML.Bullet;for(e=0;e<arguments.length;e++)arguments[e]instanceof
BulletML.Direction?f.direction=arguments[e]:arguments[e]instanceof BulletML.Speed?f.speed=arguments[e]:arguments[e]instanceof BulletML.Action?f.actions.push(arguments[e]):arguments[e]instanceof BulletML.ActionRef?f.actions.push(arguments[e]):"string"===typeof arguments[e]&&(f.label=arguments[e]);return f};BulletML.dsl.bulletRef=function(a,d){for(var c=0,b=arguments.length;c<b;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("label is required.");b=new BulletML.BulletRef;
b.label=""+a;if(d instanceof Array)b.params=d;else for(c=1;c<arguments.length;c++)b.params.push(arguments[c]);return b};BulletML.dsl.fire=function(a,d,c){for(var b=0,e=arguments.length;b<e;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());e=new BulletML.Fire;for(b=0;b<arguments.length;b++)arguments[b]instanceof BulletML.Direction?e.direction=arguments[b]:arguments[b]instanceof BulletML.Speed?e.speed=arguments[b]:arguments[b]instanceof BulletML.Bullet?e.bullet=arguments[b]:arguments[b]instanceof
BulletML.BulletRef&&(e.bullet=arguments[b]);if(void 0==e.bullet)throw Error("bullet (or bulletRef) is required.");return e};BulletML.dsl.fireRef=function(a,d){for(var b=0,e=arguments.length;b<e;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("label is required.");e=new BulletML.FireRef;e.label=""+a;if(d instanceof Array)e.params=d;else for(b=1;b<arguments.length;b++)e.params.push(arguments[b]);return e};BulletML.dsl.changeDirection=function(a,b){for(var c=
0,e=arguments.length;c<e;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("direction is required.");if(void 0==b)throw Error("term is required.");c=new BulletML.ChangeDirection;c.direction=a instanceof BulletML.Direction?a:new BulletML.Direction(a);c.term=b;return c};BulletML.dsl.changeSpeed=function(a,b){for(var c=0,e=arguments.length;c<e;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("speed is required.");if(void 0==
b)throw Error("term is required.");c=new BulletML.ChangeSpeed;c.speed=a instanceof BulletML.Speed?a:new BulletML.Speed(a);c.term=b;return c};BulletML.dsl.accel=function(a,b,c){for(var e=0,f=arguments.length;e<f;e++)arguments[e]instanceof Function&&(arguments[e]=arguments[e]());f=new BulletML.Accel;for(e=0;e<arguments.length;e++)arguments[e]instanceof BulletML.Horizontal?f.horizontal=a:arguments[e]instanceof BulletML.Vertical?f.vertical=b:f.term=arguments[e];if(void 0==f.horizontal&&void 0==f.vertical)throw Error("horizontal or vertical is required.");
if(void 0==f.term)throw Error("term is required.");return f};BulletML.dsl.wait=function(a){for(var b=0,c=arguments.length;b<c;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("value is required.");return new BulletML.Wait(a)};BulletML.dsl.vanish=function(){return new BulletML.Vanish};BulletML.dsl.repeat=function(a,b){for(var c=0,e=arguments.length;c<e;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("times is required.");
if(void 0==b)throw Error("action is required.");c=new BulletML.Repeat;c.times=a;b instanceof BulletML.Action||b instanceof BulletML.ActionRef?c.action=b:b instanceof Array&&(c.action=BulletML.dsl.action(b));return c};BulletML.dsl.direction=function(a,b){for(var c=0,e=arguments.length;c<e;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("value is required.");c=new BulletML.Direction(a);b&&(c.type=b);return c};BulletML.dsl.speed=function(a,b){for(var c=0,e=
arguments.length;c<e;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("value is required.");c=new BulletML.Speed(a);b&&(c.type=b);return c};BulletML.dsl.horizontal=function(a,b){for(var c=0,e=arguments.length;c<e;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("value is required.");c=new BulletML.Horizontal(a);b&&(c.type=b);return c};BulletML.dsl.vertical=function(a,b){for(var c=0,e=arguments.length;c<e;c++)arguments[c]instanceof
Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("value is required.");c=new BulletML.Vertical(a);b&&(c.type=b);return c}})();(function(){function k(e){return e*Math.PI/180}function p(e){for(;e<=-Math.PI;)e+=2*Math.PI;for(;Math.PI<e;)e-=2*Math.PI;return e}function q(e,f){return Math.atan2(f.y+(f.height||0)/2-(e.y+(e.height||0)/2),f.x+(f.width||0)/2-(e.x+(e.width||0)/2))}enchant.Game._loadFuncs.bml=enchant.Game._loadFuncs.xml=function(e,f){var b=this,g=new XMLHttpRequest;g.onreadystatechange=function(){if(4===g.readyState){if(200!==g.status&&0!==g.status)throw Error(g.status+": Cannot load an asset: "+e);if(null!=g.responseXML){var h=
BulletML.build(g.responseXML);h?b.assets[e]=new enchant.bulletml.AttackPattern(h):(console.warn(e+"\u306f\u59a5\u5f53\u306aBulletML\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002"),b.assets[e]=g.responseXML);f()}else if(null!=g.responseText)b.assets[e]=BulletML.build(g.responseText),f();else throw Error(g.status+": Cannot load an asset: "+e);}};g.open("GET",e,!0);g.overrideMimeType&&g.overrideMimeType("application/xml");g.send(null)};enchant.EventTarget.prototype.setDanmaku=function(e,f){if(void 0==
e)throw Error("AttackPattern is required.");this.removeDanmaku();this.on("enterframe",e.createTicker(f))};enchant.EventTarget.prototype.removeDanmaku=function(){if(this._listeners.enterframe&&0!==this._listeners.enterframe.length){for(var e=[],f=this._listeners.enterframe.length;f--;)this._listeners.enterframe[f].isDanmaku&&(e[e.length]=this._listeners.enterframe[f]);for(f=e.length;f--;)this.removeEventListener("enterframe",e[f])}};enchant.bulletml=enchant.bulletml||{};enchant.bulletml.getDefaultImage=
function(){if(this.value)return this.value;var e=new enchant.Surface(8,8),f=e.context,b=f.createRadialGradient(4,4,0,4,4,4);b.addColorStop(0,"rgba(255,255,255,1.0)");b.addColorStop(0.5,"rgba(255,255,255,1.0)");b.addColorStop(0.8,"rgba(255,  0,  0,0.8)");b.addColorStop(1,"rgba(255,  0,  0,0.0)");f.fillStyle=b;f.fillRect(0,0,8,8);return this.value=e};enchant.bulletml.defaultBulletFactory=function(){var e=new enchant.Sprite(8,8);e.image=enchant.bulletml.getDefaultImage();return e};var n=void 0;enchant.bulletml.defaultTestInWorld=
function(e){void 0===n&&(n=enchant.Game.instance);var f=n.width,b=n.height,g=e.height||0;return-(e.width||0)<=e.x&&e.x<f&&-g<=e.y&&e.y<b};enchant.bulletml.AttackPattern=enchant.Class.create({initialize:function(e){if(!e)throw Error("argument is invalid.",e);this._bulletml=e},_getConf:function(e){e instanceof enchant.Node&&(e={target:e});var f={},b=enchant.bulletml.AttackPattern.defaultConfig,g;for(g in b)b.hasOwnProperty(g)&&(f[g]=b[g]);if(void 0!==e)for(g in e)e.hasOwnProperty(g)&&(f[g]=e[g]);return f},
createTicker:function(e,f){var b=this._bulletml.getTopActionLabels();if(void 0===f&&1<b.length){for(var g=[],h=0,j=b.length;h<j;h++)g[g.length]=this._createTicker(e,b[h]);for(var i=function(){if(!i.complete){for(var a=g.length;a--;)g[a].call(this);i.compChildCount==g.length&&(i.complete=!0,this.dispatchEvent(new Event("completeAttack")))}},h=g.length;h--;)g[h].parentTicker=i;i.compChildCount=0;i.completeChild=function(){this.compChildCount++};i.compChildCount=0;i.complete=!1;i.isDanmaku=!0;return i}return this._createTicker(e,
f)},_createTicker:function(e,f){e=this._getConf(e);if(!e.target)throw Error("target is undefined in config.");var b=function(){if(b._pattern){var e=b.config;this.age<b.chDirEnd?b.direction+=b.dirIncr:this.age==b.chDirEnd&&(b.direction=b.dirFin);this.age<b.chSpdEnd?b.speed+=b.spdIncr:this.age==b.chSpdEnd&&(b.speed=b.spdFin);this.age<b.aclEnd?(b.speedH+=b.aclIncrH,b.speedV+=b.aclIncrV):this.age==b.aclEnd&&(b.speedH=b.aclFinH,b.speedV=b.aclFinV);this.x+=Math.cos(b.direction)*b.speed*e.speedRate;this.y+=
Math.sin(b.direction)*b.speed*e.speedRate;this.x+=b.speedH*e.speedRate;this.y+=b.speedV*e.speedRate;if(e.testInWorld(this)){if(e.updateProperties&&(this.direction=180*(b.direction+Math.PI/2)/Math.PI,this.speed=b.speed),!(this.age<b.waitTo||b.completed)){for(var f;f=b.walker.next();)switch(f.commandName){case "fire":b._pattern._fire.call(this,f,e,b,b._pattern);break;case "wait":e=0;b.waitTo="number"===typeof f.value?this.age+f.value:0!==(e=~~f.value)?this.age+e:this.age+eval(f.value);return;case "changeDirection":b._pattern._changeDirection.call(this,
f,e,b);break;case "changeSpeed":b._pattern._changeSpeed.call(this,f,b);break;case "accel":b._pattern._accel.call(this,f,b);break;case "vanish":this.parentNode&&this.parentNode.removeChild(this)}b.completed=!0;b.parentTicker?b.parentTicker.completeChild():this.dispatchEvent(new Event("completeAttack"))}}else this.parentNode.removeChild(this),b.completed=!0,b.parentTicker?b.parentTicker.completeChild():this.dispatchEvent(new Event("completeAttack"))}};if(void 0===f)b.walker=this._bulletml.getWalker("top",
e.rank);else if("string"===typeof f)b.walker=this._bulletml.getWalker(f,e.rank);else if(f instanceof BulletML.Bullet)b.walker=f.getWalker(e.rank);else throw console.error(e,f),Error("\u5f15\u6570\u304c\u4e0d\u6b63");b._pattern=this;b.config=e;b.waitTo=-1;b.completed=!1;b.direction=0;b.lastDirection=0;b.speed=0;b.lastSpeed=0;b.speedH=0;b.speedV=0;b.dirIncr=0;b.dirFin=0;b.chDirEnd=-1;b.spdIncr=0;b.spdFin=0;b.chSpdEnd=-1;b.aclIncrH=0;b.aclFinH=0;b.aclIncrV=0;b.aclFinV=0;b.aclEnd=-1;b.isDanmaku=!0;return b},
_fire:function(e,f,b,g){var h=f.bulletFactory({label:e.bullet.label});if(h){var j=g.createTicker(f,e.bullet),i=this;b.lastDirection=j.direction=function(a){var d=k(eval(a.value));switch(a.type){case "aim":return f.target?q(i,f.target)+d:d-Math.PI/2;case "absolute":return d-Math.PI/2;case "relative":return b.direction+d;default:return b.lastDirection+d}}(e.direction||e.bullet.direction);b.lastSpeed=j.speed=function(a){var d=eval(a.value);switch(a.type){case "relative":case "sequence":return b.lastSpeed+
d;default:return d}}(e.speed||e.bullet.speed);h.x=this.x+((this.width||0)-(h.width||0))/2;h.y=this.y+((this.height||0)-(h.height||0))/2;h.addEventListener("enterframe",j);h.addEventListener("removed",function(){this.removeEventListener("enterframe",j)});f.addTarget?f.addTarget.addChild(h):this.parentNode&&this.parentNode.addChild(h)}},_changeDirection:function(e,f,b){var g=eval(e.direction.value),h=eval(e.term);switch(e.direction.type){case "aim":e=f.target;if(!e)return;b.dirFin=q(this,e)+k(g);b.dirIncr=
p(b.dirFin-b.direction)/h;break;case "absolute":b.dirFin=k(g)-Math.PI/2;b.dirIncr=p(b.dirFin-b.direction)/h;break;case "relative":b.dirFin=b.direction+k(g);b.dirIncr=p(b.dirFin-b.direction)/h;break;case "sequence":b.dirIncr=k(g),b.dirFin=b.direction+b.dirIncr*h}b.chDirEnd=this.age+h},_changeSpeed:function(e,f){var b=eval(e.speed.value),g=eval(e.term);switch(e.speed.type){case "absolute":f.spdFin=b;f.spdIncr=(f.spdFin-f.speed)/g;break;case "relative":f.spdFin=b+f.speed;f.spdIncr=(f.spdFin-f.speed)/
g;break;case "sequence":f.spdIncr=b,f.spdFin=f.speed+f.spdIncr*g}f.chSpdEnd=this.age+g},_accel:function(e,f){var b=eval(e.term);f.aclEnd=this.age+b;if(e.horizontal){var g=eval(e.horizontal.value);switch(e.horizontal.type){case "absolute":case "sequence":f.aclIncrH=(g-f.speedH)/b;f.aclFinH=g;break;case "relative":f.aclIncrH=g,f.aclFinH=(g-f.speedH)*b}}else f.aclIncrH=0,f.aclFinH=f.speedH;if(e.vertical)switch(g=eval(e.vertical.value),e.vertical.type){case "absolute":case "sequence":f.aclIncrV=(g-f.speedV)/
b;f.aclFinV=g;break;case "relative":f.aclIncrV=g,f.aclFinV=(g-f.speedV)*b}else f.aclIncrV=0,f.aclFinV=f.speedV},bulletml:{get:function(){return this._bulletml}}});enchant.bulletml.AttackPattern.defaultConfig={bulletFactory:enchant.bulletml.defaultBulletFactory,testInWorld:enchant.bulletml.defaultTestInWorld,rank:0,updateProperties:!1,speedRate:2}})();
