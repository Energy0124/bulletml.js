var BulletML={global:this};
(function(){function u(a){var c=new BulletML.Root;if(a=a.getElementsByTagName("bulletml")[0]){i(a,"type",function(a){c.type=a});var b=a.getElementsByTagName("action");if(b)for(var d=0,e=b.length;d<e;d++)if(b[d].parentNode===a){var f=q(c,b[d]);f&&(c.actions[c.actions.length]=f)}if(b=a.getElementsByTagName("bullet")){d=0;for(e=b.length;d<e;d++)b[d].parentNode===a&&(f=v(c,b[d]))&&(c.bullets[c.bullets.length]=f)}if(b=a.getElementsByTagName("fire")){d=0;for(e=b.length;d<e;d++)b[d].parentNode===a&&(f=w(c,
b[d]))&&(c.fires[c.fires.length]=f)}return c}}function q(a,c){var b=new BulletML.Action;i(c,"label",function(a){b.label=a});m(c,".",function(c){switch(c.tagName.toLowerCase()){case "action":b.commands[b.commands.length]=q(a,c);break;case "actionref":b.commands[b.commands.length]=t(a,c);break;case "fire":b.commands[b.commands.length]=w(a,c);break;case "fireref":var e=b.commands,f=b.commands.length,l=new BulletML.FireRef;i(c,"label",function(a){l.label=a});m(c,/param$/,function(a){l.params[l.params.length]=
h(a)});l.root=a;e[f]=l;break;case "changedirection":var e=b.commands,f=b.commands.length,r=new BulletML.ChangeDirection;r.root=a;g(c,"direction",function(a){r.direction=j(new BulletML.Direction,a)});g(c,"term",function(a){r.term=h(a)});e[f]=r;break;case "changespeed":var e=b.commands,f=b.commands.length,s=new BulletML.ChangeSpeed;s.root=a;g(c,"speed",function(a){s.speed=j(new BulletML.Speed,a)});g(c,"term",function(a){s.term=h(a)});e[f]=s;break;case "accel":var e=b.commands,f=b.commands.length,n=
new BulletML.Accel;n.root=a;g(c,"horizontal",function(a){n.horizontal=j(new BulletML.Horizontal,a)});g(c,"vertical",function(a){n.vertical=j(new BulletML.Vertical,a)});g(c,"term",function(a){n.term=h(a)});e[f]=n;break;case "wait":var e=b.commands,f=b.commands.length,k=new BulletML.Wait;k.root=a;k.value=h(c);e[f]=k;break;case "vanish":c=b.commands;e=b.commands.length;f=new BulletML.Vanish;f.root=a;c[e]=f;break;case "repeat":var e=b.commands,f=b.commands.length,p=new BulletML.Repeat;g(c,"action",function(b){p.action=
q(a,b)});g(c,"actionRef",function(b){p.action=t(a,b)});g(c,"times",function(a){p.times=h(a)});p.root=a;e[f]=p}});b.root=a;return b}function t(a,c){var b=new BulletML.ActionRef;i(c,"label",function(a){b.label=a});m(c,/param$/,function(a){b.params[b.params.length]=h(a)});b.root=a;return b}function v(a,c){var b=new BulletML.Bullet;i(c,"label",function(a){b.label=a});g(c,"direction",function(a){b.direction=j(new BulletML.Direction,a)});g(c,"speed",function(a){b.speed=j(new BulletML.Speed,a)});m(c,/(action)|(actionRef)$/,
function(c){"action"==c.tagName.toLowerCase()?b.actions[b.actions.length]=q(a,c):"actionref"==c.tagName.toLowerCase()&&(b.actions[b.actions.length]=t(a,c))});b.root=a;return b}function w(a,c){var b=new BulletML.Fire;i(c,"label",function(a){b.label=a});g(c,"direction",function(a){b.direction=j(new BulletML.Direction,a)});g(c,"speed",function(a){b.speed=j(new BulletML.Speed,a)});g(c,"bullet",function(c){b.bullet=v(a,c)});g(c,"bulletref",function(c){var e=new BulletML.BulletRef;i(c,"label",function(a){e.label=
a});m(c,/param$/,function(a){e.params[e.params.length]=h(a)});e.root=a;b.bullet=e});if(!b.bullet)throw Error("fire has no bullet or bulletRef.");b.root=a;return b}function j(a,c){i(c,"type",function(b){a.type=b});h(c,function(b){a.value=b});return a}function k(a,c){for(var b=0,d=a.length;b<d;b++)if(a[b].label==c)return a[b]}function g(a,c,b,d){for(var c=c.toLowerCase(),a=a.childNodes,e=0,f=a.length;e<f;e++)if(a[e].tagName&&a[e].tagName.toLowerCase()==c)return b&&b(a[e]),b(a[e]);d&&d()}function m(a,
c,b){console.log("element",a);console.log("filter",c);for(var a=a.childNodes,d=0,e=a.length;d<e;d++)console.log("tagName = ["+a[d].tagName+"]"),a[d].tagName&&a[d].tagName.toLowerCase().match(c)?(console.log("   -> match! "+a[d].tagName.toLowerCase()),b(a[d])):console.log("   -> unmatch!")}function i(a,c,b,d){if(a=a.attributes[c])return b&&b(a.value),a;d&&d()}function h(a,c){var b=a.textContent;if(void 0!==b||a.childNodes[0]&&(b=a.childNodes[0].nodeValue,void 0!==b))return c&&c(b),b}BulletML.build=
function(a){if("string"==typeof a)var c=new DOMParser,a=u(c.parseFromString(a,"application/xml"));else if(a.getElementsByTagName("bulletml"))a=u(a);else throw Error("cannot build "+a);return a};BulletML.Root=function(a){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[];if(a){for(var c in a)a.hasOwnProperty(c)&&(a[c].label=c,a[c]instanceof BulletML.Action?this.actions.push(a[c]):a[c]instanceof BulletML.Bullet?this.bullets.push(a[c]):a[c]instanceof BulletML.Fire&&this.fires.push(a[c]));
this.setRoot(this)}};BulletML.Root.prototype.findAction=function(a){return k(this.actions,a)};BulletML.Root.prototype.getTopActionLabels=function(){for(var a=[],c=0,b=this.actions.length;c<b;c++){var d=this.actions[c];d.label&&0===d.label.indexOf("top")&&(a[a.length]=d.label)}return a};BulletML.Root.prototype.findActionOrThrow=function(a){var c;if(c=this.findAction(a))return c;throw Error("action labeled '"+a+"' is undefined.");};BulletML.Root.prototype.findBullet=function(a){return k(this.bullets,
a)};BulletML.Root.prototype.findBulletOrThrow=function(a){var c;if(c=this.findBullet(a))return c;throw Error("bullet labeled '"+a+"' is undefined.");};BulletML.Root.prototype.findFire=function(a){return k(this.fires,a)};BulletML.Root.prototype.findFireOrThrow=function(a){var c;if(c=this.findFire(a))return c;throw Error("fire labeled '"+a+"' is undefined.");};BulletML.Root.prototype.getWalker=function(a,c){var b=new BulletML.Walker(this,c),d=this.findAction(a);if(d)return b._action=d,b};BulletML.Root.prototype.setRoot=
function(){for(var a=0,c=this.actions.length;a<c;a++)this.actions[a].setRoot(this);a=0;for(c=this.bullets.length;a<c;a++)this.bullets[a].setRoot(this);a=0;for(c=this.fires.length;a<c;a++)this.fires[a].setRoot(this)};BulletML.Walker=function(a,c){this._root=a;this._stack=[];this._cursor=-1;this._action=null;this._localScope={};this._globalScope={$rank:c||0}};BulletML.Walker.prototype.next=function(){this._cursor+=1;if(this._action){var a=this._action.commands[this._cursor];if(a){var c={commandName:a.commandName};
switch(a.commandName){case "action":return this.pushStack(),this._action=a,this._localScope=this.newScope(a.params),this.next();case "actionRef":return this.pushStack(),this._action=this._root.findActionOrThrow(a.label),this._localScope=this.newScope(a.params),this.next();case "repeat":return this._localScope.loopCounter=0,this._localScope.loopEnd=this.eval(a.times),this.pushStack(),this._action={commandName:"action",commands:[a.action]},this._localScope=this.newScope(a.params),this.next();case "fire":c.bullet=
a.bullet.clone(this);a.direction&&(c.direction={type:a.direction.type,value:this.eval(a.direction.value)});a.speed&&(c.speed={type:a.speed.type,value:this.eval(a.speed.value)});break;case "fireRef":return this.pushStack(),this._action={commandName:"action",commands:[this._root.findFireOrThrow(a.label)]},this._localScope=this.newScope(a.params),this.next();case "changeDirection":a.direction&&(c.direction={type:a.direction.type,value:this.eval(a.direction.value)});a.term&&(c.term=this.eval(a.term));
break;case "changeSpeed":a.speed&&(c.speed={type:a.speed.type,value:this.eval(a.speed.value)});a.term&&(c.term=this.eval(a.term));break;case "accel":a.horizontal&&(c.horizontal={type:a.horizontal.type,value:this.eval(a.horizontal.value)});a.vertical&&(c.vertical={type:a.vertical.type,value:this.eval(a.vertical.value)});a.term&&(c.term=this.eval(a.term));break;case "wait":c.value=this.eval(a.value)}return c}this.popStack();if(null!==this._action){if((a=this._action.commands[this._cursor])&&"repeat"==
a.commandName)this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this.pushStack(),this._action={commandName:"action",commands:[a.action]},this._localScope=this.newScope(a.params));return this.next()}}};BulletML.Walker.prototype.pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};BulletML.Walker.prototype.popStack=function(){var a=this._stack.pop();a?(this._cursor=a.cursor,this._action=a.action,
this._localScope=a.scope):(this._cursor=-1,this._action=null,this._localScope={})};BulletML.Walker.prototype.eval=function(a){var c;if("number"==typeof a)return a;if(isNaN(c=Number(a))){if((c=this._localScope[a])||(c=this._globalScope[a]))return c;if("$rand"==a)return Math.random()}else return c;c={};for(var b in this._globalScope)this._globalScope.hasOwnProperty(b)&&(c[b]=this._globalScope[b]);for(b in this._localScope)this._localScope.hasOwnProperty(b)&&(c[b]=this._localScope[b]);c.$rand=Math.random();
return eval("BulletML._temp = function() { return "+a.split("$").join("this.$")+"}").bind(c)()};BulletML.Walker.prototype.newScope=function(a){var c={};if(a)for(var b=0,d=a.length;b<d;b++)c["$"+(b+1)]=this.eval(a[b]);else for(b in this._localScope)this._localScope.hasOwnProperty(b)&&(c[b]=this._localScope[b]);return c};BulletML.Bullet=function(){this.root=this.label=null;this.direction=new BulletML.Direction(0);this.speed=new BulletML.Speed(1);this.actions=[];this._localScope={}};BulletML.Bullet.prototype.getWalker=
function(a){var a=new BulletML.Walker(this.root,a),c=new BulletML.Action;c.root=this.root;c.commands=this.actions;a._action=c;a._localScope=this._localScope;return a};BulletML.Bullet.prototype.clone=function(a){var c=new BulletML.Bullet;c.label=this.label;c.root=this.root;c.actions=this.actions;c.direction={type:this.direction.type,value:a.eval(this.direction.value)};c.speed={type:this.speed.type,value:a.eval(this.speed.value)};c._localScope=a._localScope;return c};BulletML.Bullet.prototype.setRoot=
function(a){this.root=a;for(var c=0,b=this.actions.length;c<b;c++)this.actions[c].setRoot(a)};BulletML.BulletRef=function(){this.label=this.root=null;this.params=[]};BulletML.BulletRef.prototype.clone=function(a){var c=a._localScope;a._localScope=a.newScope(this.params);var b=this.root.findBulletOrThrow(this.label).clone(a);a._localScope=c;return b};BulletML.BulletRef.prototype.setRoot=function(a){this.root=a};BulletML.Command=function(){this.commandName=null};BulletML.Command.prototype.setRoot=function(a){this.root=
a};BulletML.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[]};BulletML.Action.prototype=new BulletML.Command;BulletML.Action.prototype.setRoot=function(a){this.root=a;for(var c=0,b=this.commands.length;c<b;c++)this.commands[c].setRoot(a)};BulletML.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=[]};BulletML.ActionRef.prototype=new BulletML.Command;BulletML.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=
this.root=this.label=null};BulletML.Fire.prototype=new BulletML.Command;BulletML.Fire.prototype.setRoot=function(a){this.root=a;this.bullet&&this.bullet.setRoot(a)};BulletML.FireRef=function(){this.commandName="fireRef";this.label=null;this.params=[]};BulletML.FireRef.prototype=new BulletML.Command;BulletML.ChangeDirection=function(){this.commandName="changeDirection";this.direction=null;this.term=0};BulletML.ChangeDirection.prototype=new BulletML.Command;BulletML.ChangeSpeed=function(){this.commandName=
"changeSpeed";this.speed=null;this.term=0};BulletML.ChangeSpeed.prototype=new BulletML.Command;BulletML.Accel=function(){this.commandName="accel";this.vertical=this.horizontal=null;this.term=0};BulletML.Accel.prototype=new BulletML.Command;BulletML.Wait=function(a){this.commandName="wait";this.value=a?a:0};BulletML.Wait.prototype=new BulletML.Command;BulletML.Vanish=function(){this.commandName="vanish"};BulletML.Vanish.prototype=new BulletML.Command;BulletML.Repeat=function(){this.commandName="repeat";
this.times=0;this.action=null};BulletML.Repeat.prototype=new BulletML.Command;BulletML.Repeat.prototype.setRoot=function(a){this.root=a;this.action&&this.action.setRoot(a)};BulletML.Direction=function(a){this.type="aim";this.value=a?a:0};BulletML.Speed=function(a){this.type="absolute";this.value=a?a:1};BulletML.Horizontal=function(a){this.type="absolute";this.value=a?a:0};BulletML.Vertical=function(a){this.type="absolute";this.value=a?a:0};BulletML.dsl=function(){for(var a in BulletML.dsl)BulletML.dsl.hasOwnProperty(a)&&
(BulletML.global[a]=BulletML.dsl[a])};BulletML.dsl.action=function(a){for(var c=0,b=arguments.length;c<b;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());var d=new BulletML.Action;if(a instanceof Array){if(a.some(function(a){return!(a instanceof BulletML.Command)}))throw Error("argument type error.");d.commands=a}else{c=0;for(b=arguments.length;c<b;c++)if(arguments[c]instanceof BulletML.Command)d.commands[c]=arguments[c];else throw Error("argument type error.");}return d};BulletML.dsl.actionRef=
function(a,c){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("label is required.");d=new BulletML.ActionRef;d.label=""+a;if(c instanceof Array)d.params=c;else for(b=1;b<arguments.length;b++)d.params.push(arguments[b]);return d};BulletML.dsl.bullet=function(a,c,b,d){for(var e=0,f=arguments.length;e<f;e++)arguments[e]instanceof Function&&(arguments[e]=arguments[e]());f=new BulletML.Bullet;for(e=0;e<arguments.length;e++)arguments[e]instanceof
BulletML.Direction?f.direction=arguments[e]:arguments[e]instanceof BulletML.Speed?f.speed=arguments[e]:arguments[e]instanceof BulletML.Action?f.actions.push(arguments[e]):arguments[e]instanceof BulletML.ActionRef?f.actions.push(arguments[e]):"string"===typeof arguments[e]&&(f.label=arguments[e]);return f};BulletML.dsl.bulletRef=function(a,c){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("label is required.");d=new BulletML.BulletRef;
d.label=""+a;if(c instanceof Array)d.params=c;else for(b=1;b<arguments.length;b++)d.params.push(arguments[b]);return d};BulletML.dsl.fire=function(a,c,b){for(var d=0,e=arguments.length;d<e;d++)arguments[d]instanceof Function&&(arguments[d]=arguments[d]());e=new BulletML.Fire;for(d=0;d<arguments.length;d++)arguments[d]instanceof BulletML.Direction?e.direction=arguments[d]:arguments[d]instanceof BulletML.Speed?e.speed=arguments[d]:arguments[d]instanceof BulletML.Bullet?e.bullet=arguments[d]:arguments[d]instanceof
BulletML.BulletRef&&(e.bullet=arguments[d]);if(void 0==e.bullet)throw Error("bullet (or bulletRef) is required.");return e};BulletML.dsl.fireRef=function(a,c){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("label is required.");d=new BulletML.FireRef;d.label=""+a;if(c instanceof Array)d.params=c;else for(b=1;b<arguments.length;b++)d.params.push(arguments[b]);return d};BulletML.dsl.changeDirection=function(a,c){for(var b=
0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("direction is required.");if(void 0==c)throw Error("term is required.");b=new BulletML.ChangeDirection;b.direction=a instanceof BulletML.Direction?a:new BulletML.Direction(a);b.term=c;return b};BulletML.dsl.changeSpeed=function(a,c){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("speed is required.");if(void 0==
c)throw Error("term is required.");b=new BulletML.ChangeSpeed;b.speed=a instanceof BulletML.Speed?a:new BulletML.Speed(a);b.term=c;return b};BulletML.dsl.accel=function(a,c,b){for(var d=0,e=arguments.length;d<e;d++)arguments[d]instanceof Function&&(arguments[d]=arguments[d]());e=new BulletML.Accel;for(d=0;d<arguments.length;d++)arguments[d]instanceof BulletML.Horizontal?e.horizontal=a:arguments[d]instanceof BulletML.Vertical?e.vertical=c:e.term=arguments[d];if(void 0==e.horizontal&&void 0==e.vertical)throw Error("horizontal or vertical is required.");
if(void 0==e.term)throw Error("term is required.");return e};BulletML.dsl.wait=function(a){for(var c=0,b=arguments.length;c<b;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0==a)throw Error("value is required.");return new BulletML.Wait(a)};BulletML.dsl.vanish=function(){return new BulletML.Vanish};BulletML.dsl.repeat=function(a,c){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("times is required.");
if(void 0==c)throw Error("action is required.");b=new BulletML.Repeat;b.times=a;c instanceof BulletML.Action||c instanceof BulletML.ActionRef?b.action=c:c instanceof Array&&(b.action=BulletML.dsl.action(c));return b};BulletML.dsl.direction=function(a,c){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("value is required.");b=new BulletML.Direction(a);c&&(b.type=c);return b};BulletML.dsl.speed=function(a,c){for(var b=0,d=
arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("value is required.");b=new BulletML.Speed(a);c&&(b.type=c);return b};BulletML.dsl.horizontal=function(a,c){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("value is required.");b=new BulletML.Horizontal(a);c&&(b.type=c);return b};BulletML.dsl.vertical=function(a,c){for(var b=0,d=arguments.length;b<d;b++)arguments[b]instanceof
Function&&(arguments[b]=arguments[b]());if(void 0==a)throw Error("value is required.");b=new BulletML.Vertical(a);c&&(b.type=c);return b}})();
