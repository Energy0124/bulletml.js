var BulletML={};
(function(){function u(a){var b=new BulletML.Root,c=a.getElementsByTagName("bulletml")[0];if(c){i(c,"type",function(a){b.type=a});var e=c.getElementsByTagName("action");if(e)for(var a=0,d=e.length;a<d;a++){var f=q(b,e[a]);f&&(b.actions[b.actions.length]=f)}if(e=c.getElementsByTagName("bullet")){a=0;for(d=e.length;a<d;a++)(f=v(b,e[a]))&&(b.bullets[b.bullets.length]=f)}if(c=c.getElementsByTagName("fire")){a=0;for(d=c.length;a<d;a++)(e=w(b,c[a]))&&(b.fires[b.fires.length]=e)}return b}}function q(a,b){var c=
new BulletML.Action;i(b,"label",function(a){c.label=a});m(b,".",function(b){switch(b.tagName){case "action":c.commands[c.commands.length]=q(a,b);break;case "actionRef":c.commands[c.commands.length]=t(a,b);break;case "fire":c.commands[c.commands.length]=w(a,b);break;case "fireRef":var d=c.commands,f=c.commands.length,l=new BulletML.FireRef;i(b,"label",function(a){l.label=a});m(b,/param$/,function(a){l.params[l.params.length]=h(a)});l.root=a;d[f]=l;break;case "changeDirection":var d=c.commands,f=c.commands.length,
r=new BulletML.ChangeDirection;r.root=a;g(b,"direction",function(a){r.direction=j(new BulletML.Direction,a)});g(b,"term",function(a){r.term=h(a)});d[f]=r;break;case "changeSpeed":var d=c.commands,f=c.commands.length,s=new BulletML.ChangeSpeed;s.root=a;g(b,"speed",function(a){s.speed=j(new BulletML.Speed,a)});g(b,"term",function(a){s.term=h(a)});d[f]=s;break;case "accel":var d=c.commands,f=c.commands.length,n=new BulletML.Accel;n.root=a;g(b,"horizontal",function(a){n.horizontal=j(new BulletML.Horizontal,
a)});g(b,"vertical",function(a){n.vertical=j(new BulletML.Vertical,a)});g(b,"term",function(a){n.term=h(a)});d[f]=n;break;case "wait":var d=c.commands,f=c.commands.length,k=new BulletML.Wait;k.root=a;k.value=h(b);d[f]=k;break;case "vanish":b=c.commands;d=c.commands.length;f=new BulletML.Vanish;f.root=a;b[d]=f;break;case "repeat":var d=c.commands,f=c.commands.length,p=new BulletML.Repeat;g(b,"action",function(b){p.action=q(a,b)});g(b,"actionRef",function(b){p.action=t(a,b)});g(b,"times",function(a){p.times=
h(a)});p.root=a;d[f]=p}});c.root=a;return c}function t(a,b){var c=new BulletML.ActionRef;i(b,"label",function(a){c.label=a});m(b,/param$/,function(a){c.params[c.params.length]=h(a)});c.root=a;return c}function v(a,b){var c=new BulletML.Bullet;i(b,"label",function(a){c.label=a});g(b,"direction",function(a){c.direction=j(new BulletML.Direction,a)});g(b,"speed",function(a){c.speed=j(new BulletML.Speed,a)});m(b,/(action)|(actionRef)$/,function(b){"action"==b.tagName?c.actions[c.actions.length]=q(a,b):
"actionRef"==b.tagName&&(c.actions[c.actions.length]=t(a,b))});c.root=a;return c}function w(a,b){var c=new BulletML.Fire;i(b,"label",function(a){c.label=a});g(b,"direction",function(a){c.direction=j(new BulletML.Direction,a)});g(b,"speed",function(a){c.speed=j(new BulletML.Speed,a)});g(b,"bullet",function(b){c.bullet=v(a,b)});g(b,"bulletRef",function(b){var d=new BulletML.BulletRef;i(b,"label",function(a){d.label=a});m(b,/param$/,function(a){d.params[d.params.length]=h(a)});d.root=a;c.bullet=d});
if(!c.bullet)throw Error("fire has no bullet or bulletRef.");c.root=a;return c}function j(a,b){i(b,"type",function(b){a.type=b});h(b,function(b){a.value=b});return a}function k(a,b){for(var c=0,e=a.length;c<e;c++)if(a[c].label==b)return a[c]}function g(a,b,c,e){for(var a=a.childNodes,d=0,f=a.length;d<f;d++)if(a[d].tagName&&a[d].tagName==b)return c&&c(a[d]),c(a[d]);e&&e()}function m(a,b,c){for(var a=a.childNodes,e=0,d=a.length;e<d;e++)a[e].tagName&&a[e].tagName.match(b)&&c(a[e])}function i(a,b,c,e){if(a=
a.attributes[b])return c&&c(a.value),a;e&&e()}function h(a,b){var c=a.textContent;if(void 0!==c||a.childNodes[0]&&(c=a.childNodes[0].nodeValue,void 0!==c))return b&&b(c),c}BulletML.build=function(a){if("string"==typeof a)var b=new DOMParser,a=u(b.parseFromString(a,"application/xml"));else if(a.getElementsByTagName("bulletml"))a=u(a);else throw Error("cannot build "+a);return a};BulletML.Root=function(){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[]};BulletML.Root.prototype.findAction=
function(a){return k(this.actions,a)};BulletML.Root.prototype.findActionOrThrow=function(a){var b;if(b=this.findAction(a))return b;throw Error("action labeled '"+a+"' is undefined.");};BulletML.Root.prototype.findBullet=function(a){return k(this.bullets,a)};BulletML.Root.prototype.findBulletOrThrow=function(a){var b;if(b=this.findBullet(a))return b;throw Error("bullet labeled '"+a+"' is undefined.");};BulletML.Root.prototype.findFire=function(a){return k(this.fires,a)};BulletML.Root.prototype.findFireOrThrow=
function(a){var b;if(b=this.findFire(a))return b;throw Error("fire labeled '"+a+"' is undefined.");};BulletML.Root.prototype.getWalker=function(a,b){var c=new BulletML.Walker(this,b),e=this.findAction(a);if(e)return c._action=e,c};BulletML.Walker=function(a,b){this._root=a;this._stack=[];this._cursor=-1;this._action=null;this._localScope={};this._globalScope={$rank:b||0}};BulletML.Walker.prototype.next=function(){this._cursor+=1;if(this._action){var a=this._action.commands[this._cursor];if(a){var b=
{commandName:a.commandName};switch(a.commandName){case "action":return this.pushStack(),this._action=a,this._localScope=this.newScope(a.params),this.next();case "actionRef":return this.pushStack(),this._action=this._root.findActionOrThrow(a.label),this._localScope=this.newScope(a.params),this.next();case "repeat":return this._localScope.loopCounter=0,this._localScope.loopEnd=this.eval(a.times),this.pushStack(),this._action={commandName:"action",commands:[a.action]},this._localScope=this.newScope(a.params),
this.next();case "fire":b.bullet=a.bullet.clone(this);a.direction&&(b.direction={type:a.direction.type,value:this.eval(a.direction.value)});a.speed&&(b.speed={type:a.speed.type,value:this.eval(a.speed.value)});break;case "fireRef":return this.pushStack(),this._action={commandName:"action",commands:[this._root.findFireOrThrow(a.label)]},this._localScope=this.newScope(a.params),this.next();case "changeDirection":a.direction&&(b.direction={type:a.direction.type,value:this.eval(a.direction.value)});a.term&&
(b.term=this.eval(a.term));break;case "changeSpeed":a.speed&&(b.speed={type:a.speed.type,value:this.eval(a.speed.value)});a.term&&(b.term=this.eval(a.term));break;case "accel":a.horizontal&&(b.horizontal={type:a.horizontal.type,value:this.eval(a.horizontal.value)});a.vertical&&(b.vertical={type:a.vertical.type,value:this.eval(a.vertical.value)});a.term&&(b.term=this.eval(a.term));break;case "wait":b.value=this.eval(a.value)}return b}this.popStack();if(this._action){if((a=this._action.commands[this._cursor])&&
"repeat"==a.commandName)this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this.pushStack(),this._action={commandName:"action",commands:[a.action]},this._localScope=this.newScope(a.params));return this.next()}}};BulletML.Walker.prototype.pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};BulletML.Walker.prototype.popStack=function(){var a=this._stack.pop();a?(this._cursor=a.cursor,this._action=
a.action,this._localScope=a.scope):(this._cursor=-1,this._action=null,this._localScope={})};BulletML.Walker.prototype.eval=function(a){var b;if("number"==typeof a)return a;if(isNaN(b=Number(a))){if((b=this._localScope[a])||(b=this._globalScope[a]))return b;if("$rand"==a)return Math.random()}else return b;b={};for(var c in this._globalScope)this._globalScope.hasOwnProperty(c)&&(b[c]=this._globalScope[c]);for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(b[c]=this._localScope[c]);b.$rand=
Math.random();return eval("BulletML._temp = function() { return "+a.split("$").join("this.$")+"}").bind(b)()};BulletML.Walker.prototype.newScope=function(a){var b={};if(a)for(var c=0,e=a.length;c<e;c++)b["$"+(c+1)]=this.eval(a[c]);else for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(b[c]=this._localScope[c]);return b};BulletML.Bullet=function(){this.root=this.label=null;this.direction=new BulletML.Direction(0);this.speed=new BulletML.Speed(1);this.actions=[];this._localScope={}};BulletML.Bullet.prototype.getWalker=
function(a){var a=new BulletML.Walker(this.root,a),b=new BulletML.Action;b.root=this.root;b.commands=this.actions;a._action=b;a._localScope=this._localScope;return a};BulletML.Bullet.prototype.clone=function(a){var b=new BulletML.Bullet;b.label=this.label;b.root=this.root;b.actions=this.actions;b.direction={type:this.direction.type,value:a.eval(this.direction.value)};b.speed={type:this.speed.type,value:a.eval(this.speed.value)};b._localScope=a._localScope;return b};BulletML.BulletRef=function(){this.label=
this.root=null;this.params=[]};BulletML.BulletRef.prototype.clone=function(a){var b=a._localScope;a._localScope=a.newScope(this.params);var c=this.root.findBulletOrThrow(this.label).clone(a);a._localScope=b;return c};BulletML.Command=function(){this.commandName=null};BulletML.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[]};BulletML.Action.prototype=new BulletML.Command;BulletML.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=
[]};BulletML.ActionRef.prototype=new BulletML.Command;BulletML.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=this.root=this.label=null};BulletML.Fire.prototype=new BulletML.Command;BulletML.FireRef=function(){this.commandName="fireRef";this.label=null;this.params=[]};BulletML.FireRef.prototype=new BulletML.Command;BulletML.ChangeDirection=function(){this.commandName="changeDirection";this.direction=null;this.term=0};BulletML.ChangeDirection.prototype=new BulletML.Command;
BulletML.ChangeSpeed=function(){this.commandName="changeSpeed";this.speed=null;this.term=0};BulletML.ChangeSpeed.prototype=new BulletML.Command;BulletML.Accel=function(){this.commandName="accel";this.vertical=this.horizontal=null;this.term=0};BulletML.Accel.prototype=new BulletML.Command;BulletML.Wait=function(a){this.commandName="wait";this.value=a?a:0};BulletML.Wait.prototype=new BulletML.Command;BulletML.Vanish=function(){this.commandName="vanish"};BulletML.Vanish.prototype=new BulletML.Command;
BulletML.Repeat=function(){this.commandName="repeat";this.times=0;this.action=null};BulletML.Repeat.prototype=new BulletML.Command;BulletML.Direction=function(a){this.type="aim";this.value=a?a:0};BulletML.Speed=function(a){this.type="absolute";this.value=a?a:1};BulletML.Horizontal=function(a){this.type="absolute";this.value=a?a:0};BulletML.Vertical=function(a){this.type="absolute";this.value=a?a:0}})();
