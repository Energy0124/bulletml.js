var BulletML={};
(function(){function h(b){var a=new BulletML.Root,g=b.getElementsByTagName("bulletml")[0];if(g){k(g,"type",function(b){a.type=b});var m=g.getElementsByTagName("action");if(m)for(var b=0,e=m.length;b<e;b++){var f=n(a,m[b]);f&&(a.actions[a.actions.length]=f)}if(m=g.getElementsByTagName("bullet")){b=0;for(e=m.length;b<e;b++)(f=c(a,m[b]))&&(a.bullets[a.bullets.length]=f)}if(g=g.getElementsByTagName("fire")){b=0;for(e=g.length;b<e;b++)(m=d(a,g[b]))&&(a.fires[a.fires.length]=m)}return a}}function n(b,a){var g=
new BulletML.Action;k(a,"label",function(b){g.label=b});j(a,".",function(a){switch(a.tagName){case "action":g.commands[g.commands.length]=n(b,a);break;case "actionRef":g.commands[g.commands.length]=p(b,a);break;case "fire":g.commands[g.commands.length]=d(b,a);break;case "fireRef":var c=g.commands,i=g.commands.length,h=new BulletML.FireRef;k(a,"label",function(b){h.label=b});j(a,/param$/,function(b){h.params[h.params.length]=l(b)});h.root=b;c[i]=h;break;case "changeDirection":var c=g.commands,i=g.commands.length,
s=new BulletML.ChangeDirection;s.root=b;f(a,"direction",function(b){s.direction=e(new BulletML.Direction,b)});f(a,"term",function(b){s.term=l(b)});c[i]=s;break;case "changeSpeed":var c=g.commands,i=g.commands.length,t=new BulletML.ChangeSpeed;t.root=b;f(a,"speed",function(b){t.speed=e(new BulletML.Speed,b)});f(a,"term",function(b){t.term=l(b)});c[i]=t;break;case "accel":var c=g.commands,i=g.commands.length,q=new BulletML.Accel;q.root=b;f(a,"horizontal",function(b){q.horizontal=e(new BulletML.Horizontal,
b)});f(a,"vertical",function(b){q.vertical=e(new BulletML.Vertical,b)});f(a,"term",function(b){q.term=l(b)});c[i]=q;break;case "wait":var c=g.commands,i=g.commands.length,u=new BulletML.Wait;u.root=b;u.value=l(a);c[i]=u;break;case "vanish":a=g.commands;c=g.commands.length;i=new BulletML.Vanish;i.root=b;a[c]=i;break;case "repeat":var c=g.commands,i=g.commands.length,r=new BulletML.Repeat;f(a,"action",function(a){r.action=n(b,a)});f(a,"actionRef",function(a){r.action=p(b,a)});f(a,"times",function(b){r.times=
l(b)});r.root=b;c[i]=r}});g.root=b;return g}function p(b,a){var c=new BulletML.ActionRef;k(a,"label",function(b){c.label=b});j(a,/param$/,function(b){c.params[c.params.length]=l(b)});c.root=b;return c}function c(b,a){var c=new BulletML.Bullet;k(a,"label",function(b){c.label=b});f(a,"direction",function(b){c.direction=e(new BulletML.Direction,b)});f(a,"speed",function(b){c.speed=e(new BulletML.Speed,b)});j(a,/(action)|(actionRef)$/,function(a){"action"==a.tagName?c.actions[c.actions.length]=n(b,a):
"actionRef"==a.tagName&&(c.actions[c.actions.length]=p(b,a))});c.root=b;return c}function d(b,a){var g=new BulletML.Fire;k(a,"label",function(b){g.label=b});f(a,"direction",function(b){g.direction=e(new BulletML.Direction,b)});f(a,"speed",function(b){g.speed=e(new BulletML.Speed,b)});f(a,"bullet",function(a){g.bullet=c(b,a)});f(a,"bulletRef",function(a){var c=new BulletML.BulletRef;k(a,"label",function(b){c.label=b});j(a,/param$/,function(b){c.params[c.params.length]=l(b)});c.root=b;g.bullet=c});
if(!g.bullet)throw Error("fire has no bullet or bulletRef.");g.root=b;return g}function e(b,a){k(a,"type",function(a){b.type=a});l(a,function(a){b.value=a});return b}function a(b,a){for(var c=0,d=b.length;c<d;c++)if(b[c].label==a)return b[c]}function f(b,a,c,d){for(var b=b.childNodes,e=0,f=b.length;e<f;e++)if(b[e].tagName&&b[e].tagName==a)return c&&c(b[e]),c(b[e]);d&&d()}function j(b,a,c){for(var b=b.childNodes,d=0,e=b.length;d<e;d++)b[d].tagName&&b[d].tagName.match(a)&&c(b[d])}function k(b,a,c,d){if(b=
b.attributes[a])return c&&c(b.value),b;d&&d()}function l(b,a){var c=b.textContent;if(void 0!==c||b.childNodes[0]&&(c=b.childNodes[0].nodeValue,void 0!==c))return a&&a(c),c}BulletML.build=function(b){if("string"==typeof b)var a=new DOMParser,b=h(a.parseFromString(b,"application/xml"));else if(b.getElementsByTagName("bulletml"))b=h(b);else throw Error("cannot build "+b);return b};BulletML.Root=function(){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[]};BulletML.Root.prototype.findAction=
function(b){return a(this.actions,b)};BulletML.Root.prototype.findActionOrThrow=function(b){var a;if(a=this.findAction(b))return a;throw Error("action labeled '"+b+"' is undefined.");};BulletML.Root.prototype.findBullet=function(b){return a(this.bullets,b)};BulletML.Root.prototype.findBulletOrThrow=function(b){var a;if(a=this.findBullet(b))return a;throw Error("bullet labeled '"+b+"' is undefined.");};BulletML.Root.prototype.findFire=function(b){return a(this.fires,b)};BulletML.Root.prototype.findFireOrThrow=
function(b){var a;if(a=this.findFire(b))return a;throw Error("fire labeled '"+b+"' is undefined.");};BulletML.Root.prototype.getWalker=function(b,a){var c=new BulletML.Walker(this,a),d=this.findAction(b);if(d)return c._action=d,c};BulletML.Walker=function(b,a){this._root=b;this._stack=[];this._cursor=-1;this._action=null;this._localScope={};this._globalScope={$rank:a||0}};BulletML.Walker.prototype.next=function(){this._cursor+=1;if(this._action){var b=this._action.commands[this._cursor];if(b){var a=
{commandName:b.commandName};switch(b.commandName){case "action":return this.pushStack(),this._action=b,this._localScope=this.newScope(b.params),this.next();case "actionRef":return this.pushStack(),this._action=this._root.findActionOrThrow(b.label),this._localScope=this.newScope(b.params),this.next();case "repeat":return this._localScope.loopCounter=0,this._localScope.loopEnd=this.eval(b.times),this.pushStack(),this._action={commandName:"action",commands:[b.action]},this._localScope=this.newScope(b.params),
this.next();case "fire":a.bullet=b.bullet.clone(this);b.direction&&(a.direction={type:b.direction.type,value:this.eval(b.direction.value)});b.speed&&(a.speed={type:b.speed.type,value:this.eval(b.speed.value)});break;case "fireRef":return this.pushStack(),this._action={commandName:"action",commands:[this._root.findFireOrThrow(b.label)]},this._localScope=this.newScope(b.params),this.next();case "changeDirection":b.direction&&(a.direction={type:b.direction.type,value:this.eval(b.direction.value)});b.term&&
(a.term=this.eval(b.term));break;case "changeSpeed":b.speed&&(a.speed={type:b.speed.type,value:this.eval(b.speed.value)});b.term&&(a.term=this.eval(b.term));break;case "accel":b.horizontal&&(a.horizontal={type:b.horizontal.type,value:this.eval(b.horizontal.value)});b.vertical&&(a.vertical={type:b.vertical.type,value:this.eval(b.vertical.value)});b.term&&(a.term=this.eval(b.term));break;case "wait":a.value=this.eval(b.value)}return a}this.popStack();if(this._action){if((b=this._action.commands[this._cursor])&&
"repeat"==b.commandName)this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this.pushStack(),this._action={commandName:"action",commands:[b.action]},this._localScope=this.newScope(b.params));return this.next()}}};BulletML.Walker.prototype.pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};BulletML.Walker.prototype.popStack=function(){var b=this._stack.pop();b?(this._cursor=b.cursor,this._action=
b.action,this._localScope=b.scope):(this._cursor=-1,this._action=null,this._localScope={})};BulletML.Walker.prototype.eval=function(b){var a;if("number"==typeof b)return b;if(isNaN(a=Number(b))){if((a=this._localScope[b])||(a=this._globalScope[b]))return a;if("$rand"==b)return Math.random()}else return a;a={};for(var c in this._globalScope)this._globalScope.hasOwnProperty(c)&&(a[c]=this._globalScope[c]);for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(a[c]=this._localScope[c]);a.$rand=
Math.random();return eval("BulletML._temp = function() { return "+b.split("$").join("this.$")+"}").bind(a)()};BulletML.Walker.prototype.newScope=function(b){var a={};if(b)for(var c=0,d=b.length;c<d;c++)a["$"+(c+1)]=this.eval(b[c]);else for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(a[c]=this._localScope[c]);return a};BulletML.Bullet=function(){this.root=this.label=null;this.direction=new BulletML.Direction(0);this.speed=new BulletML.Speed(1);this.actions=[];this._localScope={}};BulletML.Bullet.prototype.getWalker=
function(b){var b=new BulletML.Walker(this.root,b),a=new BulletML.Action;a.root=this.root;a.commands=this.actions;b._action=a;b._localScope=this._localScope;return b};BulletML.Bullet.prototype.clone=function(b){var a=new BulletML.Bullet;a.label=this.label;a.root=this.root;a.actions=this.actions;a.direction={type:this.direction.type,value:b.eval(this.direction.value)};a.speed={type:this.speed.type,value:b.eval(this.speed.value)};a._localScope=b._localScope;return a};BulletML.BulletRef=function(){this.label=
this.root=null;this.params=[]};BulletML.BulletRef.prototype.clone=function(a){var c=a._localScope;a._localScope=a.newScope(this.params);var d=this.root.findBulletOrThrow(this.label).clone(a);a._localScope=c;return d};BulletML.Command=function(){this.commandName=null};BulletML.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[]};BulletML.Action.prototype=new BulletML.Command;BulletML.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=
[]};BulletML.ActionRef.prototype=new BulletML.Command;BulletML.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=this.root=this.label=null};BulletML.Fire.prototype=new BulletML.Command;BulletML.FireRef=function(){this.commandName="fireRef";this.label=null;this.params=[]};BulletML.FireRef.prototype=new BulletML.Command;BulletML.ChangeDirection=function(){this.commandName="changeDirection";this.direction=null;this.term=0};BulletML.ChangeDirection.prototype=new BulletML.Command;
BulletML.ChangeSpeed=function(){this.commandName="changeSpeed";this.speed=null;this.term=0};BulletML.ChangeSpeed.prototype=new BulletML.Command;BulletML.Accel=function(){this.commandName="accel";this.vertical=this.horizontal=null;this.term=0};BulletML.Accel.prototype=new BulletML.Command;BulletML.Wait=function(a){this.commandName="wait";this.value=a?a:0};BulletML.Wait.prototype=new BulletML.Command;BulletML.Vanish=function(){this.commandName="vanish"};BulletML.Vanish.prototype=new BulletML.Command;
BulletML.Repeat=function(){this.commandName="repeat";this.times=0;this.action=null};BulletML.Repeat.prototype=new BulletML.Command;BulletML.Direction=function(a){this.type="aim";this.value=a?a:0};BulletML.Speed=function(a){this.type="absolute";this.value=a?a:1};BulletML.Horizontal=function(a){this.type="absolute";this.value=a?a:0};BulletML.Vertical=function(a){this.type="absolute";this.value=a?a:0}})();(function(){function h(c){return c*Math.PI/180}function n(c){for(;c<=-Math.PI;)c+=2*Math.PI;for(;Math.PI<c;)c-=2*Math.PI;return c}function p(c,d){return Math.atan2(d.y+(d.height||0)/2-(c.y+(c.height||0)/2),d.x+(d.width||0)/2-(c.x+(c.width||0)/2))}enchant.Game._loadFuncs.bml=function(c,d){var e=this,a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState){if(200!==a.status&&0!==a.status)throw Error(a.status+": Cannot load an asset: "+c);if(null!=a.responseXML){var f=BulletML.build(a.responseXML);
f?e.assets[c]=new enchant.bulletml.AttackPattern(f):(console.warn(c+"\u306f\u59a5\u5f53\u306aBulletML\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002"),e.assets[c]=a.responseXML);d()}else if(null!=a.responseText)e.assets[c]=BulletML.build(a.responseText),d();else throw Error(a.status+": Cannot load an asset: "+c);}};a.open("GET",c,!0);a.overrideMimeType&&a.overrideMimeType("application/xml");a.send(null)};enchant.EventTarget.prototype.setDanmaku=function(c,d){this.on("enterframe",c.createTicker(d))};
enchant.EventTarget.prototype.removeDanmaku=function(){for(var c=[],d=this._listeners.enterframe.length;d--;)this._listeners.enterframe[d].isDanmaku&&(c[c.length]=this._listeners.enterframe[d]);for(d=c.length;d--;)this.removeEventListener("enterframe",c[d])};enchant.bulletml={};enchant.bulletml.DEFAULT_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAa0lEQVQYV2NkgIL/DAw2QGYolLuakYHhCIgNpBkYgJITGWxs8hj8/CDymzYBpY9MAkrmM4J12tgcZlizhoFBXByi4OVLBoaQEJAiW5CCiQxdXXkMpaUw2yB0dzcDQ1nZJKIU4LeCoCMJeRMAewIxn7cIaLcAAAAASUVORK5CYII=";
enchant.bulletml.DEFAULT_BULLET_FACTORY=function(){var c=new enchant.Sprite(8,8);c.image=enchant.Surface.load(enchant.bulletml.DEFAULT_IMAGE);return c};enchant.bulletml.AttackPattern=enchant.Class.create({initialize:function(c){if(!c)throw Error("argument is invalid.",c);this._bulletml=c},_getConf:function(c){c instanceof enchant.Node&&(c={target:c});var d={},e=enchant.bulletml.AttackPattern.defaultConfig,a;for(a in e)e.hasOwnProperty(a)&&(d[a]=e[a]);if(void 0!==c)for(a in c)c.hasOwnProperty(a)&&
(d[a]=c[a]);return d},createTicker:function(c,d){if(!d&&!this._bulletml.findAction("top")){for(var e=[],a=1;this._bulletml.findAction("top"+a);a++)e[e.length]=this._createTicker(c,"top"+a);for(var f=function(){if(!f.complete){for(var a=e.length;a--;)e[a].call(this);f.compChildCount==e.length&&(f.complete=!0,this.dispatchEvent(new Event("completeAttack")))}},a=e.length;a--;)e[a].parentTicker=f;f.compChildCount=0;f.completeChild=function(){this.compChildCount++};f.restart=function(){for(var a=e.length;a--;)e[a].restart();
this.compChildCount=0;this.complete=!1};f.restart();return f}return this._createTicker(c,d)},_createTicker:function(c,d){c=this._getConf(c);if(!c.target)throw Error("not set target in config.");var e=this,a=function(){this.age<a.chDirEnd?a.direction+=a.dirIncr:this.age==a.chDirEnd&&(a.direction=a.dirFin);this.age<a.chSpdEnd?a.speed+=a.spdIncr:this.age==a.chSpdEnd&&(a.speed=a.spdFin);this.age<a.aclEnd?(a.speedH+=a.aclIncrH,a.speedV+=a.aclIncrV):this.age==a.aclEnd&&(a.speedH=a.aclFinH,a.speedV=a.aclFinV);
this.x+=Math.cos(a.direction)*a.speed*c.speedRate;this.y+=Math.sin(a.direction)*a.speed*c.speedRate;this.x+=a.speedH*c.speedRate;this.y+=a.speedV*c.speedRate;c.testInWorld(this)||this.parentNode.removeChild(this);c.updateProperties&&(this.direction=180*(a.direction+Math.PI/2)/Math.PI,this.speed=a.speed);if(!(this.age<a.waitTo||a.completed)){for(var d;d=a.walker.next();)switch(d.commandName){case "fire":e._fire.call(this,d,c,a,e);break;case "wait":a.waitTo=this.age+eval(d.value);return;case "changeDirection":e._changeDirection.call(this,
d,c,a);break;case "changeSpeed":e._changeSpeed.call(this,d,a);break;case "accel":e._accel.call(this,d,a);break;case "vanish":this.parentNode&&this.parentNode.removeChild(this)}a.completed=!0;a.parentTicker?a.parentTicker.completeChild():this.dispatchEvent(new Event("completeAttack"))}};a.restart=function(){if(void 0===d)this.walker=e._bulletml.getWalker("top",c.rank);else if("string"===typeof d)this.walker=e._bulletml.getWalker(d,c.rank);else if(d instanceof BulletML.Bullet)this.walker=d.getWalker(c.rank);
else throw Error("\u5f15\u6570\u304c\u4e0d\u6b63",c,d);this.waitTo=-1;this.completed=!1;this.dirFin=this.dirIncr=this.speedV=this.speedH=this.lastSpeed=this.speed=this.lastDirection=this.direction=0;this.chDirEnd=-1;this.spdFin=this.spdIncr=0;this.chSpdEnd=-1;this.aclFinV=this.aclIncrV=this.aclFinH=this.aclIncrH=0;this.aclEnd=-1};a.restart();a.isDanmaku=!0;return a},_fire:function(c,d,e,a){var f=d.bulletFactory({label:c.bullet.label});if(f){var j=a.createTicker(d,c.bullet),k=this;j.direction=function(a){var b=
h(eval(a.value));switch(a.type){case "aim":return d.target?p(k,d.target)+b:b-Math.PI/2;case "absolute":return b-Math.PI/2;case "relative":return e.direction+b;case "sequence":return e.lastDirection+b}}(c.direction||c.bullet.direction);e.lastDirection=j.direction;j.speed=function(a){var b=eval(a.value);switch(a.type){case "relative":case "sequence":return e.lastSpeed+b;default:return b}}(c.speed||c.bullet.speed);e.lastSpeed=j.speed;f.x=this.x+((this.width||0)-(f.width||0))/2;f.y=this.y+((this.height||
0)-(f.height||0))/2;f.addEventListener("enterframe",j);f.addEventListener("removed",function(){this.removeEventListener("enterframe",j)});d.addTarget?d.addTarget.addChild(f):this.parentNode&&this.parentNode.addChild(f)}},_changeDirection:function(c,d,e){var a=eval(c.direction.value),f=eval(c.term);switch(c.direction.type){case "aim":c=d.target;if(!c)return;e.dirFin=p(this,c)+h(a);e.dirIncr=n(e.dirFin-e.direction)/f;break;case "absolute":e.dirFin=h(a)-Math.PI/2;e.dirIncr=n(e.dirFin-e.direction)/f;
break;case "relative":e.dirFin=e.direction+h(a);e.dirIncr=n(e.dirFin-e.direction)/f;break;case "sequence":e.dirIncr=h(a),e.dirFin=e.direction+e.dirIncr*f}e.chDirEnd=this.age+f},_changeSpeed:function(c,d){var e=eval(c.speed.value),a=eval(c.term);switch(c.speed.type){case "absolute":d.spdFin=e;d.spdIncr=(d.spdFin-d.speed)/a;break;case "relative":d.spdFin=e+d.speed;d.spdIncr=(d.spdFin-d.speed)/a;break;case "sequence":d.spdIncr=e,d.spdFin=d.speed+d.spdIncr*a}d.chSpdEnd=this.age+a},_accel:function(c,d){var e=
eval(c.term);d.aclEnd=this.age+e;if(c.horizontal){var a=eval(c.horizontal.value);switch(c.horizontal.type){case "absolute":case "sequence":d.aclIncrH=(a-d.speedH)/e;d.aclFinH=a;break;case "relative":d.aclIncrH=a,d.aclFinH=(a-d.speedH)*e}}else d.aclIncrH=0,d.aclFinH=d.speedH;if(c.vertical)switch(a=eval(c.vertical.value),c.vertical.type){case "absolute":case "sequence":d.aclIncrV=(a-d.speedV)/e;d.aclFinV=a;break;case "relative":d.aclIncrV=a,d.aclFinV=(a-d.speedV)*e}else d.aclIncrV=0,d.aclFinV=d.speedV},
bulletml:{get:function(){return this._bulletml}}});enchant.bulletml.AttackPattern.defaultConfig={bulletFactory:enchant.bulletml.DEFAULT_BULLET_FACTORY,testInWorld:function(c){var d=enchant.Game.instance.width,e=enchant.Game.instance.height,a=c.height||0;return-(c.width||0)<=c.x&&c.x<d&&-a<=c.y&&c.y<e},rank:0,updateProperties:!1,speedRate:2}})();
