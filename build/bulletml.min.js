/*
 bulletml.js v0.5.0-SNAPSHOT

 License
 http://daishihmr.mit-license.org/
*/
var bulletml={GLOBAL:this};
(function(){function c(b,a){for(var c=0,d=b.length;c<d;c++)if(b[c].label==a)return b[c]}bulletml.Root=function(b){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[];if(void 0!==b){for(var a in b)b.hasOwnProperty(a)&&(b[a].label=a,b[a]instanceof bulletml.Action?this.actions.push(b[a]):b[a]instanceof bulletml.Bullet?this.bullets.push(b[a]):b[a]instanceof bulletml.Fire&&this.fires.push(b[a]));b=0;for(a=this.actions.length;b<a;b++)this.actions[b].setRoot(this);b=0;for(a=this.bullets.length;b<
a;b++)this.bullets[b].setRoot(this);b=0;for(a=this.fires.length;b<a;b++)this.fires[b].setRoot(this)}};bulletml.Root.prototype.findAction=function(b){return c(this.actions,b)};bulletml.Root.prototype.getTopActionLabels=function(){for(var b=[],a=0,c=this.actions.length;a<c;a++){var d=this.actions[a];d.label&&0===d.label.indexOf("top")&&(b[b.length]=d.label)}return b};bulletml.Root.prototype.findActionOrThrow=function(b){var a;if(a=this.findAction(b))return a;throw Error("action labeled '"+b+"' is undefined.");
};bulletml.Root.prototype.findBullet=function(b){return c(this.bullets,b)};bulletml.Root.prototype.findBulletOrThrow=function(b){var a;if(a=this.findBullet(b))return a;throw Error("bullet labeled '"+b+"' is undefined.");};bulletml.Root.prototype.findFire=function(b){return c(this.fires,b)};bulletml.Root.prototype.findFireOrThrow=function(b){var a;if(a=this.findFire(b))return a;throw Error("fire labeled '"+b+"' is undefined.");};bulletml.Bullet=function(){this.root=this.label=null;this.direction=new bulletml.Direction(0);
this.speed=new bulletml.Speed(1);this.actions=[];this.option={};this._localScope={}};bulletml.Bullet.prototype.clone=function(b){var a=new bulletml.Bullet;a.label=this.label;a.root=this.root;a.actions=this.actions;a.direction=new bulletml.Direction(b._evalParam(this.direction.value));a.direction.type=this.direction.type;a.speed=new bulletml.Speed(b._evalParam(this.speed.value));a.speed.type=this.speed.type;a.option=this.option;a._localScope=b._localScope;return a};bulletml.Bullet.prototype.setRoot=
function(b){this.root=b;for(var a=0,c=this.actions.length;a<c;a++)this.actions[a].setRoot(b)};bulletml.BulletRef=function(b){this.root=null;this.label=b;this.params=[]};bulletml.BulletRef.prototype.clone=function(b){var a=b._localScope;b._localScope=b._newScope(this.params);var c=this.root.findBulletOrThrow(this.label).clone(b);b._localScope=a;return c};bulletml.BulletRef.prototype.setRoot=function(b){this.root=b};bulletml.Command=function(){this.commandName=""};bulletml.Command.prototype.setRoot=
function(b){this.root=b};bulletml.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[];this.params=[]};bulletml.Action.prototype=new bulletml.Command;bulletml.Action.prototype.setRoot=function(b){this.root=b;for(var a=0,c=this.commands.length;a<c;a++)this.commands[a].setRoot(b)};bulletml.Action.prototype.clone=function(){var b=new bulletml.Action;b.label=this.label;b.root=this.root;b.commands=this.commands;return b};bulletml.ActionRef=function(b){this.commandName=
"actionRef";this.label=b;this.root=null;this.params=[]};bulletml.ActionRef.prototype=new bulletml.Command;bulletml.ActionRef.prototype.clone=function(){var b=new bulletml.Action;b.root=this.root;b.commands.push(this);return b};bulletml.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=this.root=this.label=null;this.option=new bulletml.FireOption};bulletml.Fire.prototype=new bulletml.Command;bulletml.Fire.prototype.setRoot=function(b){this.root=b;this.bullet&&this.bullet.setRoot(b)};
bulletml.FireRef=function(b){this.commandName="fireRef";this.label=b;this.params=[]};bulletml.FireRef.prototype=new bulletml.Command;bulletml.ChangeDirection=function(){this.commandName="changeDirection";this.direction=new bulletml.Direction;this.term=0};bulletml.ChangeDirection.prototype=new bulletml.Command;bulletml.ChangeSpeed=function(){this.commandName="changeSpeed";this.speed=new bulletml.Speed;this.term=0};bulletml.ChangeSpeed.prototype=new bulletml.Command;bulletml.Accel=function(){this.commandName=
"accel";this.horizontal=new bulletml.Horizontal;this.vertical=new bulletml.Vertical;this.term=0};bulletml.Accel.prototype=new bulletml.Command;bulletml.Wait=function(b){this.commandName="wait";this.value=b||0};bulletml.Wait.prototype=new bulletml.Command;bulletml.Vanish=function(){this.commandName="vanish"};bulletml.Vanish.prototype=new bulletml.Command;bulletml.Repeat=function(){this.commandName="repeat";this.times=0;this.action=null;this.params=[]};bulletml.Repeat.prototype=new bulletml.Command;
bulletml.Repeat.prototype.setRoot=function(b){this.root=b;this.action&&this.action.setRoot(b)};bulletml.Bind=function(b,a){this.commandName="bind";this.variable=b;this.expression=a};bulletml.Bind.prototype=new bulletml.Command;bulletml.Notify=function(b,a){this.commandName="notify";this.eventName=b;this.params=a||null};bulletml.Notify.prototype=new bulletml.Command;bulletml.DummyCommand=new bulletml.Command;bulletml.Direction=function(b){this.type="aim";this.value=b||0};bulletml.Speed=function(b){this.type=
"absolute";this.value=void 0===b?1:b};bulletml.Horizontal=function(b){this.type="absolute";this.value=b||0};bulletml.Vertical=function(b){this.type="absolute";this.value=b||0};bulletml.FireOption=function(b){b=b||{};this.offsetX=b.offsetX||0;this.offsetY=b.offsetY||0;this.autonomy=!0;void 0!==b.autonomy&&(this.autonomy=!!b.autonomy)};bulletml.OffsetX=function(b){this.value=b||0};bulletml.OffsetY=function(b){this.value=b||0};bulletml.Autonomy=function(b){this.value=!!b}})();var BulletML=bulletml;(function(){bulletml.Walker=function(c){this._root=c;this._stack=[];this._cursor=-1;this._action=null;this._localScope={}};bulletml.Walker.prototype.next=function(){this._cursor+=1;if(null!==this._action){var c=this._action.commands[this._cursor];if(void 0!==c){if(c instanceof bulletml.Action)return this._pushStack(),this._action=c,this._localScope=this._cloneScope(),this.next();if(c instanceof bulletml.ActionRef)return this._pushStack(),this._action=this._root.findActionOrThrow(c.label),this._localScope=
this._newScope(c.params),this.next();if(c instanceof bulletml.Repeat)return this._localScope.loopCounter=0,this._localScope.loopEnd=this._evalParam(c.times)|0,this._pushStack(),this._action=c.action.clone(),this._localScope=this._cloneScope(),this.next();if(c instanceof bulletml.Fire){var b=new bulletml.Fire;b.bullet=c.bullet.clone(this);null!==c.direction&&(b.direction=new bulletml.Direction(this._evalParam(c.direction.value)),b.direction.type=c.direction.type);null!==c.speed&&(b.speed=new bulletml.Speed(this._evalParam(c.speed.value)),
b.speed.type=c.speed.type);b.option=new bulletml.FireOption;b.option.offsetX=this._evalParam(c.option.offsetX);b.option.offsetY=this._evalParam(c.option.offsetY);b.option.autonomy=c.option.autonomy;return b}return c instanceof bulletml.FireRef?(this._pushStack(),this._action=new bulletml.Action,this._action.commands=[this._root.findFireOrThrow(c.label)],this._localScope=this._newScope(c.params),this.next()):c instanceof bulletml.ChangeDirection?(b=new bulletml.ChangeDirection,b.direction.type=c.direction.type,
b.direction.value=this._evalParam(c.direction.value),b.term=this._evalParam(c.term),b):c instanceof bulletml.ChangeSpeed?(b=new bulletml.ChangeSpeed,b.speed.type=c.speed.type,b.speed.value=this._evalParam(c.speed.value),b.term=this._evalParam(c.term),b):c instanceof bulletml.Accel?(b=new bulletml.Accel,b.horizontal.type=c.horizontal.type,b.horizontal.value=this._evalParam(c.horizontal.value),b.vertical.type=c.vertical.type,b.vertical.value=this._evalParam(c.vertical.value),b.term=this._evalParam(c.term),
b):c instanceof bulletml.Wait?new bulletml.Wait(this._evalParam(c.value)):c instanceof bulletml.Vanish?c:c instanceof bulletml.Bind?(this._localScope["$"+c.variable]=this._evalParam(c.expression),bulletml.DummyCommand):c instanceof bulletml.Notify?c:null}this._popStack();if(null===this._action)return null;(c=this._action.commands[this._cursor])&&"repeat"==c.commandName&&(this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this._pushStack(),this._action=c.action.clone(),
this._localScope=this._cloneScope()));return this.next()}return null};bulletml.Walker.prototype._pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};bulletml.Walker.prototype._popStack=function(){var c=this._stack.pop();c?(this._cursor=c.cursor,this._action=c.action,this._localScope=c.scope):(this._cursor=-1,this._action=null,this._localScope={})};bulletml.Walker.prototype._evalParam=function(c){var b;if("boolean"===typeof c)return c?
1:0;if("number"===typeof c)return c;if(isNaN(b=Number(c))){if(b=this._localScope[c])return b;if(b=bulletml.Walker.globalScope[c])return b;if("$rand"===c)return Math.random()}else return b;b={};for(var a in bulletml.Walker.globalScope)bulletml.Walker.globalScope.hasOwnProperty(a)&&(b[a]=bulletml.Walker.globalScope[a]);for(a in this._localScope)this._localScope.hasOwnProperty(a)&&(b[a]=this._localScope[a]);b.$rand=Math.random();(a=this._stack[this._stack.length-1])&&(b.$loop={index:a.scope.loopCounter,
count:a.scope.loopCounter+1,first:0===a.scope.loopCounter,last:a.scope.loopCounter+1>=a.scope.loopEnd});return(new Function("return "+c.split("$").join("this.$"))).apply(b)};bulletml.Walker.prototype._newScope=function(c){var b={};if(c)for(var a=0,e=c.length;a<e;a++)b["$"+(a+1)]=this._evalParam(c[a]);else for(a in this._localScope)this._localScope.hasOwnProperty(a)&&(b[a]=this._localScope[a]);return b};bulletml.Walker.prototype._cloneScope=function(){var c={},b;for(b in this._localScope)this._localScope.hasOwnProperty(b)&&
(c[b]=this._localScope[b]);return c};bulletml.Root.prototype.getWalker=function(c){var b=new bulletml.Walker(this);if(c=this.findAction(c))b._action=c;return b};bulletml.Bullet.prototype.getWalker=function(){var c=new bulletml.Walker(this.root),b=new bulletml.Action;b.root=this.root;b.commands=this.actions;c._action=b;c._localScope=this._localScope;return c};bulletml.Walker.globalScope={}})();(function(){function c(a){var c=new bulletml.Root;if(a=a.getElementsByTagName("bulletml")[0]){k(a,"type",function(a){c.type=a});var l=a.getElementsByTagName("action");if(l)for(var d=0,n=l.length;d<n;d++)if(l[d].parentNode===a){var g=b(c,l[d]);g&&(c.actions[c.actions.length]=g)}if(l=a.getElementsByTagName("bullet"))for(d=0,n=l.length;d<n;d++)l[d].parentNode===a&&(g=e(c,l[d]))&&(c.bullets[c.bullets.length]=g);if(l=a.getElementsByTagName("fire"))for(d=0,n=l.length;d<n;d++)l[d].parentNode===a&&(g=f(c,
l[d]))&&(c.fires[c.fires.length]=g);return c}}function b(c,d){var e=new bulletml.Action;k(d,"label",function(a){e.label=a});p(d,".",function(d){switch(d.tagName.toLowerCase()){case "action":e.commands[e.commands.length]=b(c,d);break;case "actionref":e.commands[e.commands.length]=a(c,d);break;case "fire":e.commands[e.commands.length]=f(c,d);break;case "fireref":e.commands[e.commands.length]=h(c,d);break;case "changedirection":e.commands[e.commands.length]=q(c,d);break;case "changespeed":e.commands[e.commands.length]=
v(c,d);break;case "accel":e.commands[e.commands.length]=w(c,d);break;case "wait":var s=e.commands,g=e.commands.length,k=new bulletml.Wait;k.root=c;k.value=m(d);s[g]=k;break;case "vanish":d=e.commands;s=e.commands.length;g=new bulletml.Vanish;g.root=c;d[s]=g;break;case "repeat":e.commands[e.commands.length]=x(c,d)}});e.root=c;return e}function a(a,b){var c=new bulletml.ActionRef(k(b,"label"));p(b,/param$/,function(a){c.params[c.params.length]=m(a)});c.root=a;return c}function e(c,d){var e=new bulletml.Bullet;
k(d,"label",function(a){e.label=a});g(d,"direction",function(a){e.direction=t(a)});g(d,"speed",function(a){e.speed=u(a)});p(d,/(action)|(actionRef)$/,function(d){"action"==d.tagName.toLowerCase()?e.actions[e.actions.length]=b(c,d):"actionref"==d.tagName.toLowerCase()&&(e.actions[e.actions.length]=a(c,d))});e.root=c;return e}function d(a,b){var c=new bulletml.BulletRef(k(b,"label"));p(b,/param$/,function(a){c.params[c.params.length]=m(a)});c.root=a;return c}function f(a,b){var c=new bulletml.Fire;
k(b,"label",function(a){c.label=a});g(b,"direction",function(a){c.direction=t(a)});g(b,"speed",function(a){c.speed=u(a)});g(b,"bullet",function(b){c.bullet=e(a,b)});g(b,"bulletref",function(b){c.bullet=d(a,b)});if(!c.bullet)throw Error("fire has no bullet or bulletRef.");c.root=a;return c}function h(a,b){var c=new bulletml.FireRef(k(b,"label"));p(b,/param$/,function(a){c.params[c.params.length]=m(a)});c.root=a;return c}function q(a,b){var c=new bulletml.ChangeDirection;c.root=a;g(b,"direction",function(a){c.direction=
t(a)});g(b,"term",function(a){c.term=m(a)});return c}function v(a,b){var c=new bulletml.ChangeSpeed;c.root=a;g(b,"speed",function(a){c.speed=u(a)});g(b,"term",function(a){c.term=m(a)});return c}function w(a,b){var c=new bulletml.Accel;c.root=a;g(b,"horizontal",function(a){a=r(new bulletml.Horizontal,a);c.horizontal=a});g(b,"vertical",function(a){a=r(new bulletml.Vertical,a);c.vertical=a});g(b,"term",function(a){c.term=m(a)});return c}function x(c,d){var e=new bulletml.Repeat;g(d,"action",function(a){e.action=
b(c,a)});g(d,"actionRef",function(b){e.action=a(c,b)});g(d,"times",function(a){e.times=m(a)});e.root=c;return e}function t(a){return r(new bulletml.Direction,a)}function u(a){return r(new bulletml.Speed,a)}function r(a,b){k(b,"type",function(b){a.type=b});m(b,function(b){a.value=b});return a}function g(a,b,c,d){b=b.toLowerCase();a=a.childNodes;for(var e=0,f=a.length;e<f;e++)if(a[e].tagName&&a[e].tagName.toLowerCase()==b)return c&&c(a[e]),a[e];d&&d();return null}function p(a,b,c){a=a.childNodes;for(var e=
0,d=a.length;e<d;e++)a[e].tagName&&a[e].tagName.toLowerCase().match(b)&&c(a[e])}function k(a,b,c,e){if(a=a.attributes[b])return c&&c(a.value),a.value;e&&e();return""}function m(a,b){var c=a.textContent.trim();return void 0!==c?(b&&b(c),c):""}bulletml.buildXML=function(a){if("string"===typeof a){var b=new DOMParser;a=c(b.parseFromString(a,"application/xml"))}else if(a.getElementsByTagName("bulletml"))a=c(a);else throw Error("cannot build "+a);return a}})();(function(){bulletml.dsl=function(c){c=c||"";for(var b in bulletml.dsl)bulletml.dsl.hasOwnProperty(b)&&(bulletml.GLOBAL[c+b]=bulletml.dsl[b])};bulletml.dsl.action=function(c){if(0<arguments.length)for(var b=0,a=arguments.length;b<a;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(c instanceof Array)for(b=0,a=c.length;b<a;b++)c[b]instanceof Function&&(c[b]=c[b]());var e=new bulletml.Action;if(c instanceof Array){if(c.some(function(a){return!(a instanceof bulletml.Command)}))throw Error("argument type error.");
e.commands=c}else for(b=0,a=arguments.length;b<a;b++)if(arguments[b]instanceof bulletml.Command)e.commands[b]=arguments[b];else throw Error("argument type error.");return e};bulletml.dsl.actionRef=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("label is required.");e=new bulletml.ActionRef(c);if(b instanceof Array)e.params=b;else for(a=1;a<arguments.length;a++)e.params.push(arguments[a]);return e};bulletml.dsl.bullet=
function(c,b,a,e){for(var d=0,f=arguments.length;d<f;d++)arguments[d]instanceof Function&&(arguments[d]=arguments[d]());f=new bulletml.Bullet;for(d=0;d<arguments.length;d++)arguments[d]instanceof bulletml.Direction?f.direction=arguments[d]:arguments[d]instanceof bulletml.Speed?f.speed=arguments[d]:arguments[d]instanceof bulletml.Action?f.actions.push(arguments[d]):arguments[d]instanceof bulletml.ActionRef?f.actions.push(arguments[d]):arguments[d]instanceof Array?f.actions.push(bulletml.dsl.action(arguments[d])):
arguments[d]instanceof Object?f.option=arguments[d]:"string"===typeof arguments[d]&&(f.label=arguments[d]);return f};bulletml.dsl.bulletRef=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("label is required.");e=new bulletml.BulletRef(c);if(b instanceof Array)e.params=b;else for(a=1;a<arguments.length;a++)e.params.push(arguments[a]);return e};bulletml.dsl.fire=function(c,b,a,e){for(var d=0,f=arguments.length;d<
f;d++)arguments[d]instanceof Function&&(arguments[d]=arguments[d]());f=new bulletml.Fire;for(d=0;d<arguments.length;d++)arguments[d]instanceof bulletml.Direction?f.direction=arguments[d]:arguments[d]instanceof bulletml.Speed?f.speed=arguments[d]:arguments[d]instanceof bulletml.Bullet?f.bullet=arguments[d]:arguments[d]instanceof bulletml.BulletRef?f.bullet=arguments[d]:arguments[d]instanceof bulletml.FireOption?f.option=arguments[d]:arguments[d]instanceof bulletml.OffsetX?f.option.offsetX=arguments[d].value:
arguments[d]instanceof bulletml.OffsetY?f.option.offsetY=arguments[d].value:arguments[d]instanceof bulletml.Autonomy&&(f.option.autonomy=arguments[d].value);if(void 0===f.bullet)throw Error("bullet (or bulletRef) is required.");return f};bulletml.dsl.fireRef=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("label is required.");e=new bulletml.FireRef(c);if(b instanceof Array)e.params=b;else for(a=1;a<arguments.length;a++)e.params.push(arguments[a]);
return e};bulletml.dsl.changeDirection=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("direction is required.");if(void 0===b)throw Error("term is required.");a=new bulletml.ChangeDirection;a.direction=c instanceof bulletml.Direction?c:new bulletml.Direction(c);a.term=b;return a};bulletml.dsl.changeSpeed=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=
arguments[a]());if(void 0===c)throw Error("speed is required.");if(void 0===b)throw Error("term is required.");a=new bulletml.ChangeSpeed;a.speed=c instanceof bulletml.Speed?c:new bulletml.Speed(c);a.term=b;return a};bulletml.dsl.accel=function(c,b,a){for(var e=0,d=arguments.length;e<d;e++)arguments[e]instanceof Function&&(arguments[e]=arguments[e]());d=new bulletml.Accel;for(e=0;e<arguments.length;e++)arguments[e]instanceof bulletml.Horizontal?d.horizontal=c:arguments[e]instanceof bulletml.Vertical?
d.vertical=b:d.term=arguments[e];if(void 0===d.horizontal&&void 0===d.vertical)throw Error("horizontal or vertical is required.");if(void 0===d.term)throw Error("term is required.");return d};bulletml.dsl.wait=function(c){for(var b=0,a=arguments.length;b<a;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===c)throw Error("value is required.");return new bulletml.Wait(c)};bulletml.dsl.vanish=function(){return new bulletml.Vanish};bulletml.dsl.repeat=function(c,b){for(var a=
0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("times is required.");if(void 0===b)throw Error("action is required.");e=new bulletml.Repeat;e.times=c;if(b instanceof bulletml.Action||b instanceof bulletml.ActionRef)e.action=b;else if(b instanceof Array)e.action=bulletml.dsl.action(b);else{for(var d=[],a=1;a<arguments.length;a++)d.push(arguments[a]);e.action=bulletml.dsl.action(d)}return e};bulletml.dsl.bindVar=function(c,b){return new bulletml.Bind(c,
b)};bulletml.dsl.notify=function(c,b){return new bulletml.Notify(c,b)};bulletml.dsl.direction=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("value is required.");a=new bulletml.Direction(c);void 0!==b&&(a.type=b);return a};bulletml.dsl.speed=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("value is required.");
a=new bulletml.Speed(c);b&&(a.type=b);return a};bulletml.dsl.horizontal=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("value is required.");a=new bulletml.Horizontal(c);b&&(a.type=b);return a};bulletml.dsl.vertical=function(c,b){for(var a=0,e=arguments.length;a<e;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());if(void 0===c)throw Error("value is required.");a=new bulletml.Vertical(c);
b&&(a.type=b);return a};bulletml.dsl.fireOption=function(c){return new bulletml.FireOption(c)};bulletml.dsl.offsetX=function(c){return new bulletml.OffsetX(c)};bulletml.dsl.offsetY=function(c){return new bulletml.OffsetY(c)};bulletml.dsl.autonomy=function(c){return new bulletml.Autonomy(c)}})();(function(){bulletml.runner=bulletml.runner||{};bulletml.runner.RunnerFactory=function(a){this.root=a};bulletml.runner.RunnerFactory.prototype.create=function(a){for(var b in bulletml.runner.DEFAULT_CONFIG)bulletml.runner.DEFAULT_CONFIG.hasOwnProperty(b)&&void 0===a[b]&&(a[b]=bulletml.runner.DEFAULT_CONFIG[b]);b=this.root.getTopActionLabels();if(1===b.length)return new bulletml.runner.SubRunner(a,this.root.getWalker(b[0]));for(var c=new bulletml.runner.ParentRunner,f=0,h=b.length;f<h;f++)c.addSubRunner(new bulletml.runner.SubRunner(a,
this.root.getWalker(b[f])));return c};bulletml.Root.prototype.createRunner=function(a,b){var c=(new bulletml.runner.RunnerFactory(this)).create(a);b&&b(c);return c};bulletml.runner.DEFAULT_CONFIG={rank:0,target:null,createNewBullet:function(a,b){}};bulletml.runner.Runner=function(){this.y=this.x=0};bulletml.runner.Runner.prototype={constructor:bulletml.runner.Runner,update:function(){},onVanish:function(){},onNotify:function(a,b){}};bulletml.runner.ParentRunner=function(){bulletml.runner.Runner.call(this);
this.completed=!1;this.completedChildCount=0;this.subRunners=[]};bulletml.runner.ParentRunner.prototype=Object.create(bulletml.runner.Runner.prototype);bulletml.runner.ParentRunner.prototype.addSubRunner=function(a){a.parentRunner=this;this.subRunners.push(a)};bulletml.runner.ParentRunner.prototype.update=function(){for(var a=this.subRunners.length;a--;)this.subRunners[a].update();this.completedChildCount===this.subRunners.length&&(this.completed=!0)};bulletml.runner.SimpleSubRunner=function(a){bulletml.runner.Runner.call(this);
this.config=a;this.speed=this.direction=0;this.deltaY=this.deltaX=null};bulletml.runner.SimpleSubRunner.prototype=Object.create(bulletml.runner.Runner.prototype);bulletml.runner.SimpleSubRunner.prototype.update=function(){null===this.deltaX&&(this.deltaX=Math.cos(this.direction)*this.speed);null===this.deltaY&&(this.deltaY=Math.sin(this.direction)*this.speed);this.x+=this.deltaX;this.y+=this.deltaY};bulletml.runner.SubRunner=function(a,b){bulletml.runner.SimpleSubRunner.call(this,a);this.walker=b;
this.waitTo=-1;this.dirFin=this.dirIncr=this.speedV=this.speedH=this.lastSpeed=this.lastDirection=0;this.chDirEnd=-1;this.spdFin=this.spdIncr=0;this.chSpdEnd=-1;this.aclFinV=this.aclIncrV=this.aclFinH=this.aclIncrH=0;this.age=this.aclEnd=-1;this.stop=!1;this.parentRunner=null};bulletml.runner.SubRunner.prototype=Object.create(bulletml.runner.SimpleSubRunner.prototype);bulletml.runner.SubRunner.prototype.update=function(){if(!(this.stop||(this.age+=1,this.age<this.chDirEnd?this.direction+=this.dirIncr:
this.age===this.chDirEnd&&(this.direction=this.dirFin),this.age<this.chSpdEnd?this.speed+=this.spdIncr:this.age===this.chSpdEnd&&(this.speed=this.spdFin),this.age<this.aclEnd?(this.speedH+=this.aclIncrH,this.speedV+=this.aclIncrV):this.age===this.aclEnd&&(this.speedH=this.aclFinH,this.speedV=this.aclFinV),this.x+=Math.cos(this.direction)*this.speed,this.y+=Math.sin(this.direction)*this.speed,this.x+=this.speedH,this.y+=this.speedV,this.age<this.waitTo||this.completed))){for(var a;a=this.walker.next();)switch(a.commandName){case "fire":this.fire(a);
break;case "wait":this.waitTo=this.age+a.value;return;case "changeDirection":this.changeDirection(a);break;case "changeSpeed":this.changeSpeed(a);break;case "accel":this.accel(a);break;case "vanish":this.onVanish();break;case "notify":this.notify(a)}this.completed=!0;null!==this.parentRunner&&(this.parentRunner.completedChildCount+=1)}};bulletml.runner.SubRunner.prototype.fire=function(a){var c;c=0===a.bullet.actions.length?new bulletml.runner.SimpleSubRunner(this.config):new bulletml.runner.SubRunner(this.config,
a.bullet.getWalker());var d={x:this.x+a.option.offsetX,y:this.y+a.option.offsetY},f=a.direction||a.bullet.direction,h=f.value*Math.PI/180;switch(f.type){case "aim":c.direction=this.config.target?a.option.autonomy?b(d,this.config.target)+h:b(this,this.config.target)+h:h-Math.PI/2;break;case "absolute":c.direction=h-Math.PI/2;break;case "relative":c.direction=this.direction+h;break;default:c.direction=this.lastDirection+h}this.lastDirection=c.direction;f=a.speed||a.bullet.speed;h=f.value;switch(f.type){case "relative":c.speed=
this.speed+h;break;case "sequence":c.speed=this.lastSpeed+h;break;default:c.speed=h}this.lastSpeed=c.speed;c.x=d.x;c.y=d.y;var d={},q;for(q in a.bullet.option)d[q]=a.bullet.option[q];d.label=a.bullet.label;this.config.createNewBullet(c,d)};bulletml.runner.SubRunner.prototype.changeDirection=function(a){var e=a.direction.value*Math.PI/180,d=a.term;switch(a.direction.type){case "aim":this.dirFin=b(this,this.config.target)+e;this.dirIncr=c(this.dirFin-this.direction)/d;break;case "absolute":this.dirFin=
e-Math.PI/2;this.dirIncr=c(this.dirFin-this.direction)/d;break;case "relative":this.dirFin=this.direction+e;this.dirIncr=c(this.dirFin-this.direction)/d;break;case "sequence":this.dirIncr=e,this.dirFin=this.direction+this.dirIncr*(d-1)}this.chDirEnd=this.age+d};bulletml.runner.SubRunner.prototype.changeSpeed=function(a){var b=a.speed.value,c=a.term;switch(a.speed.type){case "absolute":this.spdFin=b;this.spdIncr=(this.spdFin-this.speed)/c;break;case "relative":this.spdFin=b+this.speed;this.spdIncr=
(this.spdFin-this.speed)/c;break;case "sequence":this.spdIncr=b,this.spdFin=this.speed+this.spdIncr*c}this.chSpdEnd=this.age+c};bulletml.runner.SubRunner.prototype.accel=function(a){var b=a.term;this.aclEnd=this.age+b;if(a.horizontal){var c=a.horizontal.value;switch(a.horizontal.type){case "absolute":case "sequence":this.aclIncrH=(c-this.speedH)/b;this.aclFinH=c;break;case "relative":this.aclIncrH=c,this.aclFinH=(c-this.speedH)*b}}else this.aclIncrH=0,this.aclFinH=this.speedH;if(a.vertical)switch(c=
a.vertical.value,a.vertical.type){case "absolute":case "sequence":this.aclIncrV=(c-this.speedV)/b;this.aclFinV=c;break;case "relative":this.aclIncrV=c,this.aclFinV=(c-this.speedV)*b}else this.aclIncrV=0,this.aclFinV=this.speedV};bulletml.runner.SubRunner.prototype.notify=function(a){this.onNotify(a.eventName,a.params)};var c=function(a){for(;a<=-Math.PI;)a+=2*Math.PI;for(;Math.PI<a;)a-=2*Math.PI;return a},b=function(a,b){return Math.atan2(b.y-a.y,b.x-a.x)}})();
